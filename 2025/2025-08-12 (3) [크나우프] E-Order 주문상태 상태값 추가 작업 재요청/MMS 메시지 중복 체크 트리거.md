# MMS Î©îÏãúÏßÄ Ï§ëÎ≥µ Ï≤¥ÌÅ¨ Ìä∏Î¶¨Í±∞

## üìã ÌîÑÎ°úÏ†ùÌä∏ Í∞úÏöî

* **Ìä∏Î¶¨Í±∞Î™Ö**: `TRG_MMS_MSG_DUP_CHECK`
* **ÌÖåÏä§Ìä∏ ÏÑúÎ≤Ñ**: `Í∞úÎ∞ú(KR-EOD-DEV)ÏÑúÎ≤Ñ`
* **ÎåÄÏÉÅ ÌÖåÏù¥Î∏î**: `dbo.MMS_MSG`
* **Î™©Ï†Å**: SMS Î©îÏãúÏßÄ Î∞úÏÜ° Ïãú ÎèôÏùºÌïú Ï†ÑÌôîÎ≤àÌò∏+Ïò§ÎçîÎ≤àÌò∏ Ï°∞Ìï©Ïùò Ï§ëÎ≥µ Î∞úÏÜ° Î∞©ÏßÄ

---

## üéØ Ï£ºÏöî Í∏∞Îä•

### 1. Ïò§ÎçîÎ≤àÌò∏ ÏûêÎèô Ï∂îÏ∂ú
- **ÎåÄÏÉÅ Î©îÏãúÏßÄ**: 'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', 'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò'
- **Ï∂îÏ∂ú Î°úÏßÅ**: PATINDEX Í∏∞Î∞ò Î≤îÏö© ÌååÏã± (ÏΩúÎ°†/Í≥µÎ∞±/Í∞úÌñâ Î¨¥Í¥Ä)
- **Ï∂îÏ∂ú Ìå®ÌÑ¥**:
  - `Ïò§ÎçîÎ≤àÌò∏ 123456` ‚Üí `123456`
  - `Ïò§ÎçîÎ≤àÌò∏: 789012` ‚Üí `789012`
  - `- Ïò§ÎçîÎ≤àÌò∏: 400096386 -` ‚Üí `400096386`

### 2. Ï§ëÎ≥µ Í≤ÄÏÇ¨ Î≤îÏúÑ
- **MMS_MSG ÌÖåÏù¥Î∏î**: ÏûêÍ∏∞ ÏûêÏã† Ï†úÏô∏Ìïú Í∏∞Ï°¥ Î©îÏãúÏßÄ
- **ÌòÑÏû¨Ïõî Î°úÍ∑∏**: `MMS_LOG_YYYYMM` (Ïòà: MMS_LOG_202508)
- **Ïù¥Ï†ÑÏõî Î°úÍ∑∏**: `MMS_LOG_YYYYMM` (Ïòà: MMS_LOG_202507)

### 3. Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©Ïãù
- **Ï§ëÎ≥µ Î∞úÍ≤¨ Ïãú**: STATUS = '3' (Ï§ëÎ≥µ ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω)
- **Ï§ëÎ≥µ ÏóÜÏùå**: STATUS = '1' (Ï†ïÏÉÅ ÏÉÅÌÉú Ïú†ÏßÄ)

---

## üíª ÏôÑÏÑ±Îêú Ìä∏Î¶¨Í±∞ ÏÜåÏä§ÏΩîÎìú

```sql
-- ===========================================================================================
-- Ìä∏Î¶¨Í±∞Î™Ö : TRG_MMS_MSG_DUP_CHECK (Î≤îÏö© ÌååÏã± + v1.1 Ìè¨Îß∑)
-- ÎåÄÏÉÅ ÌÖåÏù¥Î∏î : dbo.MMS_MSG
-- ÎèôÏûë :
--   - INSERTÎêú MSGÏóêÏÑú 'Ïò§ÎçîÎ≤àÌò∏' Îí§Ïùò Ïà´Ïûê ÌÜ†ÌÅ∞ Ï∂îÏ∂ú(PATINDEX Í∏∞Î∞ò, ÏΩúÎ°†/Í≥µÎ∞±/Í∞úÌñâ/ÌïòÏù¥Ìîà Î¨¥Í¥Ä)
--   - PHONE + ORDER_NO Í∏∞Ï§ÄÏúºÎ°ú MMS_MSG(ÏûêÍ∏∞ ÏûêÏã† Ï†úÏô∏), MMS_LOG_ÌòÑÏû¨Ïõî/Ïù¥Ï†ÑÏõîÏóê Ï°¥Ïû¨ÌïòÎ©¥ STATUS='3'
-- Ï†úÌïú :
--   - Ïä§ÌÇ§Îßà/Ï†ÑÏÜ° Ìè¨Îß∑/Ïù∏Îç±Ïä§ Î≥ÄÍ≤Ω ÏóÜÏùå
--   - SUBJECTÎäî Îëê Ïú†ÌòïÎßå Ï≤òÎ¶¨
-- ===========================================================================================

-- Í∏∞Ï°¥ Ìä∏Î¶¨Í±∞ ÏÇ≠Ï†ú
IF EXISTS (SELECT * FROM sys.triggers WHERE name = 'TRG_MMS_MSG_DUP_CHECK')
    DROP TRIGGER dbo.TRG_MMS_MSG_DUP_CHECK
GO

-- ÏÉà Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±
CREATE TRIGGER dbo.TRG_MMS_MSG_DUP_CHECK
ON dbo.MMS_MSG
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON

    BEGIN TRY
        /* [1] inserted ‚Üí #ins (ÎåÄÏÉÅ SUBJECTÎßå) */
        IF OBJECT_ID('tempdb..#ins', 'U') IS NOT NULL
        BEGIN
            DROP TABLE #ins
        END

        SELECT
               I.MSGKEY, I.PHONE, I.SUBJECT, I.MSG
          INTO #ins
          FROM inserted AS I
         WHERE I.SUBJECT IN ( N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥' , N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò' )

        IF @@ROWCOUNT = 0
            RETURN

        /* [2] inserted ÌååÏã± ‚Üí #ins_norm (Ïò§ÎçîÎ≤àÌò∏ Î≤îÏö© Ï∂îÏ∂ú) */
        IF OBJECT_ID('tempdb..#ins_norm', 'U') IS NOT NULL
        BEGIN
            DROP TABLE #ins_norm
        END

        SELECT
               X.MSGKEY
             , X.PHONE
             , X.SUBJECT
             , X.MSG
             , CASE
                   WHEN P.pos > 0 AND D.dstart > 0
                        THEN SUBSTRING(
                                         T.tail
                                       , D.dstart
                                       , CASE
                                             WHEN ND.nextNonDigitPos = 0 THEN 50
                                             ELSE ND.nextNonDigitPos - 1
                                         END
                                      )
                   ELSE NULL
               END AS ORDER_NO
          INTO #ins_norm
          FROM #ins AS X
         CROSS APPLY ( SELECT CHARINDEX(N'Ïò§ÎçîÎ≤àÌò∏', X.MSG) AS pos ) AS P
         CROSS APPLY ( SELECT CASE WHEN P.pos > 0 THEN SUBSTRING(X.MSG, P.pos + LEN(N'Ïò§ÎçîÎ≤àÌò∏'), 300) ELSE N'' END AS tail ) AS T
         CROSS APPLY ( SELECT PATINDEX(N'%[0-9]%', T.tail) AS dstart ) AS D
         CROSS APPLY ( SELECT PATINDEX(N'%[^0-9]%', SUBSTRING(T.tail, D.dstart, 50)) AS nextNonDigitPos ) AS ND

        IF NOT EXISTS ( SELECT 1 FROM #ins_norm WHERE ORDER_NO IS NOT NULL AND LEN(ORDER_NO) > 0 )
            RETURN

        /* [3] Î°úÍ∑∏ ÌÖåÏù¥Î∏î Î™Ö Ï§ÄÎπÑ(DECLARE ÌõÑ SETÎ°ú Ï¥àÍ∏∞Ìôî) */
        DECLARE
              @CURR_YM   VARCHAR(6)
            , @PREV_YM   VARCHAR(6)
            , @CURR_RAW  NVARCHAR(128)
            , @PREV_RAW  NVARCHAR(128)
            , @CURR_Q    NVARCHAR(300)
            , @PREV_Q    NVARCHAR(300)
            , @SQL       NVARCHAR(MAX)

        SET @CURR_YM  = CONVERT(VARCHAR(6), GETDATE(), 112)
        SET @PREV_YM  = CONVERT(VARCHAR(6), DATEADD(MONTH, -1, GETDATE()), 112)

        SET @CURR_RAW = N'MMS_LOG_' + @CURR_YM
        SET @PREV_RAW = N'MMS_LOG_' + @PREV_YM

        SET @CURR_Q   = QUOTENAME(N'dbo') + N'.' + QUOTENAME(N'MMS_LOG_' + @CURR_YM)
        SET @PREV_Q   = QUOTENAME(N'dbo') + N'.' + QUOTENAME(N'MMS_LOG_' + @PREV_YM)

        /* [4] MMS_MSG Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (ÏûêÍ∏∞ ÏûêÏã† Ï†úÏô∏) */
        UPDATE M
           SET STATUS = N'3'
          FROM dbo.MMS_MSG AS M
          JOIN #ins_norm   AS I
            ON M.MSGKEY = I.MSGKEY
         WHERE I.ORDER_NO IS NOT NULL
           AND LEN(I.ORDER_NO) > 0
           AND EXISTS (
                         SELECT
                                1
                           FROM dbo.MMS_MSG AS MM
                          CROSS APPLY ( SELECT CHARINDEX(N'Ïò§ÎçîÎ≤àÌò∏', MM.MSG) AS pos ) AS P
                          CROSS APPLY ( SELECT CASE WHEN P.pos > 0 THEN SUBSTRING(MM.MSG, P.pos + LEN(N'Ïò§ÎçîÎ≤àÌò∏'), 300) ELSE N'' END AS tail ) AS T
                          CROSS APPLY ( SELECT PATINDEX(N'%[0-9]%', T.tail) AS dstart ) AS D
                          CROSS APPLY ( SELECT PATINDEX(N'%[^0-9]%', SUBSTRING(T.tail, D.dstart, 50)) AS nextNonDigitPos ) AS ND
                          CROSS APPLY (
                                         SELECT CASE
                                                    WHEN P.pos > 0 AND D.dstart > 0
                                                         THEN SUBSTRING(
                                                                          T.tail
                                                                        , D.dstart
                                                                        , CASE
                                                                              WHEN ND.nextNonDigitPos = 0 THEN 50
                                                                              ELSE ND.nextNonDigitPos - 1
                                                                          END
                                                                       )
                                                    ELSE NULL
                                                END AS ORDER_NO
                                      ) AS O
                          WHERE MM.PHONE    = I.PHONE
                            AND MM.MSGKEY  <> I.MSGKEY
                            AND MM.SUBJECT IN ( N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥' , N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò' )
                            AND O.ORDER_NO  = I.ORDER_NO
                      )

        /* [5] ÌòÑÏû¨Ïõî Î°úÍ∑∏ Í≤ÄÏÇ¨ */
        IF OBJECT_ID(@CURR_RAW, N'U') IS NOT NULL
        BEGIN
            SET @SQL = N'
                          UPDATE M
                             SET STATUS = N''3''
                            FROM dbo.MMS_MSG AS M
                                 JOIN #ins_norm   AS I
                                   ON M.MSGKEY = I.MSGKEY
                           WHERE I.ORDER_NO IS NOT NULL
                             AND LEN(I.ORDER_NO) > 0
                             AND EXISTS (
                                           SELECT 1
                                             FROM ' + @CURR_Q + N' AS L
                                            CROSS APPLY ( SELECT CHARINDEX(N''Ïò§ÎçîÎ≤àÌò∏'', L.MSG) AS pos ) AS P
                                            CROSS APPLY (
                                                           SELECT CASE
                                                                      WHEN P.pos > 0 THEN SUBSTRING(L.MSG, P.pos + LEN(N''Ïò§ÎçîÎ≤àÌò∏''), 300)
                                                                      ELSE N''''
                                                                  END AS tail
                                                        ) AS T
                                            CROSS APPLY ( SELECT PATINDEX(N''%[0-9]%'', T.tail) AS dstart ) AS D
                                            CROSS APPLY ( SELECT PATINDEX(N''%[^0-9]%'', SUBSTRING(T.tail, D.dstart, 50)) AS nextNonDigitPos ) AS ND
                                            CROSS APPLY (
                                                           SELECT CASE
                                                                      WHEN P.pos > 0 AND D.dstart > 0
                                                                           THEN SUBSTRING(
                                                                                    T.tail
                                                                                  , D.dstart
                                                                                  , CASE
                                                                                        WHEN ND.nextNonDigitPos = 0 THEN 50
                                                                                        ELSE ND.nextNonDigitPos - 1
                                                                                    END
                                                                                )
                                                                      ELSE NULL
                                                                  END AS ORDER_NO
                                                        ) AS O
                                            WHERE L.PHONE    = I.PHONE
                                              AND L.SUBJECT IN ( N''ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥'', N''ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò'' )
                                              AND O.ORDER_NO  = I.ORDER_NO
                                        )'
            EXEC sys.sp_executesql @SQL
        END

        /* [6] Ïù¥Ï†ÑÏõî Î°úÍ∑∏ Í≤ÄÏÇ¨ */
        IF OBJECT_ID(@PREV_RAW, N'U') IS NOT NULL
        BEGIN
            SET @SQL = N'
                          UPDATE M
                             SET STATUS = N''3''
                            FROM dbo.MMS_MSG AS M
                                 JOIN #ins_norm   AS I
                                   ON M.MSGKEY = I.MSGKEY
                           WHERE I.ORDER_NO IS NOT NULL
                             AND LEN(I.ORDER_NO) > 0
                             AND EXISTS (
                                           SELECT 1
                                             FROM ' + @PREV_Q + N' AS L
                                            CROSS APPLY ( SELECT CHARINDEX(N''Ïò§ÎçîÎ≤àÌò∏'', L.MSG) AS pos ) AS P
                                            CROSS APPLY (
                                                           SELECT CASE
                                                                      WHEN P.pos > 0 THEN SUBSTRING(L.MSG, P.pos + LEN(N''Ïò§ÎçîÎ≤àÌò∏''), 300)
                                                                      ELSE N''''
                                                                  END AS tail
                                                        ) AS T
                                            CROSS APPLY ( SELECT PATINDEX(N''%[0-9]%'', T.tail) AS dstart ) AS D
                                            CROSS APPLY ( SELECT PATINDEX(N''%[^0-9]%'', SUBSTRING(T.tail, D.dstart, 50)) AS nextNonDigitPos ) AS ND
                                            CROSS APPLY (
                                                            SELECT CASE
                                                                       WHEN P.pos > 0 AND D.dstart > 0
                                                                            THEN SUBSTRING(
                                                                                             T.tail
                                                                                           , D.dstart
                                                                                           , CASE
                                                                                                 WHEN ND.nextNonDigitPos = 0 THEN 50
                                                                                                 ELSE ND.nextNonDigitPos - 1
                                                                                             END
                                                                                          )
                                                                       ELSE NULL
                                                                   END AS ORDER_NO
                                                        ) AS O
                                            WHERE L.PHONE    = I.PHONE
                                              AND L.SUBJECT IN ( N''ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥'' , N''ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò'' )
                                              AND O.ORDER_NO  = I.ORDER_NO
                                        )'
            EXEC sys.sp_executesql @SQL
        END
    END TRY
    BEGIN CATCH
        RETURN
    END CATCH
END
GO
```

---

## üß™ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§

### ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω ÏÑ§Ï†ï
```sql
-- ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (Í∏∞Î≥∏ Ï§ëÎ≥µ Ï≤¥ÌÅ¨Ïö© Îç∞Ïù¥ÌÑ∞)
INSERT INTO MMS_MSG (MSGKEY, PHONE, SUBJECT, MSG, STATUS, REQDATE)
VALUES
    (10001, '010-1234-5678', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', N'ÏïàÎÖïÌïòÏÑ∏Ïöî. Ïò§ÎçîÎ≤àÌò∏ 123456 Î≥¥Î•ò ÏïàÎÇ¥ÎìúÎ¶ΩÎãàÎã§.', '1', GETDATE()),
    (10002, '010-9876-5432', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò', N'Ïò§ÎçîÏ†ëÏàò: Ïò§ÎçîÎ≤àÌò∏789012 Ï≤òÎ¶¨ÏôÑÎ£å', '1', GETDATE()),
    (10003, '010-1111-2222', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', N'Ïò§ÎçîÎ≤àÌò∏: 555999Î≤à ÏßÄÏó∞ÏïàÎÇ¥', '1', GETDATE())

-- Î°úÍ∑∏ ÌÖåÏù¥Î∏î ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂§)
-- ÌòÑÏû¨Ïõî: MMS_LOG_202508
INSERT INTO MMS_LOG_202508 (MSGKEY, PHONE, SUBJECT, MSG, STATUS, REQDATE, CALLBACK)
VALUES
    (99001, '010-5555-6666', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', N'[ÌÖåÏä§Ìä∏] - Ïò§ÎçîÎ≤àÌò∏: 333777 - Î≥¥Î•òÏ≤òÎ¶¨', '1', GETDATE(), 'Y'),
    (99002, '010-7777-8888', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò', N'[ÌÖåÏä§Ìä∏] - Ïò§ÎçîÎ≤àÌò∏: 111222 - Ï†ëÏàòÏôÑÎ£å', '1', GETDATE(), 'Y')

-- Ïù¥Ï†ÑÏõî: MMS_LOG_202507
INSERT INTO MMS_LOG_202507 (MSGKEY, PHONE, SUBJECT, MSG, STATUS, REQDATE, CALLBACK)
VALUES
    (99003, '010-9999-0000', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', N'[ÌÖåÏä§Ìä∏] - Ïò§ÎçîÎ≤àÌò∏: 444888 - Ïù¥Ï†ÑÏõîÏ≤òÎ¶¨', '1', DATEADD(MONTH, -1, GETDATE()), 'Y'),
    (99004, '010-8888-7777', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò', N'[ÌÖåÏä§Ìä∏] - Ïò§ÎçîÎ≤àÌò∏: 666999 - ÏôÑÎ£å', '1', DATEADD(MONTH, -1, GETDATE()), 'Y')
```

### ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§ Î∞è Í≤∞Í≥º

| ÌÖåÏä§Ìä∏ | ÏãúÎÇòÎ¶¨Ïò§ | ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ | ÏòàÏÉÅ Í≤∞Í≥º | Ïã§Ï†ú Í≤∞Í≥º |
|--------|----------|-------------|-----------|-----------|
| **Test 1** | Ï§ëÎ≥µ ÏóÜÎäî ÏÉà Îç∞Ïù¥ÌÑ∞ | PHONE: 010-0000-1111<br/>Ïò§ÎçîÎ≤àÌò∏: 999888 | STATUS = 1 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 2** | MMS_MSG ÎÇ¥ Ï§ëÎ≥µ | PHONE: 010-1234-5678<br/>Ïò§ÎçîÎ≤àÌò∏: 123456 | STATUS = 3 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 3** | ÌòÑÏû¨Ïõî Î°úÍ∑∏ Ï§ëÎ≥µ | PHONE: 010-5555-6666<br/>Ïò§ÎçîÎ≤àÌò∏: 333777 | STATUS = 3 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 4** | Ïù¥Ï†ÑÏõî Î°úÍ∑∏ Ï§ëÎ≥µ | PHONE: 010-9999-0000<br/>Ïò§ÎçîÎ≤àÌò∏: 444888 | STATUS = 3 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 5** | Ïò§ÎçîÏ†ëÏàò ÌÉÄÏûÖ Ï§ëÎ≥µ | PHONE: 010-9876-5432<br/>Ïò§ÎçîÎ≤àÌò∏: 789012 | STATUS = 3 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 6** | Ïò§ÎçîÎ≤àÌò∏ ÏóÜÎäî Î©îÏãúÏßÄ | MSG: "ÏùºÎ∞ò ÏïàÎÇ¥ Î©îÏãúÏßÄ" | STATUS = 1 | ‚úÖ **ÏÑ±Í≥µ** |
| **Test 7** | Îã§Î•∏ Ï†úÎ™© (ÎåÄÏÉÅ Ïô∏) | SUBJECT: "ÏùºÎ∞ò ÏïàÎÇ¥" | STATUS = 1 | ‚úÖ **ÏÑ±Í≥µ** |

**üéØ ÏµúÏ¢Ö ÌÖåÏä§Ìä∏ ÏÑ±Í≥µÎ•†: 100% (7/7)**

---

## ‚ö° Ï£ºÏöî Í∏∞Ïà†Ï†Å ÌäπÏßï

### 1. PATINDEX Í∏∞Î∞ò Î≤îÏö© ÌååÏã±
```sql
-- Í∏∞Ï°¥ Î∞©Ïãù: Íµ¨Î∂ÑÏûêÎ≥Ñ Í∞úÎ≥Ñ Ï≤òÎ¶¨
CASE
    WHEN CHARINDEX(CHAR(13), MSG) > 0 THEN ...
    WHEN CHARINDEX(CHAR(10), MSG) > 0 THEN ...
    WHEN CHARINDEX('-', MSG) > 0 THEN ...
END

-- Í∞úÏÑ†Îêú Î∞©Ïãù: Ïà´Ïûê Ìå®ÌÑ¥ ÏßÅÏ†ë Ïù∏Ïãù
PATINDEX('%[0-9]%', tail)  -- Ï≤´ Î≤àÏß∏ Ïà´Ïûê ÏúÑÏπò
PATINDEX('%[^0-9]%', substring)  -- Ïà´ÏûêÍ∞Ä ÏïÑÎãå Î¨∏Ïûê ÏúÑÏπò
```

### 2. CROSS APPLY ÏµúÏ†ÅÌôî
- **Ïû•Ï†ê**: Îã®Í≥ÑÎ≥Ñ Í≥ÑÏÇ∞ Í≤∞Í≥ºÎ•º Î™ÖÌôïÌûà Î∂ÑÎ¶¨
- **ÏÑ±Îä•**: Î≥µÏû°Ìïú Ï§ëÏ≤© Ìï®Ïàò ÎåÄÏã† Îã®Í≥ÑÎ≥Ñ Ï≤òÎ¶¨
- **Í∞ÄÎèÖÏÑ±**: Í∞Å Îã®Í≥ÑÎ≥Ñ Í≤∞Í≥ºÎ•º Î™ÖÌôïÌûà ÌôïÏù∏ Í∞ÄÎä•

### 3. ÎèôÏ†Å SQL Î≥¥Ïïà
```sql
-- SQL Ïù∏Ï†ùÏÖò Î∞©ÏßÄ
SET @CURR_Q = QUOTENAME(N'dbo') + N'.' + QUOTENAME(N'MMS_LOG_' + @CURR_YM)
-- Í≤∞Í≥º: [dbo].[MMS_LOG_202508]
```

---

## üõ°Ô∏è ÏïàÏ†ÑÏÑ± Î∞è Ìò∏ÌôòÏÑ±

### Ìò∏ÌôòÏÑ±
- ‚úÖ **SQL Server 2008+** Î™®Îì† Î≤ÑÏ†Ñ ÏßÄÏõê
- ‚úÖ **Í∏∞Ï°¥ Ïä§ÌÇ§Îßà Î¨¥Î≥ÄÍ≤Ω** (ÌÖåÏù¥Î∏î Íµ¨Ï°∞ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ)
- ‚úÖ **ÏÑ∏ÎØ∏ÏΩúÎ°† ÌååÏã± Î¨∏Ï†ú** Ìï¥Í≤∞ (Íµ¨ Î≤ÑÏ†Ñ Ìò∏Ìôò)

### ÏïàÏ†ÑÏÑ±
- ‚úÖ **TRY-CATCH Î∏îÎ°ù**: Ïò§Î•ò Î∞úÏÉù Ïãú ÏïàÏ†ÑÌïú Ï¢ÖÎ£å
- ‚úÖ **ÏûÑÏãú ÌÖåÏù¥Î∏î Ï†ïÎ¶¨**: Î©îÎ™®Î¶¨ ÎàÑÏàò Î∞©ÏßÄ
- ‚úÖ **NULL Ï≤¥ÌÅ¨**: Ïò§ÎçîÎ≤àÌò∏ Ï∂îÏ∂ú Ïã§Ìå® Ïãú ÏïàÏ†Ñ Ï≤òÎ¶¨

### ÏÑ±Îä•
- ‚úÖ **Ï°∞Í∏∞ Ï¢ÖÎ£å**: ÎåÄÏÉÅ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Ï¶âÏãú RETURN
- ‚úÖ **Ïù∏Îç±Ïä§ ÌôúÏö©**: MSGKEY Í∏∞Î∞ò JOIN ÏÇ¨Ïö©
- ‚úÖ **ÎèôÏ†Å SQL ÏµúÏÜåÌôî**: ÌïÑÏöîÏãúÏóêÎßå Ïã§Ìñâ

---

## üìà Ïö¥ÏòÅ Ìö®Í≥º

### Í∏∞ÎåÄ Ìö®Í≥º
1. **Ï§ëÎ≥µ Î∞úÏÜ° Î∞©ÏßÄ**: ÎèôÏùº Ïò§ÎçîÎ≤àÌò∏Ïùò Ï§ëÎ≥µ SMS Î∞úÏÜ° Ï∞®Îã®
2. **Í≥†Í∞ù ÎßåÏ°±ÎèÑ Ìñ•ÏÉÅ**: Î∂àÌïÑÏöîÌïú Ï§ëÎ≥µ Î©îÏãúÏßÄÎ°ú Ïù∏Ìïú Í≥†Í∞ù Î∂àÌé∏ Ìï¥ÏÜå
3. **Î∞úÏÜ° ÎπÑÏö© Ï†àÏïΩ**: Ï§ëÎ≥µ Î∞úÏÜ°ÏúºÎ°ú Ïù∏Ìïú SMS ÏöîÍ∏à Ï†àÏïΩ
4. **ÏãúÏä§ÌÖú ÏïàÏ†ïÏÑ±**: ÏûêÎèôÌôîÎêú Ï§ëÎ≥µ Ï≤¥ÌÅ¨Î°ú Ïö¥ÏòÅ Ìö®Ïú®ÏÑ± Ï¶ùÎåÄ

### Î™®ÎãàÌÑ∞ÎßÅ Î∞©Î≤ï
```sql
-- Ï§ëÎ≥µ Ï≤òÎ¶¨ ÌòÑÌô© Ï°∞Ìöå
SELECT
    COUNT(*) AS Ï¥ùÎ∞úÏÜ°Í±¥Ïàò,
    SUM(CASE WHEN STATUS = '3' THEN 1 ELSE 0 END) AS Ï§ëÎ≥µÏ≤òÎ¶¨Í±¥Ïàò,
    CAST(SUM(CASE WHEN STATUS = '3' THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS DECIMAL(5,2)) AS Ï§ëÎ≥µÎπÑÏú®
FROM MMS_MSG
WHERE SUBJECT IN (N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Î≥¥Î•òÏò§Îçî ÏïàÎÇ¥', N'ÌÅ¨ÎÇòÏö∞ÌîÑÏÑùÍ≥†Î≥¥Îìú_Ïò§ÎçîÏ†ëÏàò')
  AND REQDATE >= DATEADD(DAY, -1, GETDATE())
```

---

## üîß Ïú†ÏßÄÎ≥¥Ïàò Í∞ÄÏù¥Îìú

### Ï†ïÍ∏∞ Ï†êÍ≤Ä Ìï≠Î™©
1. **ÏõîÎ≥Ñ Î°úÍ∑∏ ÌÖåÏù¥Î∏î ÏÉùÏÑ±**: ÏÉà Îã¨ ÏãúÏûë Ïãú `MMS_LOG_YYYYMM` ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÌôïÏù∏
2. **Ìä∏Î¶¨Í±∞ ÌôúÏÑ±Ìôî ÏÉÅÌÉú**: `SELECT name, is_disabled FROM sys.triggers WHERE name = 'TRG_MMS_MSG_DUP_CHECK'`
3. **ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ**: ÎåÄÎüâ INSERT Ïãú Ï≤òÎ¶¨ ÏãúÍ∞Ñ Î™®ÎãàÌÑ∞ÎßÅ

### Î¨∏Ï†ú Ìï¥Í≤∞
```sql
-- Ìä∏Î¶¨Í±∞ ÎπÑÌôúÏÑ±Ìôî (Í∏¥Í∏âÏãú)
DISABLE TRIGGER TRG_MMS_MSG_DUP_CHECK ON MMS_MSG

-- Ìä∏Î¶¨Í±∞ Ïû¨ÌôúÏÑ±Ìôî
ENABLE TRIGGER TRG_MMS_MSG_DUP_CHECK ON MMS_MSG

-- ÏàòÎèô Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (Ìä∏Î¶¨Í±∞ Ïö∞Ìöå)
UPDATE MMS_MSG SET STATUS = '3'
WHERE MSGKEY IN (SELECT Ï§ëÎ≥µÎêú_MSGKEY FROM ÏàòÎèôÏ°∞ÌöåÍ≤∞Í≥º)
```

---

