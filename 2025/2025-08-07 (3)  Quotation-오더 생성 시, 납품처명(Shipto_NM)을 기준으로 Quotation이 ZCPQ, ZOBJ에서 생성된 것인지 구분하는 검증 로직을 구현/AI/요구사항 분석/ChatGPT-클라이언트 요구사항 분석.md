# 아래 내용의 비지니스 로직을 정리해서 알려줘.

**개발 목적**
오더 생성 시, 납품처명(Shipto_NM)을 기준으로 Quotation이 ZCPQ(OneCRM)에서 생성된 것인지, ZOBJ(기존 시스템)에서 생성된 것인지 구분하여 검증 로직을 구현합니다.
1. **ZOBJ**: 기존 시스템에서 생성된 Quotation.
2. **ZCPQ**: 최근 도입된 OneCRM 시스템에서 생성된 Quotation.
 
 
**요구 사항**
**1. Quotation 검증 로직**
오더 생성 시, 납품처명(Shipto_NM)을 기준으로 Quotation의 출처를 구분하고, 이에 따라 검증 단계를 진행합니다.
* **조건 1: 납품처명에 'KR' 포함 여부 확인**
   * **Shipto_NM에 'KR'이 prefix로 포함된 경우:**
      * 해당 Quotation은 ZCPQ(OneCRM) 에서 생성된 것으로 간주합니다.
      * 품목 검증(2번) 을 진행합니다.
      * 참고: ZCPQ에서 생성된 모든 납품처명은 'KR'로 시작하며, 이는 필수값입니다.
      * **예시:**
         * Shipto_NM = **KR_수서지점 공사현장** → ZCPQ로 간주, 품목 검증 진행.
 
* **Shipto_NM에 'KR'이 포함되지 않은 경우:**
   * 해당 Quotation은 ZOBJ(기존 시스템)에서 생성된 것으로 간주합니다.
   * 품목 검증(2번) 없이 바로 주문 접수를 진행합니다.
   * **예시:**
      * Shipto_NM = **한국목재 인천지점** → ZOBJ로 간주, 품목 검증 생략.
 
 
***예외 처리***
특정 조건에 따라 Quotation 검증 로직에서 예외 처리를 적용합니다.
* **예외 1: ZOBJ Quotation인데 납품처명에 'KR'이 포함된 경우**
   * 예: Shipto_NM = **KR산업** (실제 업체명이 'KR'로 시작). -> *현재는 KR산업 1건만 해당*
   * 이 경우, 해당 Quotation은 **ZOBJ**로 간주하며, **품목 검증을 생략**합니다.
 
* **예외 2: 납품처명에 'KR'이 중복으로 포함된 경우**
   * 예: Shipto_NM = **KR_KR산업**.
   * 이 경우, 해당 Quotation은 **ZCPQ**로 간주하며, **품목 검증을 진행**합니다.
 
** **
~~**2. 품목 유무 검증**~~** **(해당 로직은 최근 개발 완료)
ZCPQ Quotation의 품목 유무를 확인하여 주문 접수 가능 여부를 결정합니다. **검증 방법:**
* **O_Quotation_Verification** 테이블을 사용하여 품목 검증을 진행합니다.
* **품목이 있는 경우:** 주문 접수를 진행합니다.
* **품목이 없는 경우:** 주문 접수가 불가합니다.

---------------------------------------------------------------------

네, 보내주신 내용을 비즈니스 로직 기준으로 정리하면 아래처럼 흐름을 그릴 수 있습니다.

---

## **비즈니스 로직 정리**

### 1. **Quotation 출처 판별 로직**

오더 생성 시, **납품처명(Shipto\_NM)** 을 기반으로 Quotation 출처를 판별하고 후속 검증을 진행.

#### 1-1. 기본 판별 규칙

| Shipto\_NM 패턴         | 판별 결과             | 후속 처리              |
| --------------------- | ----------------- | ------------------ |
| `KR`로 시작 (**prefix**) | **ZCPQ (OneCRM)** | 품목 유무 검증 진행        |
| `KR` 미포함              | **ZOBJ (기존 시스템)** | 품목 검증 생략, 바로 주문 접수 |

#### 1-2. 예시

* `KR_수서지점 공사현장` → ZCPQ 간주 → 품목 검증 진행
* `한국목재 인천지점` → ZOBJ 간주 → 품목 검증 생략

---

### 2. **예외 처리 규칙**

특정 케이스는 기본 규칙을 덮어씀.

| 조건                                      | Shipto\_NM 예시 | 판별 결과    | 후속 처리    |
| --------------------------------------- | ------------- | -------- | -------- |
| **예외 1**: ZOBJ인데 업체명이 `KR`로 시작 (실제 업체명) | `KR산업`        | **ZOBJ** | 품목 검증 생략 |
| **예외 2**: `KR`이 중복 포함                   | `KR_KR산업`     | **ZCPQ** | 품목 검증 진행 |

---

### 3. **품목 유무 검증 (ZCPQ 대상만 적용)**

> 최근 개발 완료된 기능

#### 검증 방법

* **O\_Quotation\_Verification** 테이블 조회
* **품목 있음** → 주문 접수 진행
* **품목 없음** → 주문 접수 불가

---

### 4. **전체 흐름**

1. **Shipto\_NM 판별**

   * `KR` prefix 여부 체크
   * 예외 조건 체크
2. **출처 확정**

   * ZCPQ or ZOBJ 결정
3. **ZCPQ인 경우만 품목 검증**

   * 품목 있음 → 주문 접수
   * 품목 없음 → 접수 불가
4. **ZOBJ인 경우 품목 검증 생략 후 접수**

---

원하시면 이 로직을 **순서도(Flowchart)** 형태로 바로 그려서
개발팀·기획팀이 공유할 수 있는 문서 버전으로 만들어 드릴 수도 있습니다.
그렇게 하면 예외 처리까지 한눈에 보일 거예요.

이대로 흐름도 그려 드릴까요?

---------------------------------------------------------------------


# 1. Quotation 출처 판별 로직과 2. 예외 처리 규칙의 내용이 충돌나지 않아?

---------------------------------------------------------------------

전혀 충돌 아니야. **우선순위(Precedence)** 를 명확히 정하면 깔끔하게 떨어져.
핵심은 “**기본 규칙 → 예외 규칙(화이트리스트) → 후속 처리**” 순서로 고정하는 거야.

---

# 결정 원칙(권장)

1. **예외(화이트리스트) 먼저 확인**

   * 실존 업체명 때문에 혼동되는 케이스를 테이블/리스트로 관리.
   * 예: `KR산업` → **ZOBJ** 확정(품목 검증 생략).

2. **정규 패턴로 OneCRM(ZCPQ) 구분**

   * 납품처명이 **`KR` + 구분자(`_`, `-`, 공백)** 로 시작하면 **ZCPQ**.
   * 예: `KR_수서지점…`, `KR-용산`, `KR 강남…` → **ZCPQ**.

3. **그 외는 기존(ZOBJ)**

   * 납품처명에 `KR`이 **포함만** 되어 있거나,
   * `KR`로 **바로 붙어서** 시작(구분자 없음, 예: `KR산업`)하면서 예외 미지정인 경우 → **ZOBJ**.

4. **중복 KR 처리**

   * `KR_KR…` 처럼 **선두에 KR+구분자**가 있으면 **무조건 ZCPQ** (예외 미적용).

이 순서를 지키면, “1. 출처 판별”과 “2. 예외 규칙”은 **충돌 없이** 동작해.

---

# 흐름 요약(결정 트리)

1. `Shipto_NM` 정규화(Trim)
2. **예외목록 매칭?**

   * Yes → `ZOBJ` → 품목검증 **생략** → 주문접수
   * No  → 다음
3. **`^KR([_ -].*)` 로 시작?**

   * Yes → `ZCPQ` → **품목 유무 검증**(O\_Quotation\_Verification)
   * No  → 다음
4. **`^KR.*` (구분자 없이 붙어서 시작)?**

   * Yes → `ZOBJ` (현재 정책상 `KR산업` 류는 ZOBJ 취급)
   * No  → `ZOBJ`
5. `ZCPQ` 인 경우만: **품목 있음 → 접수 / 없음 → 접수불가**

> 포인트: **예외 → 패턴 → 기본** 순으로만 보면 일관성 유지됨.

---

# 경계 조건(애매한 케이스) 처리 기준

| 케이스              | 예시                    | 처리                                               |
| ---------------- | --------------------- | ------------------------------------------------ |
| KR이 중간에만 있음      | `한국KR상사`              | ZOBJ                                             |
| KR로 시작하지만 구분자 없음 | `KR산업`                | 예외 등록 시 ZOBJ(권장). 현재는 이 1건만 대상이라고 했으므로 화이트리스트에 둠 |
| KR가 2번 이상        | `KR_KR산업`, `KR-KR 성수` | ZCPQ (선두 KR+구분자 규칙 우선)                           |
| 소문자/혼용           | `kr_…`, `Kr …`        | 대소문자 무시/정규화 후 동일 규칙 적용 권장                        |

---

# 구현 예(안)

## 1) T-SQL 판별 뷰/컬럼 (Knauf-SQL-Style v1.1)

* **예외 테이블**(화이트리스트) 예: `dbo.O_Quotation_Exception`

  * `EXC_TYPE` (N'ZOBJ\_NAME')
  * `SHIPTO_NM` (정확 매칭용)

```sql
SELECT
       ST.SHIPTO_NM
     , CASE
           WHEN EXISTS (
                    SELECT
                           1
                    FROM dbo.O_Quotation_Exception E
                    WHERE E.EXC_TYPE = N'ZOBJ_NAME'
                      AND E.SHIPTO_NM = ST.SHIPTO_NM
                )
                THEN N'ZOBJ'
           WHEN ST.SHIPTO_NM LIKE N'KR[_ -]%' ESCAPE N'\'  -- KR+구분자(언더스코어/하이픈/공백)
                THEN N'ZCPQ'
           WHEN ST.SHIPTO_NM LIKE N'KR%'                   -- 구분자 없이 바로 붙는 경우
                THEN N'ZOBJ'
           ELSE N'ZOBJ'
       END AS QUOTATION_SRC
FROM dbo.O_SHIPTO ST
;
```

> v1.1 규칙 적용: 한글 리터럴 `N''`, 스키마 한정 `dbo.` 사용.

## 2) Java (Service 레벨) 간단 판별 함수

```java
public enum QuotationSrc { ZCPQ, ZOBJ }

public QuotationSrc decideSrc(String shiptoNm, Set<String> zobjExceptions) {
    if (shiptoNm == null) return QuotationSrc.ZOBJ;
    String s = shiptoNm.trim();

    // 1) 예외(화이트리스트) 우선
    if (zobjExceptions.contains(s)) return QuotationSrc.ZOBJ;

    // 2) KR + 구분자(_ - space)로 시작 -> ZCPQ
    if (s.matches("^(?i)KR([_\\- ].*).*")) return QuotationSrc.ZCPQ;

    // 3) KR로 시작하지만 구분자 없음 -> ZOBJ
    if (s.matches("^(?i)KR.*")) return QuotationSrc.ZOBJ;

    // 4) 나머지 -> ZOBJ
    return QuotationSrc.ZOBJ;
}
```

> `(?i)`로 대소문자 무시.
> 예외 목록은 DB에서 로드(캐싱) 추천: `KR산업` 등.

## 3) 후속 처리(품목 검증)

```sql
-- ZCPQ 대상일 때만 확인
SELECT
       Q.QUOTATION_ID
     , CASE
           WHEN EXISTS (
                    SELECT
                           1
                    FROM dbo.O_Quotation_Verification V
                    WHERE V.QUOTATION_ID = Q.QUOTATION_ID
                      AND V.ITEM_CNT > 0
                )
                THEN N'OK'
           ELSE N'NO_ITEM'
       END AS VERIFY_RESULT
FROM dbo.O_QUOTATION Q
WHERE Q.QUOTATION_SRC = N'ZCPQ'
;
```

---

# 테스트 케이스(샘플)

| Shipto\_NM     | 기대 판정 | 이유                     |
| -------------- | ----- | ---------------------- |
| `KR_수서지점 공사현장` | ZCPQ  | KR+구분자 시작              |
| `KR-한남`        | ZCPQ  | KR+구분자 시작              |
| `KR 강남`        | ZCPQ  | KR+구분자 시작              |
| `KR산업`         | ZOBJ  | 예외 화이트리스트              |
| `KR건축`         | ZOBJ  | KR 시작(구분자 없음) & 예외 미등록 |
| `한국목재 인천지점`    | ZOBJ  | KR 미포함                 |
| `KR_KR산업`      | ZCPQ  | 선두 KR+구분자 규칙 우선        |
| `한국KR상사`       | ZOBJ  | KR 포함이지만 선두+구분자 아님     |

---

# 운영 팁

* **예외는 데이터로 관리**: 하드코딩 금지. 운영 중 추가·수정 가능해야 함.
* **로그 남기기**: 판별 근거(예외/패턴)를 로깅해 추후 오분류 역추적.
* **대소문자/공백 정규화**: 저장 전 `trim`, 대소문자 무시 일괄 적용.
* **모니터링 쿼리**: `WHERE Shipto_NM LIKE N'KR%' AND Shipto_NM NOT LIKE N'KR[_ -]%'`
  → “잠재적 예외 후보” 점검용.

---

## 결론

* **충돌 없음**.
* **예외(화이트리스트) → 패턴(KR+구분자) → 기본(ZOBJ)** 순으로만 고정하면 항상 결정적이고 일관되게 동작해.
* 위 로직으로 바로 반영 가능하고, 예외 증가에도 안전하게 확장돼.


---------------------------------------------------------------------

# 'KR_'로 시작하면 'ZCPQ'로 분류하고, 그외 'KR'로 시작하는 경우는 'ZOBJ'인가?

---------------------------------------------------------------------

맞아요. 현재 정책 흐름을 단순화하면 이렇게 됩니다.

---

## **판별 규칙 (간단 버전)**

1. **`Shipto_NM`이 `KR_`로 시작 → ZCPQ**

   * OneCRM(신규)에서 생성된 것으로 간주
   * 품목 유무 검증 진행
   * 예:

     * `KR_수서지점` → **ZCPQ**
     * `KR_KR산업` → **ZCPQ** (중복 KR도 `KR_`로 시작하므로 ZCPQ)

2. **`KR`로 시작하지만 `_`(언더스코어) 없이 붙어있음 → ZOBJ**

   * 기존 시스템에서 생성된 것으로 간주
   * 품목 검증 생략
   * 예:

     * `KR산업` → **ZOBJ** (현재 화이트리스트 등록됨)
     * `KR건축` → **ZOBJ**

3. **그 외**

   * `KR`이 중간에 있거나 아예 없음 → ZOBJ
   * 품목 검증 생략
   * 예:

     * `한국목재 인천지점` → **ZOBJ**
     * `한국KR상사` → **ZOBJ**

---

📌 **정리**

* `KR_` = **무조건 ZCPQ**
* `KR` + (구분자 없음) = **ZOBJ**
* 예외업체는 화이트리스트에서 강제로 ZOBJ 처리

---

원하시면 이 규칙을 **SQL CASE문**으로 바로 작성해 드릴까요?
그러면 DB 쿼리에서도 바로 적용 가능해요.
