아래 문서는 PR·MDA·GI·CC·IS·IA·CS·TE·IL·IW 프레임을 적용해 문제를 재정의하고(필수 컬럼·우선순위 룰·대용량 엑셀·임시테이블), 다차원 분석(모듈/DB/성능/보안), 설계(아키텍처·인터페이스), 실행 단계(체크리스트), 검증(테스트), 배포/롤백(무중단), 운영/모니터링, 리스크/완료 기준까지 일관된 흐름으로 구조화했습니다.
산출물은 \*\*마크다운 문서(글·표·체크리스트만)\*\*이며, 코드/명령어/SQL 예시는 포함하지 않습니다.

---

# 1) 요구사항 명세

* **업무 개요**: 웹 페이지에서 사용자가 업로드한 엑셀(xlsx) 파일을 받아 임시 테이블에 전량 적재 후, 두 개의 운영 테이블(**O\_SALESORDER**, **QMS\_SALESORDER**)에 **동일 규칙**으로 상태값을 업데이트하고, 실패 건 리포트를 화면으로 제공한다.
* **엑셀 파일 제약**: 필수 컬럼(①SalesDocument, ②Sales Document Item, ③Reason for rejection, ④DS, ⑤OS)은 **반드시 존재**하며, 그 외 컬럼은 개수·이름·순서가 파일마다 **가변**이다. 행 수는 **최대 13,000건 이상** 가능.
* **매칭 키 규칙**: `SalesDocument` ↔ `ORDERNO`, `Sales Document Item × 100` ↔ `LINE_NO` 조건의 **AND 매칭**으로 대상 레코드 식별.
* **상태 업데이트 우선순위**
  1순위) Reason for rejection **Not Null** → `STATUS1=980`, `STATUS=999`, `STATUS_DESC=오더취소`
  2순위) DS=`C` → `STATUS1=580`, `STATUS=620`, `STATUS_DESC=배송완료`
  3순위) DS `Null` & OS=`C` → `STATUS1=580`, `STATUS=620`, `STATUS_DESC=배송완료`
  중복 시 **1 > 2 > 3** 우선 적용.
* **처리 방식**: 업로드 즉시 비동기 Job으로 시작, **진행률** 및 처리 통계를 주기적으로 UI에 노출(총건/성공/실패/진행%/예상잔여시간).
* **리포트 요건**: 실패 건의 **키값(SalesDocument, Sales Document Item)** 및 **실패 사유 코드/메시지**를 화면에서 조회·다운로드 가능(기간/업로드ID 필터).
* **성능 목표**: 13k행 기준 **분 단위 내 처리**(환경/부하에 따라 목표치 조정), DB는 **세트 기반 비교/갱신**으로 일괄 처리, UI 폴링/스트리밍은 과도한 빈도 제한.
* **운영 제약**: Java(Spring) on Tomcat 9, MSSQL 2019, Zulu-8, STS4.5. 보안·감사 요건(업로더/시간/IP/파일해시) 기록.
* **장애 복구성**: 업로드 단위 **재시도 가능**, 임시테이블 및 잡 메타데이터를 통해 **중단점 재개** 및 부분 롤백 가능.

---

# 2) 영향도 분석 (모듈/DB/성능/보안)

* **애플리케이션 모듈**

  * 신규: 업로드 UI, 업로드 API, 파일 검증/파서, 타입 추론기, 임시적재기, 매칭/룰 엔진, 진행률/리포트 API, 잡 스케줄러/실행기.
  * 변경: 공통 예외/응답 포맷, 권한체계(메뉴 접근/다운로드 권한), 로깅/감사.
  * 비동기 실행을 위한 스레드풀/큐 설정 영향.
* **DB 스키마**

  * 신규: **업로드 Job 메타**(업로드ID, 상태, 통계), **실패 리포트**(키/사유), **임시 테이블**(업로드ID별 동적 스키마 또는 표준+확장영역) 및 **인덱스**(ORDERNO, LINE\_NO).
  * 기존: **O\_SALESORDER**, **QMS\_SALESORDER**는 **데이터 갱신만**(스키마 변경 없음).
* **성능**

  * 파일 파싱: 스트리밍/청크 처리로 메모리 사용 제한.
  * DB: 세트 기반 비교·갱신(대량 처리 1\~N 배치), 임시테이블 인덱싱으로 조인 비용 최소화.
  * UI 진행률: 폴링 간격/푸시 빈도 **조절**로 오버헤드 최소화.
* **동시성/잠금**

  * 동일 주문 동시 갱신 충돌 방지(업로드ID 락/리소스 뮤텍스/업무시간 정책).
  * 트랜잭션 범위는 **배치 단위**로 나누어 롤백 범위 최소화.
* **보안**

  * 파일 확장자/콘텐츠타입 화이트리스트, 크기 제한, 안티바이러스/매크로 차단.
  * 업로더 인증/인가, 데이터 마스킹(로그), 저장 시 서버 측 암호화(필요시).
* **감사/추적성**

  * 업로드ID, 사용자, 원본파일명/해시, 처리 시작/종료, 규칙별 적용 건수 기록.
  * 모든 변경 건에 대해 **전/후 상태 스냅샷 요약**(건수/범주 수준).
* **장애 영향**

  * 임시테이블 잔존 시 저장공간 증가 → 주기적 청소(보존기간).
  * 대량 갱신 시 I/O 스파이크 → 시간대 제어/자원 보호 정책.

---

# 3) 설계 (아키텍처, 인터페이스)

## 3.1 아키텍처 개요

* **프론트엔드**: 업로드 화면(파일 선택/전송), 진행률 바, 결과 리포트 다운로드/조회.
* **백엔드 흐름**: 업로드 API → 파일 검증 → 파싱/타입추론 → **임시테이블 적재** → 매칭/룰 엔진 → 결과 집계 → 리포트 저장 → 진행률/완료 응답.
* **비동기 처리**: 업로드 수신 즉시 **Job Queue**에 등록, 워커가 단계별 진행. UI는 Job 상태 폴링 또는 서버푸시로 갱신.
* **데이터 계층**: 임시테이블(업로드ID별), 메타/리포트 테이블, 대상 운영 테이블 2종.
* **확장성**: 임시테이블 스키마는 **필수컬럼+확장 JSON/EAV** 또는 **동적 스키마** 중 하나 선택(운영 기준에 맞춰 결정).
* **장애복구**: Job 상태 머신(대기→적재→검증→매칭→갱신→리포트→완료/실패), **재시도 정책** 및 중단점 재개.

## 3.2 인터페이스 정의(요약)

| 구분  | 이름     | 입력       | 출력          | 설명                        |
| --- | ------ | -------- | ----------- | ------------------------- |
| UI  | 업로드 화면 | 파일(xlsx) | 업로드ID       | 업로드 즉시 Job 생성 및 진행률 화면 전환 |
| API | 업로드 제출 | 파일, 옵션   | 업로드ID       | 검증 후 Job 큐 등록             |
| API | 진행률 조회 | 업로드ID    | 상태, 진행%, 통계 | 총건/성공/실패/현재단계/ETA         |
| API | 리포트 조회 | 업로드ID/기간 | 페이징 결과      | 실패건 키/사유/타임스탬프            |
| 내부  | 임시적재   | 파싱레코드    | 적재건수        | 스트리밍 적재 후 인덱스 구성          |
| 내부  | 매칭/갱신  | 업로드ID    | 적용건 통계      | 두 테이블 동시 규칙 적용            |
| 내부  | 감사/로그  | 이벤트      | 로그          | 파일/사용자/룰적용 집계             |

## 3.3 매칭·룰 표(레퍼런스)

| 항목  | 기준                                                              | 결과(둘 다 동일 적용)                              | 우선순위 |
| --- | --------------------------------------------------------------- | ------------------------------------------ | ---- |
| 매칭키 | SalesDocument = ORDERNO, (Sales Document Item × 100) = LINE\_NO | 대상 레코드 식별                                  | -    |
| 룰1  | Reason for rejection **Not Null**                               | STATUS1=980, STATUS=999, STATUS\_DESC=오더취소 | 1    |
| 룰2  | DS = `C`                                                        | STATUS1=580, STATUS=620, STATUS\_DESC=배송완료 | 2    |
| 룰3  | DS `Null` AND OS = `C`                                          | STATUS1=580, STATUS=620, STATUS\_DESC=배송완료 | 3    |

---

# 4) 작업 순서 (세부 단계별 체크리스트)

## 4.1 사전 준비

* [ ] 메뉴/권한 등록(업로드/리포트 조회).
* [ ] 임시테이블 전략 결정(동적 스키마 vs 표준+확장영역) 및 보존기간/청소정책 합의.
* [ ] Job 스레드풀/큐 크기, 동시 업로드 제한치, DB 리소스 가드레일 설정.
* [ ] 실패사유 코드셋 정의(스키마오류/필수컬럼누락/형변환실패/매칭실패/중복/권한/시스템오류 등).
* [ ] 성능 목표와 운영 시간대(배치 금지 시간/허용 시간) 확정.

## 4.2 업로드·검증

* [ ] 파일 확장자/콘텐츠타입/크기 검사, 바이러스 스캔.
* [ ] 필수 컬럼 5종 존재 여부/정확한 컬럼명 확인(대소문자/공백 포함 규칙).
* [ ] 데이터 타입 샘플링 및 컬럼별 타입 추론(숫자/문자/날짜), 변환 불가값 수집.
* [ ] 헤더 중복/공백/숨은문자 정리, 전체 행수 카운트.
* [ ] 업로드 메타 기록(업로드ID, 사용자, 파일명/해시, 시작시각).

## 4.3 임시테이블 적재

* [ ] 업로드ID 기준 임시테이블 생성 및 인덱스 준비(ORDERNO, LINE\_NO 대응 컬럼).
* [ ] 스트리밍/배치 단위로 적재하며, 변환 불가 레코드는 **즉시 실패큐**로 분기.
* [ ] 필수 컬럼 맵핑(SalesDocument, Sales Document Item, Reason for rejection, DS, OS).
* [ ] 추가 컬럼은 확장 영역(JSON/EAV) 또는 동적 컬럼으로 보존.
* [ ] 적재 완료 후 건수/무결성 점검 및 진행률 업데이트.

## 4.4 매칭·룰 적용

* [ ] 임시테이블 ↔ 대상 테이블 조인 키 준비(SalesDocument ↔ ORDERNO, Item×100 ↔ LINE\_NO).
* [ ] 중복/다건매칭 검출(동일 키 다건 시 실패큐로 분기).
* [ ] 우선순위(1→2→3)로 상태 결정, 둘 다 테이블에 **동일 적용**.
* [ ] 미매칭 건은 실패큐에 사유와 함께 적재.
* [ ] 단계별 통계 집계(적용/미적용/실패/스킵).

## 4.5 완료·리포트

* [ ] Job 상태를 완료/부분실패로 마감, 종료시각/소요시간 기록.
* [ ] 실패 리포트 테이블에 키/사유/원본값 요약 저장.
* [ ] UI에서 페이징/필터(업로드ID/기간/사유코드) 제공.
* [ ] 파일/화면 두 형태 제공(내부 규정에 따라 파일 제한 가능).
* [ ] 임시테이블 보존정책에 따라 보관/삭제 스케줄링.

---

# 5) 테스트 계획 (단위/통합/회귀)

## 5.1 단위 테스트(예시 범주)

* [ ] 컬럼 존재/정확성 검증 로직(필수 5종).
* [ ] 타입 추론/정규화(숫자, 문자열, 날짜) 및 에러 수집.
* [ ] 매칭키 변환 로직(아이템×100 매핑 규칙) 경계값.
* [ ] 우선순위 룰 결정기(중복 조건 시 1>2>3 적용).
* [ ] 실패사유 코드 매핑 및 메시지 생성.

## 5.2 통합 테스트

* [ ] 13k+ 행 대용량 파일 적재 성능/메모리 사용량.
* [ ] 임시테이블 ↔ 대상 테이블 조인 정확성 및 부분 매칭/미매칭 처리.
* [ ] 두 테이블 동시 업데이트 일관성(부분 실패 시 롤백/재시도).
* [ ] 진행률 API 정확성(총건, 처리건, 실패건, ETA) 및 UI 반영 주기.
* [ ] 리포트 조회/다운로드 기능과 보안(권한/감사).

## 5.3 회귀 테스트

* [ ] 기존 주문 조회/수정/배치 기능 영향 없음 확인.
* [ ] 공통 로깅/예외 처리 포맷 호환성.
* [ ] 인증/인가 흐름 및 메뉴 접근 정책 유지.
* [ ] DB 인덱스/통계 업데이트로 인한 기존 쿼리 성능 변화 감시.
* [ ] 배포 구성(Tomcat 스레드/커넥션풀) 변경 시 기존 트래픽 안정성.

---

# 6) 배포/롤백 절차 (무중단 고려)

## 6.1 배포(Blue-Green 또는 점진)

* [ ] 사전: DB 스키마 추가(메타/리포트/임시테이블 정책)와 인덱스 생성, 권한 부여.
* [ ] 애플리케이션 배포: 비동기 Job/스레드풀/설정값(폴링주기, 동시업로드수) 환경반영.
* [ ] Blue-Green 전환 또는 인스턴스 순차 롤링, 세션 스티키 설정 확인.
* [ ] 기능 토글(업로드 메뉴) **비공개 상태**로 올린 뒤 연기 테스트.
* [ ] 헬스체크/연기 검증 후 토글 오픈(파일 크기/동시성 제한치부터 점진 확대).

## 6.2 롤백

* [ ] 애플리케이션: 토글로 업로드 기능 즉시 차단 → 이전 버전으로 재배포.
* [ ] DB: 신규 스키마는 **보존**(데이터 보전을 위해 즉시 삭제 금지), 필요 시 비활성 플래그.
* [ ] 진행 중 Job는 **안전 중단** 후 재시작 가능 상태로 마킹.
* [ ] 사용자 공지 및 업로드 재시도 가이드 제공.
* [ ] 원인 분석 로그/메트릭 수집 및 재발 방지 액션 등록.

---

# 7) 모니터링/운영 포인트

* **지표**

  * 업로드 처리시간(P50/P95), 초당 처리건, 실패율, 재시도율, 평균 파일 크기.
  * DB 대기/잠금 시간, 조인 비용, I/O, 임시테이블 크기/보존량.
  * 스레드풀 큐 길이, 활성 스레드, 메모리 사용량, GC 간격.
  * 진행률 API 호출 빈도/지연, UI 오류율.
* **알림 임계치**

  * 실패율 급증, 처리시간 P95 초과, DB 잠금/데드락 발생, 임시공간 임계.
  * 동일 키 다건 충돌/미매칭률 급증.
* **로그/감사**

  * 업로드ID 전파, 단계별 상태 전이, 룰별 적용 건수, 오류 스택 요약.
  * 사용자/IP/파일해시 기록(보존기간 정책).
* **운영 작업**

  * 임시테이블/리포트 보존 청소 배치, 인덱스/통계 점검.
  * 기능 토글로 점검창구 운영(혼잡 시 일시 제한).
* **보안 운영**

  * 허용 파일 유형/크기 상시 점검, 악성 패턴 차단 룰 업데이트.
  * 민감정보 노출 점검(로그/리포트).

---

# 8) 리스크 / 완료 기준

## 8.1 주요 리스크

* [ ] 필수 컬럼 명칭·대소문자/공백 차이로 인한 인식 실패.
* [ ] Sales Document Item ×100 매핑 누락/반올림/자릿수 오류.
* [ ] 동일 키 다건/중복 행으로 인한 비결정적 업데이트.
* [ ] 대량 갱신 시 잠금 확대/성능 저하, 다른 배치와 충돌.
* [ ] 진행률 과다 갱신으로 서버/DB 부하 증가.
* [ ] 임시테이블 누적에 따른 저장공간 고갈.
* [ ] 권한 미설정으로 인한 무단 접근/대량 갱신 사고.
* [ ] 오류 리포트 과다로 인한 운영 대응 지연.

## 8.2 완료 기준(DoD)

* [ ] 요구사항 전부 구현: 필수 컬럼 인식, 임시적재, 매칭·우선순위 룰, 두 테이블 동시 반영, 진행률/리포트 제공.
* [ ] 테스트 통과: 단위/통합/회귀 및 성능 지표(합의된 목표) 충족.
* [ ] 무중단 배포 완료 및 기능 토글 오픈, 초기 운영 1주 문제없음.
* [ ] 모니터링 대시보드/알림 설정 활성, 운영 매뉴얼/장애 대응 가이드 배포.
* [ ] 데이터 검증 샘플(무작위 표본)에서 인업데이트/오업데이트 **0건** 확인.
* [ ] 임시테이블 청소 정책 자동화 및 보존기간 준수 확인.

---

## 참고 표: 실패사유 코드 체계(예시)

| 코드   | 분류    | 설명             |
| ---- | ----- | -------------- |
| R001 | 스키마오류 | 필수 컬럼 누락/오탈자   |
| R002 | 형변환실패 | 숫자/날짜/문자 변환 실패 |
| R003 | 매칭실패  | 대상 주문 미존재      |
| R004 | 중복키   | 동일 키 다건 업로드    |
| R005 | 권한    | 업로더 권한 없음      |
| R006 | 시스템   | 내부 예외/타임아웃     |
| R007 | 정책위반  | 파일 크기/형식 제한 초과 |

> 위 문서를 그대로 개발/QA/운영 공동의 “작업 흐름 문서”로 사용하면 된다. 각 팀은 체크리스트를 기반으로 세부 구현·테스트 항목을 보강하되, **코드/SQL 없이도 실행 가능**한 수준의 절차와 기준을 유지한다.
