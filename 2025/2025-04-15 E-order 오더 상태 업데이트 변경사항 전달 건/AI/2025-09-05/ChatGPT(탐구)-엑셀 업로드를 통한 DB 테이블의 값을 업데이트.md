좋아 👍 이건 딱 네가 원한 “개발 흐름을 글로 문서화해서 단계별로 정리”하는 작업이야.
코드는 일절 없이 **WBS + 단계별 체크리스트 + 리스크/QA 포인트**로 정리해줄게.

---

# 📑 엑셀 업로드 기반 DB 업데이트 작업 흐름 문서

## 1. 요구사항 요약

* **기능**: 웹 페이지에서 엑셀 업로드 → O\_SALESORDER, QMS\_SALESORDER 업데이트
* **대상 데이터**: SalesDocument, Sales Document Item, Reason for rejection, DS, OS
* **처리 로직**: 임시 테이블 기반 → 조건별 상태 업데이트 → 리포트 제공
* **우선순위 규칙**: ① 오더취소 > ② 배송완료(DS) > ③ 배송완료(OS)

---

## 2. 영향도 분석

* **기능**: 신규 화면(업로드 + 진행률 표시 + 리포트) 추가
* **데이터**: 대량 Insert(임시 테이블), Update(2개 주요 테이블)
* **성능**: 행 수 13,000+ / 배치 처리 필요, 트랜잭션 관리 주의
* **보안**: 업로드 파일 확장자 및 내용 검증 필요
* **운영**: 대량 업데이트 실패 시 롤백/재시도 절차 필수

---

## 3. 설계 개요

* **업로드 모듈**: 웹에서 엑셀 업로드 → 서버 수신
* **임시 테이블 생성**: 업로드 파일 컬럼 기반으로 생성 (가변 컬럼 대응)
* **데이터 적재**: 전체 파일 → 임시 테이블 Insert
* **비즈니스 로직**: 테이블 대 테이블 Join & Update 수행
* **상태 매핑 규칙**:

  * Reason for rejection ≠ Null → STATUS1=980, STATUS=999, STATUS\_DESC=오더취소
  * DS=C → STATUS1=580, STATUS=620, STATUS\_DESC=배송완료
  * DS=Null & OS=C → STATUS1=580, STATUS=620, STATUS\_DESC=배송완료
* **우선순위 처리**: (1) → (2) → (3)
* **진행률 표시**: 업로드 → 적재 → 변환 → 업데이트 → 리포트 단계별 %
* **리포트**: 실패 건(ORDERNO, LINE\_NO, 실패사유) 저장 후 UI로 전달

---

## 4. 작업 순서 (WBS + 체크리스트)

### 4.1 사전 준비

* [ ] 엑셀 업로드 허용 용량 확인 (최소 20MB 이상)
* [ ] 임시 테이블 전용 스키마/네임스페이스 준비
* [ ] 실패 로그 저장용 테이블 정의

### 4.2 엑셀 업로드 처리

* [ ] 파일 확장자, 필수 컬럼 존재 여부 검증
* [ ] 엑셀 → 서버 메모리/스트림 변환
* [ ] 임시 테이블 생성 (컬럼명+타입 자동 매핑)

### 4.3 임시 테이블 적재

* [ ] 전체 데이터 Bulk Insert
* [ ] Insert 완료 후 Row Count 검증 (업로드 건수와 동일해야 함)
* [ ] 적재 실패 시 전체 롤백

### 4.4 DB 업데이트 실행

* [ ] O\_SALESORDER, QMS\_SALESORDER를 SalesDocument + Sales Document Item\*100 매핑
* [ ] 우선순위 규칙 적용 (CASE WHEN 순서 반영)
* [ ] 성공/실패 건 구분 (실패 건은 리포트 테이블 Insert)

### 4.5 진행률 표시

* [ ] 업로드 → 적재 → 변환 → 업데이트 → 완료, 각 단계 진행률 저장
* [ ] 웹 화면에서 주기적으로 Ajax/Fetch 요청 → 진행률 표시

### 4.6 리포트 생성

* [ ] 실패 건(OrderNo, LineNo, 사유) 리포트 테이블 적재
* [ ] 리포트 테이블 조회 → 웹 화면 표시 (다운로드 가능 CSV)

### 4.7 마무리

* [ ] 임시 테이블 삭제(성공 시) / 유지(실패 시 디버깅 용)
* [ ] 처리 건수, 성공/실패 비율 로그 저장
* [ ] 운영자에게 완료 알림 발송(메일/로그 모니터링)

---

## 5. 테스트 계획

* **단위 테스트**: 업로드 파일 파싱, 임시 테이블 생성, Insert 검증
* **통합 테스트**: 실제 DB 업데이트 후 상태 값 확인
* **부하 테스트**: 13,000행 이상 파일 성능 측정 (업데이트 시간, Lock 여부)
* **에러 시나리오**: 컬럼 누락, 잘못된 타입, 중복 키, 대량 Null 값

---

## 6. 배포 및 롤백 계획

* **배포 전**: 운영 DB 백업, 신규 테이블/리포트 테이블 생성 스크립트 사전 검증
* **배포 방법**: 무중단(임시 테이블 작업은 독립적으로 수행)
* **롤백 방법**: 업데이트 대상 테이블 백업본 Restore 또는 Transaction Rollback

---

## 7. 모니터링

* **DB**: 업데이트 쿼리 실행 시간, Deadlock 여부
* **웹**: 업로드 파일 크기, 진행률 API 응답 속도
* **리포트**: 실패 건수가 일정 비율(>10%) 이상이면 관리자 알림

---

## 8. 리스크 및 대응

* **대량 데이터 성능 저하** → Bulk Insert, 배치 처리, 인덱스 튜닝
* **컬럼 변동** → 동적 SQL/매핑 모듈화
* **Deadlock 가능성** → 트랜잭션 최소 단위화, Index 확인
* **리포트 누락** → 실패 건 처리 루틴 별도 관리

---

## 9. 완료 기준

* [ ] 업로드한 파일 행 수 = 임시 테이블 Insert 행 수
* [ ] DB 업데이트 반영 수치 = 성공 건수 합계
* [ ] 실패 리포트 테이블에 오류 건 저장 완료
* [ ] 웹 화면에서 진행률 + 리포트 확인 가능

---

👉 이렇게 하면 코드 하나 없이도 **개발자가 바로 작업 플로우를 따라갈 수 있는 문서**야.

혹시 이걸 **엑셀 체크리스트** 형식으로 변환해줄까? (담당자/예정일/완료일 컬럼 넣어서 바로 WBS 관리 가능하게)
