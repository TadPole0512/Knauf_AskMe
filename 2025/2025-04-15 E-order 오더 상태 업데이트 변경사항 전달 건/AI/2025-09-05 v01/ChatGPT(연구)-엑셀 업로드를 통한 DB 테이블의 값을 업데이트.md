# Java(Spring) + Tomcat9 + MSSQL 운영 반영을 위한 작업 흐름 문서

*(본 문서는 개발·QA·운영 전원이 이해할 수 있도록 단계별로 작업명/개요/내용을 정리했으며, 코드·명령어·SQL 예시는 포함하지 않습니다.)*

---

## 0. 변경 요구 정리(As-Is/To-Be 명확화)

| 항목             | 개요                  | 내용                                                                                                                                                                                                            |
| -------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 업무 목적          | 엑셀 업로드로 주문 상태 일괄 갱신 | 웹 화면에서 업로드된 엑셀을 기반으로 `O_SALESORDER`, `QMS_SALESORDER`를 동일 규칙으로 업데이트                                                                                                                                           |
| 입력 데이터         | 엑셀 파일               | 필수 컬럼: `SalesDocument`, `Sales Document Item`, `Reason for rejection`, `DS(Delivery status)`, `OS(Overall status)` / 그 외 컬럼 존재 가능, 컬럼 순서·개수 가변, 행 수 13,000건 이상 가능                                             |
| 매칭 키           | 주문·라인 매칭            | `SalesDocument` + (`Sales Document Item` × 100) ↔ DB의 `ORDERNO` + `LINE_NO`                                                                                                                                   |
| 상태 갱신 규칙(우선순위) | 충돌 시 우선순위 적용        | 1>2>3 순서로 적용<br>1) `Reason for rejection` ≠ Null → `STATUS1=980`, `STATUS=999`, `STATUS_DESC=오더취소`<br>2) `DS='C'` → `STATUS1=580`, `STATUS=620`, `STATUS_DESC=배송완료`<br>3) `DS`가 Null AND `OS='C'` → 동일하게 배송완료 |
| 출력             | 처리 결과 피드백           | 진행률 표시 + 실패건 리포트(키값/사유)                                                                                                                                                                                       |

---

## 1. 사전 점검(운영 반영 전 공통)

| 작업명    | 개요          | 내용                                                                                                                             |
| ------ | ----------- | ------------------------------------------------------------------------------------------------------------------------------ |
| 환경 확인  | 런타임/툴 버전 일치 | Windows / STS4.5 / Zulu-8 / Tomcat 9.0.99 / MSSQL 2019(15.0.4415.2, RTM, SE 64-bit) / Maven / MyBatis / JQGrid / DBeaver, SSMS |
| 영향도 파악 | 시스템 영향 범위   | 주문 상태 변경 로직은 두 테이블 동시 반영이므로 트랜잭션·락·동시성 영향 검토(온라인 주문 조회/배치 충돌 여부 포함)                                                            |
| 권한/보안  | 최소 권한 원칙    | 업로드/임시 테이블/업데이트 대상 테이블에 필요한 최소 권한만 부여, 운영 접속 계정 분리                                                                             |
| 용량/성능  | 데이터·로그 용량   | 13k+ 행 업로드 시 임시테이블·로그·리포트 테이블 용량 및 인덱스 재빌드 영향 점검                                                                               |
| 백업 전략  | 롤백 대비       | 대상 테이블의 변경 전 스냅샷(또는 파티션/시점복구 전략), 애플리케이션 롤백 경로 확보                                                                              |

---

## 2. 기능 설계(데이터 흐름 정의)

| 작업명        | 개요               | 내용                                                                                                                                                                                             |
| ---------- | ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 데이터 플로우 정의 | 업로드→적재→검증→갱신→리포트 | 1) 사용자가 엑셀 업로드<br>2) 서버에서 파일 메타 검증(확장자/사이즈/시트/헤더)<br>3) 임시테이블 생성(동적 스키마)<br>4) 벌크 적재<br>5) 키 매칭·사전 검증(중복/미매칭/필수값 누락)<br>6) 우선순위 규칙에 따른 머지 업데이트(두 테이블 동시)<br>7) 실패 사유 기록 및 리포트 생성<br>8) 임시자원 정리 |
| 동시성 제어     | 병렬 처리 시나리오       | 파일 단위 직렬 처리 기본, 대형 파일은 청크 단위 내부 병렬 가능(단, 동일 ORDERNO 경합 방지)                                                                                                                                     |
| 트랜잭션 경계    | 일관성 확보           | 테이블 당 대량 갱신은 배치 커밋 구간 설정(과도한 롤백 방지), 실패 청크 재시도 설계                                                                                                                                              |

---

## 3. 임시 테이블(스테이징) 설계 원칙

| 작업명     | 개요            | 내용                                                                              |
| ------- | ------------- | ------------------------------------------------------------------------------- |
| 스키마 동적화 | 컬럼 수/순서 가변 대응 | 업로드 파일의 헤더를 기준으로 임시테이블 컬럼을 런타임 생성(필수 컬럼은 존재 필수 검사, 선택 컬럼은 존재 시 생성)              |
| 데이터 표준화 | 타입/정규화        | 수치/문자/날짜 표준화 규칙 적용(트림/대문자화 등), `Sales Document Item`은 정수 변환 후 100배수 계산용 보조컬럼 준비 |
| 인덱스 전략  | 매칭 성능 확보      | `SalesDocument`, `Sales Document Item(100배)` 파생키에 대한 인덱스(또는 해시키) 구성             |
| 수명 주기   | 생성/사용/삭제      | 배치 시작 시 생성, 처리 완료 후 삭제(예외 발생 시에도 정리), 감사 목적의 요약 로그는 별도 영속 테이블에만 보관              |
| 유효성 검증  | 사전 검증 체크      | 필수 컬럼 존재/NULL 금지 규칙, 허용값 검증(`DS`, `OS`), 행 중복/키 충돌 조사, 데이터 범위 초과 방지             |

---

## 4. 상태 갱신 로직 설계(우선순위·충돌 처리)

| 작업명      | 개요         | 내용                                                                    |
| -------- | ---------- | --------------------------------------------------------------------- |
| 우선순위 규정  | 충돌 시 일관 처리 | 규칙 1(오더취소) > 규칙 2(DS=C 배송완료) > 규칙 3(OS=C 배송완료). 상위 규칙 충족 시 하위 규칙 미적용  |
| 키 매칭     | 매칭 정확도     | `ORDERNO = SalesDocument` AND `LINE_NO = Sales Document Item × 100`   |
| 동시 업데이트  | 두 테이블 동기화  | `O_SALESORDER`, `QMS_SALESORDER`에 동일 상태 반영, 갱신 실패 시 두 테이블 모두 동일 청크 롤백 |
| 부분 실패 처리 | 재시도/격리     | 청크별 재시도 1\~N회, 지속 실패는 실패 리포트로 이관 후 다음 청크 진행(전체 작업 지연 방지)              |
| 감사/추적    | 변경 이력      | 변경 전/후 상태 요약치 기록(누가/언제/무엇을), 파일 식별자와 배치 실행 ID 연계                      |

---

## 5. 진행률 표시(UX/성능 균형)

| 작업명       | 개요         | 내용                                                               |
| --------- | ---------- | ---------------------------------------------------------------- |
| 표시 단위     | 과도한 I/O 방지 | 전체 행 수 기준 퍼센트 진행률을 **청크 완료 시** 갱신(예: 1,000행 단위). 실시간 행 단위 갱신 금지  |
| 단계별 스테이지  | 사용자 인지 향상  | `파일검증 → 적재 → 사전검증 → 매핑/갱신 → 리포트 생성 → 정리` 단계별 상태/남은 예상 시간(대략치) 표기 |
| 백그라운드 작업화 | 화면 의존성 제거  | 업로드 후 서버 비동기 작업으로 전환, 화면은 폴링 또는 이벤트 기반으로 진행률 조회                  |
| 실패 노출     | 즉시 확인      | 임계 오류 발생 시 진행 중단 안내 및 오류 요약(파일명/행 범위/사유) 표시                      |

---

## 6. 실패 리포트 설계(테이블/화면)

| 작업명      | 개요       | 내용                                                                                                                                                  |
| -------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| 리포트 스키마  | 원인 분석 중심 | 필수 필드 예시(명칭만): 파일 ID, 업로드자, 업로드 일시, 행 번호, `SalesDocument`, `Sales Document Item`, 매칭 키(`ORDERNO`,`LINE_NO`), 실패 유형 코드, 실패 메시지, 발생 단계, 재시도 여부, 생성 일시 |
| 실패 유형 표준 | 분류 코드 체계 | 예: `MISSING_REQUIRED_COLUMN`, `DATA_TYPE_ERROR`, `KEY_NOT_FOUND`, `DUPLICATE_ROW`, `RULE_CONFLICT`, `DB_CONSTRAINT`, `TIMEOUT`, `UNKNOWN`           |
| 조회 화면    | 필터/내보내기  | 파일 ID/기간/유형별 필터, 페이징, 다운로드(엑셀/CSV)                                                                                                                  |
| 보존 정책    | 데이터 거버넌스 | 리포트 보존 기간 설정(예: 90일), 개인정보/민감정보 비저장 원칙                                                                                                              |

---

## 7. 성능·안정성 전략(대용량 13k+ 행 기준)

| 작업명      | 개요            | 내용                                                        |
| -------- | ------------- | --------------------------------------------------------- |
| 청크 처리    | 메모리/락 최소화     | 업로드 적재 후 \*\*청크 단위(예: 1k\~5k)\*\*로 검증·갱신·커밋. 테이블 락 시간을 단축 |
| 인덱스 활용   | 조인 비용 절감      | 임시테이블과 대상테이블 매칭 키에 인덱스 구성. 불필요 인덱스는 작업 시점에 한시적으로 유지       |
| 배치 창구    | 운영 시간대 조정     | 피크 타임 회피(야간/비업무 시간). 병행 배치와 스케줄 조정                        |
| 재시도/타임아웃 | 네트워크·DB 이슈 대응 | DB 타임아웃/교착 대비 재시도 정책과 백오프 적용                              |
| 리소스 모니터링 | 사전 경보         | DB 세션, 잠금 대기, 로그 증가량, 임시DB 사용량, CPU/메모리 지표 모니터링           |

---

## 8. 보안·컴플라이언스

| 작업명    | 개요     | 내용                                            |
| ------ | ------ | --------------------------------------------- |
| 입력 검증  | 파일 안전성 | 확장자 화이트리스트, 최대 용량 제한, 시그니처 점검, 다중 시트 차단/허용 정책 |
| 권한 제어  | 업로드 권한 | 역할 기반 접근(업로드/조회/승인 분리), 실패 리포트 열람 권한 제한       |
| 감사 로그  | 추적성    | 사용자/시간/파일/결과 건수/실패 건수 등 기록                    |
| 데이터 보호 | 민감정보   | 엑셀 내 민감정보 포함 금지 안내, 서버 저장 기간 최소화              |

---

## 9. 테스트 계획(개발·QA 공통)

| 작업명    | 개요       | 내용                                                 |
| ------ | -------- | -------------------------------------------------- |
| 단위 테스트 | 규칙/검증 로직 | 우선순위 규칙 1·2·3 및 충돌 케이스, 필수 컬럼 누락, 데이터 타입 오류, 키 미존재 |
| 통합 테스트 | E2E 흐름   | 업로드→임시 적재→검증→갱신→리포트→정리까지 전 단계 검증                   |
| 성능 테스트 | 대용량 시나리오 | 13k·50k 등 다양한 행 수, 가변 컬럼 수/순서, 인덱스 유무별 비교          |
| 회귀 테스트 | 기존 기능 영향 | 주문 조회/상태 통계/배치 리포트 등에 부작용 없는지 확인                   |
| 보안 테스트 | 권한/입력    | 비권한 사용자의 업로드 차단, 악성 파일 방지, 오류 메시지 정보 노출 점검         |

---

## 10. 배포 계획(운영)

| 작업명     | 개요      | 내용                                                 |
| ------- | ------- | -------------------------------------------------- |
| 배포 전 준비 | 승인·백업   | 변경 승인, 대상 테이블 백업 또는 시점복구 지점 설정, 설정값(청크 크기·타임아웃) 확인 |
| 무중단 전략  | 서비스 연속성 | 업로드 기능만 점진 배포 가능 시 세션 드레인, 재기동 창구 예약               |
| 설정 관리   | 환경 변수화  | 청크 크기/동시 작업 수/타임아웃/보존기간을 운영 프로파일로 분리 관리            |
| 검증 절차   | 연기 기준   | 헬스체크, 샘플 파일 업로드 스모크 테스트, 실패율/처리율 기준 만족 시 오픈        |

---

## 11. 운영 절차(정상 운영 시)

| 단계 | 작업명    | 개요      | 내용                                     |
| -- | ------ | ------- | -------------------------------------- |
| 1  | 업로드 수신 | 파일 등록   | 파일 메타 검증 후 작업 ID 발급, 비동기 큐 등록          |
| 2  | 임시 적재  | 스테이징 생성 | 헤더 기반 동적 스키마 생성, 벌크 적재, 필수 컬럼 점검       |
| 3  | 사전 검증  | 데이터 품질  | 키 중복·누락·허용값 점검, 실패건은 즉시 리포트 적재         |
| 4  | 매칭/갱신  | 상태 업데이트 | 우선순위(1>2>3) 규칙으로 두 테이블 동시 갱신, 청크 단위 커밋 |
| 5  | 리포트 생성 | 결과 공유   | 처리 요약(총/성공/실패), 실패 상세 저장 및 화면 제공       |
| 6  | 자원 정리  | 후처리     | 임시테이블·임시파일 삭제, 감사 로그 기록                |
| 7  | 모니터링   | 품질 보증   | 처리 시간/실패율/DB 리소스 대시보드 점검, 이상 시 알림      |

---

## 12. 예외·장애 대응

| 시나리오         | 감지 방법    | 즉시 조치                  | 후속 조치                   |
| ------------ | -------- | ---------------------- | ----------------------- |
| 필수 컬럼 누락     | 사전 검증 실패 | 작업 중단, 사용자에게 누락 컬럼 안내  | 리포트 기록, 재업로드 유도         |
| 키 미매칭 대량     | 실패율 급증   | 해당 청크 스킵 후 진행, 운영 알림   | 소스 데이터 품질 점검, 보정 가이드 배포 |
| DB 교착/타임아웃   | 모니터링 알림  | 재시도·백오프, 필요 시 배치 일시 중지 | 인덱스/락 원인 분석, 청크 크기 조정   |
| 실패 리포트 적재 실패 | 로그 경고    | 대체 저장(파일/큐)로 폴백        | 원인 해결 후 재적재             |

---

## 13. 롤백 전략

| 작업명       | 개요    | 내용                                 |
| --------- | ----- | ---------------------------------- |
| 데이터 롤백    | 상태 복구 | 변경 전 스냅샷·시점복구 활용, 배치 실행 ID 기준 되돌리기 |
| 애플리케이션 롤백 | 기능 복귀 | 이전 버전 아티팩트로 즉시 전환, 큐 적재 중단         |
| 부분 롤백     | 청크 단위 | 청크 실패분만 선택 복구, 성공분은 유지             |

---

## 14. 운영 지표(SLO)·보고

| 항목    | 목표 지표(예시)        | 설명                            |
| ----- | ---------------- | ----------------------------- |
| 처리 성능 | 13k 행 ≤ 5분(비피크)  | 임시 적재+검증+갱신+리포트 포함, 환경에 따라 조정 |
| 실패율   | ≤ 1% (데이터 오류 제외) | 시스템 오류 기준                     |
| 가용성   | 99.9%            | 업로드 기능                        |
| 가시성   | 100% 리포트 생성      | 모든 실패 사유 추적 가능                |

---

## 15. 책임 구분(R\&R)

| 역할 | 책임                             |
| -- | ------------------------------ |
| 개발 | 업로드/검증/갱신/리포트 로직 구현, 구성값 관리    |
| QA | 기능·성능·회귀 테스트, 시나리오 승인          |
| 운영 | 배포·모니터링·장애 대응, 백업/복구 관리, 권한 통제 |

---

## 16. 체크리스트

### 공통

* [ ] 변경 승인서 및 배포 일정 확정
* [ ] 운영 DB 백업/시점복구 지점 확보
* [ ] 권한 검증(업로드·임시·대상 테이블)
* [ ] 설정값 확정(청크/동시성/타임아웃/보존기간)

### 개발·QA

* [ ] 필수 컬럼 검증 로직 적용: `SalesDocument`, `Sales Document Item`, `Reason for rejection`, `DS`, `OS`
* [ ] `Sales Document Item × 100` 매칭 검증 테스트 완료
* [ ] 우선순위 규칙(1>2>3) 충돌 케이스 테스트 완료
* [ ] 대용량(≥13k) 파일 성능 테스트 및 리소스 프로파일링
* [ ] 실패 리포트 화면·필터·다운로드 검증

### 운영

* [ ] 피크 시간 회피 스케줄 반영
* [ ] 모니터링 대시보드 지표 확인(세션/락/CPU/로그 증가)
* [ ] 스모크 테스트(샘플 파일) 통과 후 오픈
* [ ] 장애·롤백 절차 리허설 결과 기록
* [ ] 임시테이블/파일 자동 정리 정책 확인

---

## 17. 용어·규칙 요약 표

| 키         | 의미                                                           |
| --------- | ------------------------------------------------------------ |
| 매칭 키      | `ORDERNO=SalesDocument`, `LINE_NO=Sales Document Item × 100` |
| 규칙 1(최우선) | `Reason for rejection` ≠ Null → `오더취소`                       |
| 규칙 2      | `DS='C'` → `배송완료`                                            |
| 규칙 3      | `DS` Null AND `OS='C'` → `배송완료`                              |
| 동시 반영     | `O_SALESORDER`와 `QMS_SALESORDER` 동일 갱신                       |
| 실패 리포트    | 키값·행번호·유형코드·메시지·단계·재시도 여부 포함                                 |

---

이 문서의 순서대로 진행하면, **가변 스키마 엑셀**과 **대용량 처리**, **우선순위 충돌 규칙**을 안전하게 적용하면서도 **진행률 가시성**과 **실패 리포트 추적성**을 보장할 수 있습니다.
