# 운영 반영 작업 흐름 문서

**대상:** Java(Spring) + Tomcat 9.0.99 + MSSQL 2019 운영 환경
**주요 목적:** 엑셀 업로드를 통해 O\_SALESORDER, QMS\_SALESORDER를 동일 규칙으로 대량 업데이트하고, 진행률 표시 및 실패 리포트를 제공

---

## 0. 전체 흐름 개요

| 단계 | 작업명               | 산출물/결과                   |
| -- | ----------------- | ------------------------ |
| 1  | 사전 준비 및 점검        | 배포/롤백 계획, 권한·용량 점검 체크리스트 |
| 2  | 업로드 규칙 정의 및 검증 설계 | 파일 검증 기준, 필수 컬럼 검증 항목    |
| 3  | 스테이징(임시) 저장소 설계   | 스키마 설계안(가변 컬럼 대응 포함)     |
| 4  | 업로드 처리 흐름 설계      | 비동기 처리·진행률 설계, 오류 처리 흐름  |
| 5  | 매핑/업데이트 규칙 확정     | 매핑표, 상태 결정 우선순위표         |
| 6  | 성능·잠금·트랜잭션 전략     | 배치 단위·인덱스·트랜잭션 경계 정의     |
| 7  | 실패 리포팅 설계         | 실패 저장 구조, 화면 리포트 스펙      |
| 8  | QA 시나리오 및 데이터 준비  | 테스트 케이스·임계치 시나리오         |
| 9  | 배포 및 점검           | 릴리스 절차, 모니터링 플랜          |
| 10 | 운영 운영(모니터링/운영지침)  | 운영 모니터링 항목, 재처리 가이드      |

---

## 1. 사전 준비 및 점검

### 1.1 작업명

운영 환경 점검 및 배포/롤백 계획 수립

### 1.2 개요

대량 업데이트·비동기 처리 특성상 실패 시 영향 최소화를 위해 권한, 용량, 롤백 경로를 선확정.

### 1.3 내용

* **권한/계정**: 애플리케이션 계정의 대상 테이블(읽기/쓰기), 스테이징 저장소 생성/삭제 권한 확인
* **용량/리소스**: 데이터·로그 파일 여유 공간, TempDB 여유 공간, 인덱스 재구성 윈도우 점검
* **점검 항목 체크리스트**

  * [ ] 운영 배치 시간대 합의(저부하 시간)
  * [ ] DB 백업/스냅샷 시점 확정
  * [ ] 애플리케이션 타임아웃 설정 확인
  * [ ] 동시 사용자 트래픽 예측 및 스로틀링 정책 합의
* **롤백 계획**: 업데이트 전 스냅샷/백업 기준, 실패 건 재처리 절차, 장애 알림 채널

---

## 2. 업로드 규칙 정의 및 검증 설계

### 2.1 작업명

엑셀 파일 규격 정의 및 사전 검증 기준 수립

### 2.2 개요

파일 간 컬럼 수·순서가 다름. 필수 컬럼 존재성, 허용 범위, 데이터형·정합성 검사 필요.

### 2.3 내용

* **필수 컬럼(반드시 존재)**

  * SalesDocument
  * Sales Document Item
  * Reason for rejection
  * DS (Delivery status)
  * OS (Overall status)
* **유연성 요구사항**

  * 필수 외 컬럼은 파일마다 다를 수 있음(컬럼 수·순서 가변)
* **사전 검증 항목**

  * [ ] 필수 컬럼 존재 여부
  * [ ] 행 수 임계치 경고(≥ 13,000행)
  * [ ] 공란/누락/이상값(예: 수치형이 아닌 값)
  * [ ] 중복 키(Row) 탐지 정책
  * [ ] 파일 크기 제한 및 시트 수 제한 정책
* **검증 결과 처리**

  * 경고/오류 구분, 오류는 적재 중단 및 리포트 제공
  * 경고는 적재 허용하되 리포트에 명시

---

## 3. 스테이징(임시) 저장소 설계

### 3.1 작업명

가변 컬럼·순서 대응 가능한 스테이징 저장소 설계

### 3.2 개요

모든 행을 먼저 스테이징에 적재 후, 스테이징→본 테이블 집합 연산으로 업데이트. 파일 가변성을 수용.

### 3.3 내용

* **설계 옵션 비교**

| 옵션             | 개요                                         | 장점              | 고려사항                       |
| -------------- | ------------------------------------------ | --------------- | -------------------------- |
| A. 동적 컬럼 스테이징  | 업로드 파일 컬럼 구조를 반영해 스키마를 동적으로 구성             | 조회·비교 단순, 성능 우수 | 스키마 관리 복잡, 자주 변하는 컬럼 대응 비용 |
| B. 표준+확장 혼합    | 표준 키/필수 컬럼은 고정, 나머지는 확장 컬럼(키-값) 또는 메타 JSON | 가변성 흡수, 유지보수 유리 | 확장부 조인·파싱 비용               |
| C. 광폭 문자열 스테이징 | 모든 컬럼을 범용 문자열 슬롯에 맵핑(컬럼명 메타 별도 저장)         | 구현 단순, 파일 편차 내성 | 후처리 변환 비용, 타입 검증 약함        |

* **권장안**

  * 표준 키/필수 5개 컬럼은 고정 필드로 구성
  * 추가 컬럼은 확장 메타로 보관(컬럼명/값 페어)
  * 컬럼 맵핑 메타를 별도로 저장하여 재처리·리포트에 활용

* **필수 보관 항목**

  * 업로드 배치 ID, 업로더, 업로드 시간
  * 원본 파일명/시트/행 번호
  * 표준 컬럼 값
  * 추가 컬럼 메타(선택)
  * 검증 결과(경고/오류 코드)

---

## 4. 업로드 처리 흐름 설계

### 4.1 작업명

비동기 업로드·진행률 표시 설계

### 4.2 개요

대용량(≥13,000행) 대응을 위해 업로드 즉시 비동기 큐로 위임, 화면은 진행률을 폴링/푸시로 갱신.

### 4.3 내용

* **프로세스 단계 정의**

| 단계 | 설명                     | 진행률 반영     |
| -- | ---------------------- | ---------- |
| 수신 | 파일 업로드 수신/등록, 배치 ID 발급 | 0% → 5%    |
| 검증 | 형식/필수 컬럼/데이터형/중복 검사    | 5% → 20%   |
| 적재 | 스테이징 삽입(일괄 처리)         | 20% → 60%  |
| 매핑 | 키 매핑 및 대상 로우 매칭 통계 산출  | 60% → 75%  |
| 갱신 | 본 테이블 집합 업데이트(배치 단위)   | 75% → 95%  |
| 정리 | 인덱스/통계 리프레시, 리포트 생성    | 95% → 100% |

* **진행률 표시에 대한 성능 고려**

  * 상태 저장은 최소화(배치 단위 완료 시 점진 저장)
  * 상세 건수 카운트는 오버헤드 낮은 방식으로 집계
  * 폴링 간격/푸시 빈도 제한(서버 부하 관리)

---

## 5. 매핑/업데이트 규칙 확정

### 5.1 작업명

키 매핑 규칙 및 상태 결정 우선순위 명세

### 5.2 개요

엑셀의 SalesDocument + (Sales Document Item × 100)을 DB의 ORDERNO + LINE\_NO에 매칭.

### 5.3 내용

* **키 매핑 규칙**

  * 매칭 키:

    * ORDERNO ⇔ SalesDocument
    * LINE\_NO ⇔ Sales Document Item × 100  (DB의 LINE\_NO = 엑셀의 Item × 100)
* **대상 테이블**

  * O\_SALESORDER, QMS\_SALESORDER (두 테이블 동일 규칙 적용)
* **상태 결정 규칙(우선순위 포함)**

| 우선 | 판정 조건(엑셀)                   | 대상 ORDER 업데이트 값                            |
| -- | --------------------------- | ------------------------------------------ |
| 1  | Reason for rejection ≠ Null | STATUS1=980, STATUS=999, STATUS\_DESC=오더취소 |
| 2  | DS = 'C'                    | STATUS1=580, STATUS=620, STATUS\_DESC=배송완료 |
| 3  | DS is Null AND OS = 'C'     | STATUS1=580, STATUS=620, STATUS\_DESC=배송완료 |

* **중복 충돌 시 처리**

  * 1번 규칙 최우선, 다음으로 2번, 마지막 3번 적용
  * 동일 키 중복 행이 있을 경우 최신 행 기준 또는 정책에 따른 우선행 선택(정책 문서화)

---

## 6. 성능·잠금·트랜잭션 전략

### 6.1 작업명

대량 업데이트 성능 및 안정성 확보

### 6.2 개요

스테이징→본 테이블의 집합 업데이트, 배치 단위 커밋, 인덱스/잠금 영향 최소화.

### 6.3 내용

* **배치 전략**

  * 배치 크기 정의(예: N천 행 단위)
  * 배치별 트랜잭션 경계 설정(부분 커밋 허용)
  * 실패 배치 재시도/스킵 정책
* **인덱스·통계**

  * 매칭 키(ORDERNO, LINE\_NO), 상태 컬럼 관련 인덱스 현황 점검
  * 대량 갱신 후 통계 업데이트/인덱스 유지보수 윈도우 확보
* **잠금/경합**

  * 운영 트래픽과의 경합 시간 최소화(저부하 시간 수행)
  * 읽기 락 최소화, 쓰기 잠금 지속시간 단축(배치/집합 갱신)
  * 테이블 단위보다는 키 범위 단위 처리
* **에러/부분 실패 허용**

  * 배치별 롤백 후 다음 배치 진행(전체 중단 방지)
  * 실패 건은 리포트 테이블에 저장하여 재처리 가능

---

## 7. 실패 리포팅 설계

### 7.1 작업명

실패 저장 구조 및 화면 리포트 명세

### 7.2 개요

실패 건 키값과 실패 사유를 사용자에게 제공하고, 반복 업로드 없이 재처리 가능하도록 저장.

### 7.3 내용

* **리포트 저장 필드(예시 스펙)**

| 구분 | 필드                  | 설명                     |
| -- | ------------------- | ---------------------- |
| 식별 | 배치 ID               | 업로드 세션 식별              |
| 식별 | 행 번호                | 원본 엑셀 행 번호             |
| 키  | SalesDocument       | 원본 키                   |
| 키  | Sales Document Item | 원본 키(×100 전 값)         |
| 키  | ORDERNO             | 매핑 결과                  |
| 키  | LINE\_NO            | 매핑 결과                  |
| 결과 | 실패 코드               | 표준화된 코드(검증/매핑/갱신/잠금 등) |
| 결과 | 실패 사유               | 상세 메시지                 |
| 결과 | 재시도 가능 여부           | Y/N                    |
| 메타 | 업로드자/일시             | 이력 추적                  |

* **화면 리포트 요구사항**

  * 필터(실패 코드, 키, 배치 ID), 정렬, 페이징
  * CSV/엑셀 다운로드
  * 재처리 대상 선택/요청 기능(선택 사항)

---

## 8. QA 시나리오 및 데이터 준비

### 8.1 작업명

테스트 케이스 정의 및 임계 상황 검증

### 8.2 개요

다양한 파일 변형·대량 데이터·경합 상황에서의 정확성과 성능을 검증.

### 8.3 내용

* **정합성 케이스**

  * [ ] 필수 컬럼 누락 파일 거부
  * [ ] Sales Document Item × 100 매핑 정확성
  * [ ] 우선순위 충돌 시 1→2→3 적용 검증
  * [ ] 중복 키 행 처리 정책 검증(최신 우선 등)
* **성능/대량**

  * [ ] 13,000행 이상 파일 처리 시간/진행률 정확도
  * [ ] 배치 크기 변화에 따른 영향 분석
  * [ ] 동시 업로드(동시 배치) 경합 테스트
* **복구/장애**

  * [ ] 배치 중간 실패 시 부분 롤백 후 재개
  * [ ] 리포트 기반 재처리 성공률 검증
  * [ ] DB 장애/네트워크 장애 시 알림·재시도 동작
* **보안**

  * [ ] 권한 없는 사용자 업로드 차단
  * [ ] 민감 정보 로그 마스킹

---

## 9. 배포 및 점검

### 9.1 작업명

릴리스 절차 및 안정화 점검

### 9.2 개요

운영 반영 후 초기 배치 모니터링 및 성능·오류 지표 확인.

### 9.3 내용

* **배포 체크리스트**

  * [ ] 배포 대상 아티팩트·환경 변수 목록화
  * [ ] DB 스키마(스테이징/리포트 저장소) 반영 순서
  * [ ] 애플리케이션 설정(업로드 크기/시간/큐 설정) 적용
  * [ ] 롤백 스크립트/절차 준비
* **안정화 모니터링(초기 24\~48시간)**

  * [ ] 평균/최대 처리 시간
  * [ ] 실패율·실패 코드 상위 Top N
  * [ ] DB 잠금 대기/Deadlock 지표
  * [ ] 리소스 사용률(CPU/메모리/IO/TempDB)

---

## 10. 운영 운영(모니터링/운영지침)

### 10.1 작업명

일상 운영 절차 및 지표 관리

### 10.2 개요

운영자가 일상적으로 점검할 항목과 이상 대응 절차를 정의.

### 10.3 내용

* **일상 점검표**

  * [ ] 전일 업로드 배치 수/성공률
  * [ ] 실패 코드 Top N 및 재처리 진행률
  * [ ] 스토리지·로그 성장량
  * [ ] 인덱스 조각화/통계 최신성
* **이상 대응**

  * 진행률 장시간 정체 시: 해당 배치 상세 로그 확인 → 문제 배치 중지/재시도 → 리소스 병목 해소
  * 실패 급증 시: 최신 파일 규격 변경 여부 확인 → 검증 규칙 업데이트
  * 잠금 경합 증가 시: 배치 크기 축소 또는 시간대 조정

---

## 부록 A. 화면/UX 요구사항 요약

| 영역      | 요구사항                                 |
| ------- | ------------------------------------ |
| 업로드 시작  | 파일 선택 즉시 업로드 등록, 배치 ID 표시            |
| 진행률 표시  | 단계별 퍼센트/남은 건수, 현재 단계 명시              |
| 결과 리포트  | 성공/실패 건수 요약, 실패 목록 테이블 제공            |
| 필터/검색   | 배치 ID, 키값(SalesDocument/Item), 실패 코드 |
| 내보내기    | 실패 목록 다운로드(CSV/엑셀)                   |
| 재처리(선택) | 체크박스 선택 후 재처리 요청, 결과 반영              |

---

## 부록 B. 로그/감사 항목

| 구분  | 항목                        | 목적       |
| --- | ------------------------- | -------- |
| 배치  | 배치 ID, 시작/종료 시각, 단계별 소요시간 | 성능/장애 추적 |
| 데이터 | 총 행수, 적재 행수, 매핑 성공/실패 수   | 품질 지표    |
| 오류  | 실패 코드/사유, 예외 스택 요약        | 원인 분석    |
| 운영  | 재처리 요청자/시각/건수, 결과         | 감사 추적    |

---

## 부록 C. SLA·운영 지표(예시)

| 지표            | 목표                   |
| ------------- | -------------------- |
| 파일 검증 시작 지연   | 업로드 즉시 ≤ 5초          |
| 20,000행 처리 시간 | ≤ 운영 합의 시간 내(저부하 기준) |
| 실패율           | ≤ 1% (데이터 품질 이슈 제외)  |
| 재처리 성공률       | ≥ 99%                |
| Deadlock 건수   | 0건 유지                |

---

## 부록 D. 위험요인 및 대응

| 위험        | 설명              | 대응                         |
| --------- | --------------- | -------------------------- |
| 파일 규격 변동  | 필수 컬럼 명칭/의미 변경  | 검증 규칙 버전 관리, 오류 리포트로 즉시 감지 |
| 대량 잠금     | 피크 시간대 대량 갱신    | 저부하 실행, 배치 크기 조정, 인덱스 최적화  |
| 중복/충돌 데이터 | 동일 키 중복 행 상이한 값 | 우선순위/최신 기준 정책 명시, 충돌 리포트   |
| 리소스 부족    | TempDB/로그 파일 급증 | 사전 용량 확보, 자동 성장 정책 점검      |
| 오탑재       | 잘못된 파일 업로드      | 검증 강제화, 사전 미리보기·요약 경고      |

---

## 부록 E. 역할·책임(RACI)

| 작업            | 개발 | QA | 운영 |
| ------------- | -- | -- | -- |
| 스테이징/리포트 설계   | R  | C  | I  |
| 검증/매핑 로직 설계   | R  | C  | I  |
| 성능/잠금 전략 수립   | R  | C  | C  |
| 테스트 케이스 작성/수행 | C  | R  | C  |
| 배포/롤백 실행      | C  | I  | R  |
| 모니터링/재처리 운영   | I  | C  | R  |

---

## 최종 체크리스트

* [ ] 필수 컬럼 검증 로직 반영(부족 시 업로드 거부)
* [ ] 스테이징 저장소 설계(표준+확장) 확정 및 운영 반영
* [ ] 매핑·상태 결정 우선순위(1→2→3) 테스트 통과
* [ ] 배치 크기/트랜잭션 경계/재시도 정책 문서화
* [ ] 진행률 단계·계산 로직과 오버헤드 검증
* [ ] 실패 리포트 저장·화면 제공·다운로드 확인
* [ ] 모니터링 지표/알림/장애 대응 플레이북 마련
* [ ] 배포 전 백업/스냅샷 확보 및 롤백 경로 검증
* [ ] 초기 운영 48시간 집중 모니터링 계획 수립

---

**문서 종료**
