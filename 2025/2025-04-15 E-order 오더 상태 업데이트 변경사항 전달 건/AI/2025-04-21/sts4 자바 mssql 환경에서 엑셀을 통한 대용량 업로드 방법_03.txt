

sts4, java, mssql í™˜ê²½ì—ì„œ Dropzoneì„ ì´ìš©í•˜ì—¬ ì—‘ì…€ ì—…ë¡œë“œë¥¼ í•˜ê³ , SqlSessionì„ ì´ìš©í•œ ëŒ€ìš©ëŸ‰ ì—‘ì…€ ì—…ë¡œë“œ ì‘ì—… ë°©ë²• ìì„¸í•˜ê³  ì•Œê¸°ì‰½ê²Œ ì•Œë ¤ì¤˜.
ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•˜ëŠ” ì—‘ì…€íŒŒì¼ì€ ì œëª©ì˜ ê°œìˆ˜ëŠ” ê°™ì§€ ì•Šì„ ìˆ˜ ìˆê³ , ê°™ì€ ì´ë¦„ì˜ ì œëª© ìœ„ì¹˜ë„ ì„œë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ì œëª©ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼í•˜ëŠ” ì´ë¦„ì€ ìˆì–´.
ì—‘ì…€íŒŒì¼ì—ì„œ ì œëª© ì…€ ì¤‘ì—ì„œ ë‚´ê°€ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ì…€ì€ Sales Document Type	Purchase order no.	Reason for rejection	Sales Document	Sales Document Item	Delivery status	Overall status ë§Œ í•„ìš”í•´. ì´ ì…€ë“¤ë„ ì—‘ì…€íŒŒì¼ì˜ í—¤ë”ì˜ ì…€ ìˆœì„œê°€ ì •í•´ì ¸ ìˆì§€ê°€ ì•Šì•„ì„œ í•„ìš”í•œ ì…€ì„ ì°¾ì•„ì•¼ë§Œ í•´.
ì•„ë˜ëŠ” ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•˜ëŠ” ì—‘ì…€íŒŒì¼ì˜ ì œëª©ì˜ ì˜ˆì œì•¼. ìœ„ì—ì„œ ì„¤ëª…í•œ ì‘ì—…ì— í•„ìš”í•œ ì»¬ëŸ¼ê³¼ ì•„ë˜ì˜ ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•˜ëŠ” ì—‘ì„¸íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ì‘ì—…í•´ì¤˜. ë‹¤ë§Œ, ì œëª©ì˜ ê°œìˆ˜ë‚˜, ìœ„ì¹˜ëŠ” ì„œë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì—¼ë‘ì— ë‘ê³  ì‘ì—…í•´ì¤˜
Sales Document	Sales Document Item	Created On	Document Date	Time	Created By	Sales Document Type	Sales Organization	Billing block	Billing block description	Purchase order no.	Customer	Country SoldToParty	Search term A	Search term B	Customer group 3	Ship-to	Ship-To Party	Ship-to Country	Region Ship-to	Country ShipToParty	Order reason	Order reason	Delivery block	Delivery block	Shipping Conditions	Requested deliv.date	Loading Date	Arrival time	Delivery status	Overall status	Item Category	Reason for rejection	Reason for rejection	Material	Material Description	Order Quantity	Cumul.confirmed qty	Sales Unit	Total quantity	Allocation Unit	Quantity allocated	Allocation Plant	Allocation Ext. Material Group	Allocation Sub-Segment	Allocation Segment	Difference quantity	Difference in %	Allocation period	Pricing Date	Net Value	Document Currency	Plant	Storage Location	Quotation number	ABC Indicator	Main material group	Name	Name 2	Name 3	Name 4	City	Postal Code	Street	House Number	Search Term 1	Search Term 2	Delivery	Delivery item	Shipment Number	Invoice	Invoice item	IC invoice	Item IC invoice	Gross Weight	Net Weight	Weight Unit	Gross Weight US	Net Weight US	Weight unit US	Predecessr	Special proc. indicator	Payer	Freight forwarder	Truck load %	Partial truck load %		Shipping Point/Receiving Pt	Pricing Ref. Matl	Distribution Channel	Name 1	Overall CreditStatus	Ext. Material Group	Ext. matl grp descr.	Subseg.	Subseg. Descr.	Seg.	Seg. Descr.	Pricing Partner


í•´ë‹¹ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ DBì— UPDATEë¥¼ í•´ì•¼í•˜ëŠ” Tableì€ O_SALESORDER, QMS_SALESORDER í…Œì´ë¸”ì´ì•¼.
ì•„ë˜ëŠ” ì—‘ì…€ì— ìˆëŠ” ê°’ì— ë”°ë¼ updateë¥¼ í•´ì•¼í•˜ëŠ” í…Œì´ë¸”ê³¼ ì»¬ëŸ¼ëª…, ê·¸ë¦¬ê³  í•´ë‹¬ ì»¬ëŸ¼ì˜ ê°’ì´ì•¼.
    1. SalesDocument, Sales Document Item*100ë¥¼ ANDì¡°ê±´ìœ¼ë¡œ í™œìš©í•˜ì—¬ O_SALESORDER, QMS_SALESORDER í…Œì´ë¸”ì—ì„œ ORDERNO, LINE_NOì™€ ë§¤ì¹­ë˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì•„ì•¼ í•¨
    2. ë§¤ì¹­í•œ ê°’ì˜ Reason for rejection ê°’ ì—¬ë¶€ ,DS(Delivery status), OS(Overall status)ì˜ ê°’ì— ë”°ë¼ E-orderì—ì„œ ORDERì˜ ìƒíƒœ ê°’ UPDATE					
        i. Reason for rejection Codeê°€ Nullì´ ì•„ë‹Œ ê²½ìš°					
		    A. í•´ë‹¹ ORDERì˜ STATUS1 â€“ 980, STATUS â€“ 999, STATUS_DESC â€“ ì˜¤ë”ì·¨ì†Œ			
        ii. DSê°€ Cì¸ ê²½ìš°					
		    A. í•´ë‹¹ ORDERì˜ STATUS1 â€“ 580, STATUS â€“ 620, STATUTS_DESC â€“ ë°°ì†¡ì™„ë£Œ			
        iii. DSê°€ Null And OSê°€ Cì¸ ê²½ìš°					
		    A. í•´ë‹¹ ORDERì˜ STATUS â€“ 580, STATUS â€“ 620, STATUS_DESC â€“ ë°°ì†¡ì™„ë£Œ			


ì°¸ê³  ì‚¼ì•„ O_SALESORDER í…Œì´ë¸”ì˜ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ì•„.

CREATE TABLE EORDER.dbo.O_SALESORDER (
	ORDERNO bigint NOT NULL,
	ORDERTY varchar(4) COLLATE Korean_Wansung_CI_AS NOT NULL,
	LINE_NO bigint NOT NULL,
	ORDER_DT varchar(8) COLLATE Korean_Wansung_CI_AS NULL,
	REQUEST_DT varchar(8) COLLATE Korean_Wansung_CI_AS NULL,
	ACTUAL_SHIP_DT varchar(8) COLLATE Korean_Wansung_CI_AS NULL,
	CUST_NM varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPTO_NM varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	ADD1 varchar(180) COLLATE Korean_Wansung_CI_AS NULL,
	ADD2 varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	ADD4 varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	ZIP_CD varchar(12) COLLATE Korean_Wansung_CI_AS NULL,
	COMPANY varchar(5) COLLATE Korean_Wansung_CI_AS NULL,
	PLANT_CD varchar(12) COLLATE Korean_Wansung_CI_AS NULL,
	PLANT_DESC varchar(60) COLLATE Korean_Wansung_CI_AS NULL,
	ITEM_CD varchar(25) COLLATE Korean_Wansung_CI_AS NULL,
	ITEM_DESC varchar(60) COLLATE Korean_Wansung_CI_AS NULL,
	ORDER_QTY bigint NULL,
	UNIT varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	PRIMARY_QTY bigint NULL,
	UNIT1 varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	SECOND_QTY bigint NULL,
	UNIT2 varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	WEIGHT float NULL,
	WEIGHT_UNIT varchar(2) COLLATE Korean_Wansung_CI_AS NULL,
	PRICE bigint NULL,
	AMOUNT bigint NULL,
	STATUS1 varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	STATUS2 varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	STATUS_DESC varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	DRIVER_PHONE varchar(40) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPMENT_CD_SAP varchar(15) COLLATE Korean_Wansung_CI_AS NULL,
	CUST_PO varchar(70) COLLATE Korean_Wansung_CI_AS NULL,
	ORDER_TAKER varchar(12) COLLATE Korean_Wansung_CI_AS NULL,
	HOLD_CODE varchar(2) COLLATE Korean_Wansung_CI_AS NULL,
	SALESREP_CD bigint NULL,
	TRUCK_NO varchar(20) COLLATE Korean_Wansung_CI_AS NULL,
	SALESREP_NM varchar(40) COLLATE Korean_Wansung_CI_AS NULL,
	TEAM_CD varchar(10) COLLATE Korean_Wansung_CI_AS NULL,
	TEAM_NM varchar(40) COLLATE Korean_Wansung_CI_AS NULL,
	BUILDING_TYPE varchar(3) COLLATE Korean_Wansung_CI_AS NULL,
	INSERT_DT varchar(20) COLLATE Korean_Wansung_CI_AS NULL,
	TRANS_TY varchar(2) COLLATE Korean_Wansung_CI_AS NULL,
	RECEIVER varchar(40) COLLATE Korean_Wansung_CI_AS NULL,
	DUMMY varchar(30) COLLATE Korean_Wansung_CI_AS NULL,
	ADD3 varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	REQUEST_TIME varchar(4) COLLATE Korean_Wansung_CI_AS NULL,
	LIFNR_NAME1 varchar(35) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPMENT_CD_3PL varchar(15) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPMENT_CD varchar(15) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPTO_CD varchar(10) COLLATE Korean_Wansung_CI_AS NULL,
	CUST_CD varchar(10) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPTO_NM2 varchar(80) COLLATE Korean_Wansung_CI_AS NULL,
	INVOICE_FLAG varchar(1) COLLATE Korean_Wansung_CI_AS NULL,
	SHIPPING_FLAG varchar(1) COLLATE Korean_Wansung_CI_AS NULL,
	DELIVERY_NO varchar(15) COLLATE Korean_Wansung_CI_AS NULL,
	DELIVERY_SEC_NO varchar(4) COLLATE Korean_Wansung_CI_AS NULL,
	LOTN varchar(20) COLLATE Korean_Wansung_CI_AS NULL,
	CONSTRAINT SYS_C005844 PRIMARY KEY (ORDERNO,ORDERTY,LINE_NO)
);


ì•„ë˜ì˜ ì†ŒìŠ¤ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ í•„ìš”í•˜ë©´ ì†ŒìŠ¤ì˜ ë‚´ìš©ì„ ì‚­ì œí•˜ê±°ë‚˜ ìˆ˜ì • ë° ì¶”ê°€í•´ë„ ê´œì°®ê³ , ë¬´ì‹œí•˜ê³  ìƒˆë¡­ê²Œ ë§Œë“¤ì–´ë„ ê´œì°®ì•„.


jsp íŒŒì¼

<%@page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/admin/commonimport.jsp" %>
<!DOCTYPE html>
<html>
<head>
<%@ include file="/WEB-INF/views/include/admin/commonhead.jsp" %>

< script src="${url}/include/js/common/dropzone/dropzone.min.js">< / script >
<link href="${url}/include/js/common/dropzone/dropzone.min.css" rel="stylesheet" type="text/css" />

< script type="text/javascript">

$(function(){

});

//Dropzone
Dropzone.autoDiscover = false;

$(document).ready(function() {
	$("#frm").dropzone({
		url: "./updateOrderStateExcelAjax.lime",
		maxFiles: 1,
		acceptedFiles: ".xls,.XLS,.xlsx,.XLSX,.csv,.CSV",
		maxFilesize: 30,

		init: function() {
			// maxFiles ì¹´ìš´í„°ë¥¼ ì´ˆê³¼í•˜ë©´ ê²½ê³ ì°½
			this.on("maxfilesexceeded", function(data) {
				$('#ajax_indicator').fadeOut();

				this.removeFile(data);
				alert('ìµœëŒ€ ì—…ë¡œë“œ íŒŒì¼ ìˆ˜ëŠ” 1ê°œ ì…ë‹ˆë‹¤.');
			});

			// ë“±ë¡ì‹œ ë°”ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì»¨íŒì°½
			this.on("addedfile", function(data) {
				$('#ajax_indicator').show().fadeIn('fast');

				if (!confirm('í’ˆëª© ì¼ê´„ ë“±ë¡ì„ ì§„í–‰ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
					$('#ajax_indicator').fadeOut();
					this.removeFile(data);
				}
			});

			// ì„±ê³µì‹œ
			this.on("success", function(data, response) {
				var result;
				var json = response;

				if('object' === typeof json) result = json;
				else result = JSON.parse(json);

				var resCode = result.RES_CODE;
				var resMsg = result.RES_MSG;

				$('#resultContentPId').empty();
				$('#resultContentPId').show();
				// if('0000' != resCode) $('#resultContentPId').append('ERROR MASSAGE<br />');
				if('0000' != resCode) $('#resultContentPId').append('MASSAGE<br />');
				$('#resultContentPId').append('<span>'+resMsg+'</span>');

				$('#ajax_indicator').fadeOut();
				this.removeFile(data);
			});

			// ì—ëŸ¬ì‹œ
			this.on("error", function(data, response, xhr) {
				console.log('data = '+data);
			    $('#resultContentPId').show();
				$('#resultContentPId').html('ERROR');


				$('#ajax_indicator').fadeOut();
				this.removeFile(data);
			});
		},
	});
});


//ìƒ˜í”ŒíŒŒì¼ë‹¤ìš´ë¡œë“œ
function fileDown(obj, file_type){ // file_type 1=í’ˆëª©ì½”ë“œ ë‹¤ìš´ë¡œë“œ, 2=ìƒ˜í”ŒíŒŒì¼ ë‹¤ìš´ë¡œë“œ.
	var fileFormHtml = '';

	if('1' == file_type){
		$('#ajax_indicator').show().fadeIn('fast');
		var token = getFileToken('excel');
		$('form[name="frm_excel"]').append('<input type="hidden" name="filetoken" value="'+token+'" />');

		formPostSubmit('frm_excel', '${url}/admin/item/itemExcelDown2.lime');
		$('form[name="frm_excel"]').attr('action', '');

		$('input[name="filetoken"]').remove();
		var fileTimer = setInterval(function() {
			//console.log('token : ', token);
	        console.log("cookie : ", getCookie(token));
			if('true' == getCookie(token)){
				$('#ajax_indicator').fadeOut();
				delCookie(token);
				clearInterval(fileTimer);
			}
	    }, 1000 );
	}
	else if('2' == file_type){
		// íŒŒì¼ ë‹¤ìš´ë¡œë“œ.
		fileFormHtml += '<form name="frm_filedown" method="post" action="${url}/admin/base/sampleFileDown.lime">';
		fileFormHtml += '	<input type="hidden" name="r_filename" value="orderStateUpdateSample.csv" />';
		fileFormHtml += '</form>';
		fileFormHtml += '<iframe name="fileDownLoadIf" style="display:none;"></iframe>';
		$.download('frm_filedown', fileFormHtml); // common.js ìœ„ì¹˜.
	}

}


< / script >
</head>

<body class="page-header-fixed compact-menu">
	<div id="ajax_indicator" style="display:none;">
	    <p style="position: absolute; top: 50%; left: 50%; margin: -110px 0 0 -110px;">
	        <img src="${url}/include/images/common/loadingbar.gif" />
	    </p>
	</div>

	<!-- Page Content -->
	<main class="page-content content-wrap">

		<%@ include file="/WEB-INF/views/include/admin/header.jsp" %>
		<%@ include file="/WEB-INF/views/include/admin/left.jsp" %>

		<form name="frm_excel" method="post"></form>

		<!-- Page Inner -->
		<div class="page-inner">
			<div class="page-title">
				<h3>
					ì˜¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸
					<div class="page-right">
						<button type="button" class="btn btn-line f-black" title="ëª©ë¡" onclick="location.href ='${url}/admin/order/salesOrderList.lime'"><i class="fa fa-list-ul"></i><em>ëª©ë¡</em></button>
					</div>
				</h3>
			</div>

			<!-- Main Wrapper -->
			<div id="main-wrapper">
				<!-- Row -->
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-white">
							<div class="panel-body">
								<h5 class="table-title no-title"></h5>
								<div class="btnList writeObjectClass">
									<button type="button" class="btn btn-warning" onclick="fileDown(this, '2');">ì˜¤ë” ìƒíƒœ ë‹¤ìš´ë¡œë“œ</button>
								</div>

								<form class="dropzone pull-left full-width" name="frm" id="frm" enctype="multipart/form-data">
									<div class="fallback">
										<input type="file" class="dropify" />
										<input type="button" class="dropify-btn btn-github hide" value="íŒŒì¼ì—…ë¡œë“œ" onclick="fileUpload();" /> <!-- IE9 -->
									</div>
								</form>

								<p class="dropzone-white pull-left m-t-lg full-width" id="resultContentPId" style="display: none;">
									<!--
									INSERT MASSAGE<br />
									<span>success</span>
									 -->
								</p>
							</div>
						</div>
					</div>
				</div>
				<!-- //Row -->
			</div>
			<!-- //Main Wrapper -->

			<%@ include file="/WEB-INF/views/include/admin/footer.jsp" %>

		</div>
		<!-- //Page Inner -->
	</main>
	<!-- //Page Content -->

</body>

</html>





-> OrderCtrl.java

	/**
	 * 2025-03-28 hsg Sunset Flip
	 * ì£¼ë¬¸ê´€ë¦¬ > ì˜¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸ : ì—‘ì…€ëŒ€ëŸ‰ìˆ˜ì • í¼.
	 * @ì‘ì„±ì¼ : 2025. 3. 28.
	 * @ì‘ì„±ì : hsg
	 */
	@GetMapping(value="orderStateUpdateExcel")
	public String itemEditExcel(@RequestParam Map<String, Object> params, HttpServletRequest req, HttpServletResponse res, LoginDto loginDto, Model model) throws Exception {
		return "admin/order/orderStateUpdateExcel";
	}

	/**
	 * 2025-03-28 hsg Sunset Flip
	 * ì˜¤ë” ìƒíƒœ ì—‘ì…€ ìˆ˜ì • í¼ > ì—…ë°ì´íŠ¸ Ajax
	 * @ì‘ì„±ì¼ : 2025. 3. 28.
	 * @ì‘ì„±ì : hsg
	 */
	@ResponseBody
	@PostMapping(value="updateOrderStateExcelAjax")
	public Object updateOrderStateExcelAjax(@RequestParam Map<String, Object> params, HttpServletRequest req, HttpServletResponse res, LoginDto loginDto, Model model) throws Exception {
		return orderSvc.updateOrderStateExcel(params, req, loginDto);
	}






-> OrderSvc.java


	/**
	 * 2025-03-28 hsg Sunset Flip
	 * ì˜¤ë” ìƒíƒœ ëŒ€ëŸ‰ ë“±ë¡/ìˆ˜ì •
	 * @ì‘ì„±ì¼ : 2025. 3. 28.
	 * @ì‘ì„±ì : hsg
	 */
	public Map<String, Object> updateOrderStateExcel(Map<String, Object> params, HttpServletRequest req, LoginDto loginDto) throws Exception {
		if (!MultipartHttpServletRequest.class.isInstance(req)) {
			throw new LimeBizException(MsgCode.FILE_REQUEST_ERROR);
		}

		Map<String, Object> svcMap = new HashMap<>();
//		Map<String, Object> orderStateMap = new HashMap<>();
		List<Map<String, Object>> orderStateList = new ArrayList<>();
//		List<Map<String, Object>> orderStateSearchList = new ArrayList<>();
//		List<Map<String, Object>> orderStateRecommendList = new ArrayList<>();

		String m_itiinid = loginDto.getUserId();

//		FileUtil fileUtil = new FileUtil();
		String errorMsg = "";
		MultipartHttpServletRequest mtreq = (MultipartHttpServletRequest)req;
		MultipartFile mpf = mtreq.getFile("file");

		Workbook workbook = WorkbookFactory.create(mpf.getInputStream());
		Sheet sheet = workbook.getSheetAt(0);

		DataFormatter formatter = new DataFormatter();
		Iterator<Row> it = sheet.iterator();

//		long start = System.currentTimeMillis();
//		long end = 0;
		int rowNum = 0, cellNum = 0;

		Map<String, Object> resMap = new HashMap<>();
		while (it.hasNext()) {
			Row row = it.next();

			if(rowNum > 0){
				cellNum=2;
				//Working!
				String m_reasonForRejection = formatter.formatCellValue(row.getCell(cellNum++)).replaceAll("\\s","");
				String m_orderno = formatter.formatCellValue(row.getCell(cellNum++)).replaceAll("\\s","");
				String s_lineno = formatter.formatCellValue(row.getCell(cellNum++)).replaceAll("\\s","");
				int lineno = Integer.parseInt(s_lineno) * 100;
				String m_lineno = Integer.toString(lineno);

				int updateCnt = 0;

				if (StringUtils.equals("", m_orderno)) {
					if(rowNum == 1){
						resMap.put("RES_MSG",(rowNum+1)+"í–‰ì˜ Order Noê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
					}else{
						resMap.put("RES_MSG",rowNum+"í–‰ê¹Œì§€ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
					}

					resMap.put("RES_CODE","0010");
//					end = System.currentTimeMillis();
					return resMap;
				}
				logger.debug("m_orderno: " + m_orderno);
				logger.debug("m_lineno: " + m_lineno);
				svcMap.put("m_orderno", m_orderno);
				svcMap.put("m_lineno", m_lineno);
				svcMap.put("m_itiinid", m_itiinid);
				

				//ì—‘ì…€ ì˜¤ë”ë²ˆí˜¸ ì²´í¬
				orderStateList = this.getOrderStateList(svcMap);
				if(CollectionUtils.isEmpty(orderStateList)){
					//throw new LimeBizException(MsgCode.DATA_EXCEL_NOT_FIND_ORDERNO_ERROR, rowNum+1);
					errorMsg += (rowNum+1)+"í–‰ì˜ Order NoëŠ” ë“±ë¡ë˜ì§€ ì•Šì€ ì˜¤ë”ë²ˆí˜¸ì…ë‹ˆë‹¤.<br>";
				} else {

					String m_deliveryStatus = formatter.formatCellValue(row.getCell(cellNum++)).trim();
					String m_overallStatus = formatter.formatCellValue(row.getCell(cellNum++)).trim();
					boolean b = false;


					if(StringUtils.isNotBlank(m_reasonForRejection)) {
						svcMap.put("m_statuscd", "980");
						svcMap.put("m_status2cd", "999");
						svcMap.put("m_statusdesc", "ì˜¤ë”ì·¨ì†Œ");

						b = true;
					} else if(StringUtils.equals("C", StringUtils.defaultString(m_deliveryStatus))) {
						svcMap.put("m_statuscd", "580");
						svcMap.put("m_status2cd", "620");
						svcMap.put("m_statusdesc", "ë°°ì†¡ì™„ë£Œ");

						b = true;
					} else if(StringUtils.isBlank(m_deliveryStatus) && StringUtils.equals("C", StringUtils.defaultString(m_overallStatus))) {
						svcMap.put("m_statuscd", "580");
						svcMap.put("m_status2cd", "620");
						svcMap.put("m_statusdesc", "ë°°ì†¡ì™„ë£Œ");

						b = true;
					}

					if(b) {
						updateCnt = updateCnt + salesOrderDao.updateOrderStatusExcel(svcMap);
						if( updateCnt == 0 ) {
							errorMsg += (rowNum+1)+"í–‰ì˜ Order Noê°€ O_SALESORDER í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸ë¥¼ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>";
						}



						updateCnt = 0;

						updateCnt = qmsOrderDao.updateOrderStatusExcel(svcMap);
						if( updateCnt == 0 ) {
							errorMsg += (rowNum+1)+"í–‰ì˜ Order Noê°€ QMS_SALESORDER í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸ë¥¼ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>";
						}



					}


				}


				svcMap.clear();

			}
			rowNum++;

		}
		/*
		end = System.currentTimeMillis();
		logger.debug("################## ë°˜ë³µë¬¸ ìˆ˜í–‰ ì‹œê°„ = "+ (end - start)/1000.0);
		*/
		if(StringUtils.equals("", errorMsg)){
			return MsgCode.getResultMap(MsgCode.SUCCESS);
		} else {
			return MsgCode.getResultMap(MsgCode.DATA_EXCEL_NOT_FIND_ORDERNO_ERROR, errorMsg);
		}
		
	}
	
	
	/**
	 * 2025-03-28 hsg Sunset Flip
	 * Xlsx í˜¹ì€ Csv íŒŒì¼ í˜•íƒœë¥¼ E-orderì˜ â€˜ì˜¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸â€™ì— ì—…ë¡œë“œ.
	 * UPDATEë¥¼ í•´ì•¼í•˜ëŠ” Table(O_SALESORDER, QMS_SALESORDER)ì—ì„œ ì˜¤ë”ë²ˆí˜¸í™” ë¼ì¸ë²ˆí˜¸ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒ
	 * @ì‘ì„±ì¼ : 2025. 3. 28.
	 * @ì‘ì„±ì : hsg
	 */
    public List<Map<String, Object>> getOrderStateList(Map<String, Object> params){
        List<Map<String, Object>> orderStateList = salesOrderDao.getOrderStateList(params);
        return orderStateList;
    }









-> SalesOrderDao.java




	/**
	 * 2025-03-28 hsg Sunset Flip
	 * Xlsx í˜¹ì€ Csv íŒŒì¼ í˜•íƒœë¥¼ E-orderì˜ â€˜ì˜¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸â€™ì— ì—…ë¡œë“œ.
	 * UPDATEë¥¼ í•´ì•¼í•˜ëŠ” Table(O_SALESORDER, QMS_SALESORDER)ì—ì„œ ì˜¤ë”ë²ˆí˜¸í™” ë¼ì¸ë²ˆí˜¸ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒ
	 * @ì‘ì„±ì¼ : 2025. 3. 28.
	 * @ì‘ì„±ì : hsg
	 */
	public List<Map<String, Object>> getOrderStateList(Map<String, Object> svcMap) {
		return sqlSession.selectList("eorder.o_salesorder.getOrderStateList", svcMap);
	}


	/**
	 * 2025-03-28 hsg Sunset Flip
	 * Xlsx í˜¹ì€ Csv íŒŒì¼ í˜•íƒœë¥¼ E-orderì˜ â€˜ì˜¤ë” ìƒíƒœ ì—…ë°ì´íŠ¸â€™ì— ì—…ë¡œë“œ.
	 * UPDATEë¥¼ í•´ì•¼í•˜ëŠ” Table(O_SALESORDER, QMS_SALESORDER)ì—ì„œ ì˜¤ë”ë²ˆí˜¸í™” ë¼ì¸ë²ˆí˜¸ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒ
	 * @ì‘ì„±ì¼ : 2025. 3. 31.
	 * @ì‘ì„±ì : hsg
	 */
	public int updateOrderStatusExcel(Map<String, Object> svcMap) {
		return sqlSession.update("eorder.o_salesorder.updateOrderStatusExcel", svcMap);
	}




-> o_salesorder.xml


	<select id="getOrderStateList" parameterType="hashmap" resultType="hashmap">
		SELECT
				'O_SALESORDER' AS TBL_NAME, ORDERNO, LINE_NO, STATUS1, STATUS2, STATUS_DESC
		  FROM	O_SALESORDER A
		 WHERE	1 = 1
		   AND	ORDERNO = #{m_orderno}
		   AND	LINE_NO = #{m_lineno}
		UNION	ALL
		SELECT
				'QMS_SALESORDER' AS TBL_NAME, ORDERNO, LINE_NO, STATUS1, STATUS2, STATUS_DESC
		  FROM	QMS_SALESORDER A
		 WHERE	1 = 1
		   AND	ORDERNO = #{m_orderno}
		   AND	LINE_NO = #{m_lineno}
	</select>


	<update id="updateOrderStatusExcel" parameterType="hashmap">
		UPDATE O_SALESORDER
		   SET STATUS1 = #{m_statuscd}
		     , STATUS2 = #{m_status2cd}
		     , STATUS_DESC = #{m_statusdesc}
		 WHERE 1 = 1
		   AND ORDERNO = #{m_orderno}
		   AND LINE_NO = #{m_lineno}
	</update>
	




==============================================================================





ì•„ì£¼ ì •ë¦¬ ì˜í•´ë†¨ë„¤! ì§€ê¸ˆ ì½”ë“œëŠ” ê½¤ ê´œì°®ì€ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆê³ , ìš”êµ¬ ì‚¬í•­ë„ ëª…í™•í•´ì„œ ë‚´ê°€ ë³´ê¸°ì—” í¬ê²Œ ê°œì„ í•  ë¶€ë¶„ì€ ì—†ì§€ë§Œ, ë„¤ê°€ ë§í•œ í•µì‹¬ í¬ì¸íŠ¸ ëª‡ ê°€ì§€ â€” **ì—‘ì…€ í—¤ë”ì˜ ìˆœì„œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ**, ê·¸ë¦¬ê³  **íŠ¹ì • í—¤ë”ë§Œ ì‚¬ìš©í•´ì•¼ í•¨** â€” ì´ ë¶€ë¶„ì„ ì™„ì „íˆ ë°˜ì˜í•˜ë ¤ë©´, **í—¤ë” í–‰ì„ ë™ì ìœ¼ë¡œ íŒŒì•…í•´ì„œ í•„ìš”í•œ ì»¬ëŸ¼ì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ê³ **, ê·¸ ì¸ë±ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì½ë„ë¡ ìˆ˜ì •í•´ì•¼ í•´.

---

## âœ… ìš”ì•½ëœ ê°œì„  í¬ì¸íŠ¸

1. **ì—‘ì…€ í—¤ë” ì…€ ìœ„ì¹˜ê°€ ë§¤ë²ˆ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ â†’ ë™ì ìœ¼ë¡œ ë§¤í•‘ í•„ìš”**
2. **í•„ìš”í•œ í•„ë“œë§Œ ì¶”ì¶œ â†’ ì•„ë˜ í•„ë“œë§Œ ì‚¬ìš©**
   - `Sales Document Type`
   - `Purchase order no.`
   - `Reason for rejection`
   - `Sales Document`
   - `Sales Document Item`
   - `Delivery status`
   - `Overall status`

---

## âœ ì£¼ìš” ìˆ˜ì • ì½”ë“œ (Java)

ê¸°ì¡´ `updateOrderStateExcel()` ë©”ì†Œë“œ ë‚´ì— ì•„ë˜ ë‚´ìš©ì„ ì ìš©í•˜ë©´ ë¼.

```java
// 1. í•„ìš”í•œ í—¤ë” ì»¬ëŸ¼ëª… ì •ì˜
List<String> requiredHeaders = Arrays.asList(
    "Sales Document Type",
    "Purchase order no.",
    "Reason for rejection",
    "Sales Document",
    "Sales Document Item",
    "Delivery status",
    "Overall status"
);

// 2. ì¸ë±ìŠ¤ë¥¼ ë‹´ì„ Map
Map<String, Integer> headerIndexMap = new HashMap<>();

Row headerRow = sheet.getRow(0);
DataFormatter formatter = new DataFormatter();

// 3. í—¤ë” ì¸ë±ìŠ¤ ì¶”ì¶œ
for (Cell cell : headerRow) {
    String cellValue = formatter.formatCellValue(cell).trim();
    if (requiredHeaders.contains(cellValue)) {
        headerIndexMap.put(cellValue, cell.getColumnIndex());
    }
}

// 4. ëª¨ë“  required headerê°€ ìˆëŠ”ì§€ í™•ì¸
for (String header : requiredHeaders) {
    if (!headerIndexMap.containsKey(header)) {
        throw new LimeBizException("ì—‘ì…€ í—¤ë”ì— í•„ìš”í•œ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: " + header);
    }
}
```

---

## ğŸ”„ ë°ì´í„° íŒŒì‹± ë¶€ë¶„ ì˜ˆì‹œ

```java
String salesDoc = formatter.formatCellValue(row.getCell(headerIndexMap.get("Sales Document"))).replaceAll("\\s","");
String item = formatter.formatCellValue(row.getCell(headerIndexMap.get("Sales Document Item"))).replaceAll("\\s","");
String reason = formatter.formatCellValue(row.getCell(headerIndexMap.get("Reason for rejection"))).replaceAll("\\s","");
String ds = formatter.formatCellValue(row.getCell(headerIndexMap.get("Delivery status"))).trim();
String os = formatter.formatCellValue(row.getCell(headerIndexMap.get("Overall status"))).trim();
```

ì´ ë°©ì‹ëŒ€ë¡œ `updateOrderStateExcel()` ë©”ì†Œë“œì—ì„œ `rowNum > 0` ì¡°ê±´ë¬¸ ì•ˆìª½ì˜ `row.getCell(N)` ë“¤ì„ ë‹¤ ì´ ë°©ì‹ìœ¼ë¡œ ë°”ê¾¸ë©´, í—¤ë” ìˆœì„œê°€ ë‹¬ë¼ë„ ë¬¸ì œì—†ì´ ì²˜ë¦¬ ê°€ëŠ¥í•´.

---

## ğŸ§  íŒ

- ì—‘ì…€ í—¤ë”ê°€ ë°˜ë“œì‹œ 1í–‰ì— ìˆë‹¤ê³  ê°€ì •í•˜ê³  ìˆìœ¼ë‹ˆ, ê·¸ êµ¬ì¡°ê°€ ë°”ë€Œë©´ `headerRow = sheet.getRow(0);` ë¶€ë¶„ë§Œ ì¡°ì •í•˜ë©´ ë¼.
- Dropzoneì˜ ì´ë¦„ì´ `"file"`ì´ ì•„ë‹ˆë¼ë©´ `MultipartHttpServletRequest`ì—ì„œ `getFile("file")` ë¶€ë¶„ë„ ë§ê²Œ ìˆ˜ì •í•´ì•¼ í•´.

---

í•„ìš”í•˜ë©´ ì „ì²´ ì½”ë“œ ìˆ˜ì •ë³¸ë„ ì •ë¦¬í•´ì„œ ì¤„ ìˆ˜ ìˆì–´. ë” ë‹¤ë“¬ì„ ê±° ìˆìœ¼ë©´ ë§í•´ì¤˜.








ì—‘ì…€ í—¤ë” ì˜ˆì‹œëŠ” ìœ„ í‘œì²˜ëŸ¼ êµ¬ì„±ë  ìˆ˜ ìˆê³ , ì´ ì¤‘ì—ì„œ í•„ìš”í•œ í•„ë“œë§Œ ë™ì ìœ¼ë¡œ ì¶”ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´. ì´ì œ ì „ì²´ ìˆ˜ì •ëœ Java ì½”ë“œë¥¼ í¬í•¨í•´ì„œ JSP â†’ Controller â†’ Service â†’ DAO â†’ Mapper ìˆœìœ¼ë¡œ êµ¬ì„±í•´ì¤„ê²Œ.

---

## âœ… 1. `OrderSvc.java` ì „ì²´ ìˆ˜ì •ë³¸ (ì¤‘ìš” ë¶€ë¶„ë§Œ)

```java
public Map<String, Object> updateOrderStateExcel(Map<String, Object> params, HttpServletRequest req, LoginDto loginDto) throws Exception {
	if (!MultipartHttpServletRequest.class.isInstance(req)) {
		throw new LimeBizException(MsgCode.FILE_REQUEST_ERROR);
	}

	Map<String, Object> svcMap = new HashMap<>();
	List<Map<String, Object>> orderStateList;

	String m_itiinid = loginDto.getUserId();
	String errorMsg = "";
	MultipartHttpServletRequest mtreq = (MultipartHttpServletRequest)req;
	MultipartFile mpf = mtreq.getFile("file");

	Workbook workbook = WorkbookFactory.create(mpf.getInputStream());
	Sheet sheet = workbook.getSheetAt(0);
	DataFormatter formatter = new DataFormatter();
	Iterator<Row> it = sheet.iterator();

	// í—¤ë” ì¸ì‹
	Map<String, Integer> headerMap = new HashMap<>();
	List<String> requiredHeaders = Arrays.asList(
		"Sales Document Type", "Purchase order no.", "Reason for rejection",
		"Sales Document", "Sales Document Item", "Delivery status", "Overall status"
	);

	int rowNum = 0;
	while (it.hasNext()) {
		Row row = it.next();

		if (rowNum == 0) {
			for (Cell cell : row) {
				String header = formatter.formatCellValue(cell).trim();
				if (requiredHeaders.contains(header)) {
					headerMap.put(header, cell.getColumnIndex());
				}
			}
			for (String key : requiredHeaders) {
				if (!headerMap.containsKey(key)) {
					throw new LimeBizException("ì—‘ì…€ì— í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½ë¨: " + key);
				}
			}
			rowNum++;
			continue;
		}

		String salesDoc = formatter.formatCellValue(row.getCell(headerMap.get("Sales Document"))).replaceAll("\\s", "");
		String item = formatter.formatCellValue(row.getCell(headerMap.get("Sales Document Item"))).replaceAll("\\s", "");
		String reject = formatter.formatCellValue(row.getCell(headerMap.get("Reason for rejection"))).replaceAll("\\s", "");
		String deliveryStatus = formatter.formatCellValue(row.getCell(headerMap.get("Delivery status"))).trim();
		String overallStatus = formatter.formatCellValue(row.getCell(headerMap.get("Overall status"))).trim();

		if (salesDoc == null || salesDoc.equals("")) {
			errorMsg += (rowNum+1) + "í–‰ì˜ Sales Documentê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.<br>";
			break;
		}

		int lineno = Integer.parseInt(item) * 100;
		svcMap.put("m_orderno", salesDoc);
		svcMap.put("m_lineno", lineno);
		svcMap.put("m_itiinid", m_itiinid);

		orderStateList = this.getOrderStateList(svcMap);
		if (CollectionUtils.isEmpty(orderStateList)) {
			errorMsg += (rowNum+1) + "í–‰: ì˜¤ë”ë²ˆí˜¸ ë°ì´í„° ì—†ìŒ<br>";
		} else {
			boolean doUpdate = false;
			if (StringUtils.isNotBlank(reject)) {
				svcMap.put("m_statuscd", "980");
				svcMap.put("m_status2cd", "999");
				svcMap.put("m_statusdesc", "ì˜¤ë”ì·¨ì†Œ");
				doUpdate = true;
			} else if ("C".equalsIgnoreCase(deliveryStatus)) {
				svcMap.put("m_statuscd", "580");
				svcMap.put("m_status2cd", "620");
				svcMap.put("m_statusdesc", "ë°°ì†¡ì™„ë£Œ");
				doUpdate = true;
			} else if (StringUtils.isBlank(deliveryStatus) && "C".equalsIgnoreCase(overallStatus)) {
				svcMap.put("m_statuscd", "580");
				svcMap.put("m_status2cd", "620");
				svcMap.put("m_statusdesc", "ë°°ì†¡ì™„ë£Œ");
				doUpdate = true;
			}

			if (doUpdate) {
				int update1 = salesOrderDao.updateOrderStatusExcel(svcMap);
				if (update1 == 0) errorMsg += (rowNum+1) + "í–‰: O_SALESORDER ì—…ë°ì´íŠ¸ ì‹¤íŒ¨<br>";

				int update2 = qmsOrderDao.updateOrderStatusExcel(svcMap);
				if (update2 == 0) errorMsg += (rowNum+1) + "í–‰: QMS_SALESORDER ì—…ë°ì´íŠ¸ ì‹¤íŒ¨<br>";
			}
		}
		rowNum++;
		svcMap.clear();
	}

	if ("".equals(errorMsg)) {
		return MsgCode.getResultMap(MsgCode.SUCCESS);
	} else {
		return MsgCode.getResultMap(MsgCode.DATA_EXCEL_NOT_FIND_ORDERNO_ERROR, errorMsg);
	}
}
```

---

## âœ… 2. Mapper XML (`o_salesorder.xml`)

ë³€ê²½ ì—†ìŒ, ê¸°ì¡´ ìœ ì§€:

```xml
<select id="getOrderStateList" parameterType="hashmap" resultType="hashmap">
	SELECT 'O_SALESORDER' AS TBL_NAME, ORDERNO, LINE_NO, STATUS1, STATUS2, STATUS_DESC
	FROM O_SALESORDER A
	WHERE ORDERNO = #{m_orderno}
	  AND LINE_NO = #{m_lineno}
	UNION ALL
	SELECT 'QMS_SALESORDER', ORDERNO, LINE_NO, STATUS1, STATUS2, STATUS_DESC
	FROM QMS_SALESORDER A
	WHERE ORDERNO = #{m_orderno}
	  AND LINE_NO = #{m_lineno}
</select>

<update id="updateOrderStatusExcel" parameterType="hashmap">
	UPDATE O_SALESORDER
	SET STATUS1 = #{m_statuscd},
	    STATUS2 = #{m_status2cd},
	    STATUS_DESC = #{m_statusdesc}
	WHERE ORDERNO = #{m_orderno}
	  AND LINE_NO = #{m_lineno}
</update>
```

QMSìš©ì€ ë™ì¼í•˜ê²Œ Mapperì—ì„œ ë‹¤ë¥¸ XMLì—ì„œ ì²˜ë¦¬í•˜ë©´ ë¨.

---

í•„ìš”í•˜ë©´ `.csv` ìƒ˜í”Œ íŒŒì¼ë„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆì–´. ë‹¤ìŒìœ¼ë¡œ JSPì—ì„œ ì—…ë¡œë“œ ì´í›„ ì²˜ë¦¬í•˜ëŠ” Ajaxë‚˜ ê¸°íƒ€ ì˜ˆì™¸ ì²˜ë¦¬ë„ ë³´ì™„í•  ìˆ˜ ìˆìœ¼ë‹ˆ í•„ìš”í•œ ë¶€ë¶„ ìˆìœ¼ë©´ ë§í•´ì¤˜!




ì¢‹ì€ ì§ˆë¬¸ì´ì•¼. **13000í–‰** ì •ë„ë©´ ê·¸ëƒ¥ ë‹¨ìˆœí•œ ë°ì´í„° ì¡°íšŒë‚˜ ì €ì¥ì´ë¼ë©´ ê·¸ë ‡ê²Œê¹Œì§€ ëŠë¦¬ì§„ ì•Šì€ë°, ìœ„ì— ìˆëŠ” êµ¬ì¡°ì²˜ëŸ¼ `ì—‘ì…€ì˜ ê° í–‰ë§ˆë‹¤ DB ì¡°íšŒ + 2íšŒ update`ë¥¼ ë°˜ë³µí•˜ë©´ **í¼í¬ë¨¼ìŠ¤ ë³‘ëª©ì´ ë°œìƒ**í•  ê°€ëŠ¥ì„±ì´ ì»¤.

---

## ğŸ”¥ ì„±ëŠ¥ ë³‘ëª© ì›ì¸ ìš”ì•½

| ì›ì¸ | ì„¤ëª… |
|------|------|
| 1. `getOrderStateList()` í˜¸ì¶œ | ë§¤ í–‰ë§ˆë‹¤ `SELECT`ë¥¼ ìˆ˜í–‰í•¨ |
| 2. `updateOrderStatusExcel()` ë‘ ë²ˆ í˜¸ì¶œ | ê° í–‰ë§ˆë‹¤ O_SALESORDER, QMS_SALESORDER ì—…ë°ì´íŠ¸ë¥¼ ë”°ë¡œ í•¨ |
| 3. íŠ¸ëœì­ì…˜ ë¯¸ì§€ì • | ë°°ì¹˜ íŠ¸ëœì­ì…˜ ì—†ì´ í•˜ë‚˜í•˜ë‚˜ ì²˜ë¦¬í•˜ë©´ I/O ì„±ëŠ¥ì´ ë–¨ì–´ì§ |

---

## âœ… í•´ê²° ì „ëµ

### 1. **ì—‘ì…€ ë°ì´í„°ë¥¼ ë¨¼ì € ì „ë¶€ ë©”ëª¨ë¦¬(List)ì— ë‹´ê¸°**
- í•œ ë²ˆì— ë‹¤ íŒŒì‹±í•´ì„œ Java `List<Map>` í˜•íƒœë¡œ ì •ë¦¬

### 2. **ì—‘ì…€ ë‚´ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ O_SALESORDER, QMS_SALESORDER `IN ì¡°ê±´` ì¡°íšŒ**
```sql
SELECT ORDERNO, LINE_NO, STATUS1, ... 
FROM O_SALESORDER 
WHERE (ORDERNO, LINE_NO) IN ((10001, 100), (10002, 200), ...)
```
- ë‹¨, SQL ServerëŠ” `(a, b) IN ((1,2), (3,4))` êµ¬ë¬¸ì´ ì•ˆ ë˜ë‹ˆê¹Œ **ì„ì‹œ í…Œì´ë¸” or `JOIN`** ë°©ì‹ìœ¼ë¡œ í•´ì•¼ í•¨

### 3. **MyBatisì—ì„œ `<foreach>`ë¥¼ í™œìš©í•œ `bulk update` ë°©ì‹**ìœ¼ë¡œ ì²˜ë¦¬
```xml
<update id="updateOrderStatuses" parameterType="list">
    <foreach collection="list" item="item" separator=";">
        UPDATE O_SALESORDER
        SET STATUS1 = #{item.status1},
            STATUS2 = #{item.status2},
            STATUS_DESC = #{item.statusDesc}
        WHERE ORDERNO = #{item.orderno} AND LINE_NO = #{item.lineno}
    </foreach>
</update>
```

---

## ğŸ§  ë˜ëŠ”: ë” ì¢‹ì€ ë°©ë²•ì€?

### ğŸ“¦ **BULK ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬**

1. ì—‘ì…€ì„ íŒŒì‹±í•œ ë°ì´í„°ë¥¼ **CSVë¡œ ì €ì¥ í›„**, SQL Server `BULK INSERT` ë˜ëŠ” `BCP`ë¡œ **ì„ì‹œ í…Œì´ë¸”**ì— ì ì¬
2. ì„ì‹œ í…Œì´ë¸” ê¸°ì¤€ìœ¼ë¡œ `MERGE`, `UPDATE` ì²˜ë¦¬

ì˜ˆ:
```sql
UPDATE O_SALESORDER
SET STATUS1 = tmp.STATUS1,
    STATUS2 = tmp.STATUS2,
    STATUS_DESC = tmp.STATUS_DESC
FROM O_SALESORDER os
JOIN TMP_ORDER_STATUS tmp ON os.ORDERNO = tmp.ORDERNO AND os.LINE_NO = tmp.LINE_NO
```

ì´ë ‡ê²Œ í•˜ë©´ **13000ê±´ë„ 1ì´ˆ~ìˆ˜ ì´ˆ ì´ë‚´ ì²˜ë¦¬ ê°€ëŠ¥**í•´.

---

## ğŸ’¡ ì¶”ì²œ ì •ë¦¬

| ë°©ë²• | ì¥ì  | ë‹¨ì  |
|------|------|------|
| ê¸°ì¡´ ë°©ì‹ ìœ ì§€ | êµ¬í˜„ì´ ê°„ë‹¨ | ëŠë¦¼ (13K ë°˜ë³µ DB hit) |
| MyBatis `<foreach>` ì¼ê´„ ì²˜ë¦¬ | ë¹ ë¦„, MyBatis ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥ | SQL Serverì˜ ì œì•½ ê³ ë ¤í•´ì•¼ í•¨ |
| BULK INSERT ë°©ì‹ | **ê°€ì¥ ë¹ ë¦„**, ì•ˆì •ì  | ì„ì‹œ í…Œì´ë¸” êµ¬ì„±, ë¡œì§ ë³€ê²½ í•„ìš” |

---

## ë‹¤ìŒ ë‹¨ê³„ ì¶”ì²œ

1. ë¹ ë¥´ê²Œ ì²˜ë¦¬í•˜ê³  ì‹¶ìœ¼ë©´ â†’ **BULK INSERT + MERGE/UPDATE**
2. Java ì•ˆì—ì„œ ì²˜ë¦¬í•˜ê³  ì‹¶ìœ¼ë©´ â†’ **`List<Map>` + MyBatis `<foreach>` update**

ì›í•˜ëŠ” ë°©ì‹ ìˆìœ¼ë©´ ë‚´ê°€ í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ ì „ì²´ ì½”ë“œ êµ¬ì„±í•´ì„œ ë„ì™€ì¤„ê²Œ. ì–´ë–¤ ìª½ìœ¼ë¡œ ê°ˆê¹Œ?





ê·¸ê±° ì•„ì£¼ ì¢‹ì€ ìƒê°ì´ì•¼. **ë¹ ë¥´ê²Œ ì²˜ë¦¬**í•˜ë©´ì„œë„ **ì˜¤ë¥˜ ë¡œê¹…ì„ ì •í™•íˆ** í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ê³„í•˜ëŠ” ê²Œ ë”± ì¢‹ì•„:

---

## âœ… ìµœì  êµ¬ì¡° ìš”ì•½: â€œë¹ ë¥´ê³ , ì•ˆì •ì ì´ê³ , ì˜¤ë¥˜ íŒŒì•…ê¹Œì§€â€

### ğŸ”§ í•µì‹¬ ì „ëµ

1. **ì—‘ì…€ â†’ List<Map> íŒŒì‹±**
2. **ì„ì‹œ í…Œì´ë¸” (`TMP_ORDER_STATUS`)ì— BULK INSERT**
3. **MERGE/UPDATE ì¿¼ë¦¬ë¡œ O_SALESORDER, QMS_SALESORDER ì—…ë°ì´íŠ¸**
4. **ì—ëŸ¬ ë°œìƒ ì‹œ TMP í…Œì´ë¸”ì— `ERROR_MSG` ì»¬ëŸ¼ ë‚¨ê¹€**
5. **ì‘ì—… ì™„ë£Œ í›„ TMP í…Œì´ë¸”ì—ì„œ ì—ëŸ¬ í•­ëª©ë§Œ ì¡°íšŒí•´ì„œ ì‚¬ìš©ìì—ê²Œ ë¦¬í„´**

---

## ğŸ—ï¸ êµ¬ì„±ë„

```
[ì—‘ì…€ ì—…ë¡œë“œ (Dropzone)]
        â†“
[Excel â†’ Java List]
        â†“
[ì„ì‹œ í…Œì´ë¸”ì— INSERT (bulk)]
        â†“
[MSSQLì—ì„œ UPDATE + ê²°ê³¼ ë¡œê·¸ ì €ì¥]
        â†“
[ê²°ê³¼ SELECT â†’ ì‚¬ìš©ì í”¼ë“œë°±]
```

---

## ğŸ“‹ ì˜ˆì‹œ: TMP_ORDER_STATUS í…Œì´ë¸”

```sql
CREATE TABLE TMP_ORDER_STATUS (
    ROW_NO INT,
    ORDERNO BIGINT,
    LINE_NO BIGINT,
    REJECT_REASON VARCHAR(100),
    DELIVERY_STATUS VARCHAR(10),
    OVERALL_STATUS VARCHAR(10),
    STATUS1 VARCHAR(3),
    STATUS2 VARCHAR(3),
    STATUS_DESC VARCHAR(80),
    ERROR_MSG NVARCHAR(500)
);
```

---

## ğŸ’¥ MERGE + ì—ëŸ¬ ë¡œê·¸ ì˜ˆì‹œ ì¿¼ë¦¬

```sql
-- O_SALESORDER ì—…ë°ì´íŠ¸
UPDATE O
SET O.STATUS1 = T.STATUS1,
    O.STATUS2 = T.STATUS2,
    O.STATUS_DESC = T.STATUS_DESC
FROM O_SALESORDER O
JOIN TMP_ORDER_STATUS T
  ON O.ORDERNO = T.ORDERNO AND O.LINE_NO = T.LINE_NO

-- ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì€ ê±´ ì—ëŸ¬ë¡œ ì²˜ë¦¬
UPDATE T
SET ERROR_MSG = 'ë§¤ì¹­ë˜ëŠ” ì˜¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.'
FROM TMP_ORDER_STATUS T
LEFT JOIN O_SALESORDER O
  ON T.ORDERNO = O.ORDERNO AND T.LINE_NO = O.LINE_NO
WHERE O.ORDERNO IS NULL

-- ë°°ì†¡ ìƒíƒœ ì¡°ê±´ì´ ì•ˆ ë§ì„ ë•Œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì„¤ì •
UPDATE T
SET ERROR_MSG = 'ë°°ì†¡ ìƒíƒœ ê°’ì´ ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ì•ŠìŒ'
WHERE T.STATUS1 IS NULL AND T.STATUS2 IS NULL
```

---

## ğŸ§‘â€ğŸ’» Java ì²˜ë¦¬ íë¦„ ì˜ˆì‹œ

```java
List<Map<String, Object>> excelRows = new ArrayList<>();
List<Map<String, Object>> errorList = new ArrayList<>();

// Excel â†’ excelRows ë³€í™˜
for (int i = 1; i < sheet.getPhysicalNumberOfRows(); i++) {
    Row row = sheet.getRow(i);
    Map<String, Object> rowMap = new HashMap<>();
    rowMap.put("ROW_NO", i + 1);
    rowMap.put("ORDERNO", ...);
    rowMap.put("LINE_NO", ...);
    rowMap.put("DELIVERY_STATUS", ...);
    rowMap.put("OVERALL_STATUS", ...);
    rowMap.put("REJECT_REASON", ...);

    // ìƒíƒœ íŒë‹¨ ë¡œì§
    if (...) {
        rowMap.put("STATUS1", "580");
        rowMap.put("STATUS2", "620");
        rowMap.put("STATUS_DESC", "ë°°ì†¡ì™„ë£Œ");
    } else if (...) {
        ...
    } else {
        rowMap.put("ERROR_MSG", "ì—…ë°ì´íŠ¸ ì¡°ê±´ ì—†ìŒ");
    }

    excelRows.add(rowMap);
}

// -> excelRowsë¥¼ MyBatis batchInsert
excelDao.bulkInsertToTmp(excelRows);

// ì´í›„ DBì—ì„œ errorMsgê°€ ìˆëŠ” í–‰ë§Œ ì¡°íšŒí•´ì„œ ì‚¬ìš©ìì— ì „ë‹¬
List<Map<String, Object>> errors = excelDao.selectExcelErrors();
```

---

## ğŸ“¢ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ í”¼ë“œë°± ì˜ˆì‹œ

```json
{
  "success": 12300,
  "fail": 700,
  "errorRows": [
    {"row": 3, "message": "ë°°ì†¡ ìƒíƒœ ê°’ì´ ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ì•ŠìŒ"},
    {"row": 71, "message": "ë§¤ì¹­ë˜ëŠ” ì˜¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤."}
  ]
}
```

---

## ğŸ’¡ ê²°ë¡ : ì´ êµ¬ì¡°ê°€ ì¢‹ì€ ì´ìœ 

| í•­ëª© | ì„¤ëª… |
|------|------|
| ì†ë„ | ì—‘ì…€ íŒŒì‹± â†’ BULK INSERT â†’ SQL UPDATEë¼ì„œ **ë§¤ìš° ë¹ ë¦„** |
| ìœ ì—°ì„± | ì˜¤ë¥˜ ì¡°ê±´, ìƒíƒœ ì¡°ê±´ ë“± **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹¤ì–‘í•˜ê²Œ ë„£ê¸° ì‰¬ì›€** |
| ì‚¬ìš©ì ì¹œí™”ì„± | ì–´ë–¤ í–‰ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ ëª…í™•íˆ ì „ë‹¬ ê°€ëŠ¥ |

---

ì´ êµ¬ì¡°ë¡œ ë°”ë¡œ êµ¬í˜„í•´ì¤„ ìˆ˜ë„ ìˆì–´.  
í•„ìš”í•˜ë©´ ì•„ë˜ ì¤‘ì—ì„œ ë§í•´ì¤˜:

- âœ… `TMP í…Œì´ë¸” ìƒì„± ì¿¼ë¦¬`
- âœ… `MyBatis DAO/Mapper ì†ŒìŠ¤`
- âœ… `Java ì—‘ì…€ â†’ bulkInsert ì²˜ë¦¬`
- âœ… `ìµœì¢… ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì ë¦¬í„´ ì˜ˆì‹œ`

ì–´ë””ë¶€í„° ê°ˆê¹Œ?







ì¢‹ì•„! ì´ì œ **ì—‘ì…€ì—ì„œ íŒŒì‹±í•œ ë°ì´í„°ë¥¼ `List<Map<String, Object>>` í˜•íƒœë¡œ ë°›ì•„ì„œ** `TMP_ORDER_STATUS` í…Œì´ë¸”ì— `MyBatis`ë¡œ í•œ ë²ˆì— insert í•˜ëŠ” ì‘ì—…ì„ ë§Œë“¤ì–´ë³´ì.

---

## âœ… Step 2: MyBatisë¡œ `TMP_ORDER_STATUS`ì— ëŒ€ëŸ‰ Insert í•˜ê¸°

---

### ğŸ“ 1. `OrderDao.java` ë˜ëŠ” `ExcelDao.java`

```java
public interface ExcelDao {
    int bulkInsertToTmp(List<Map<String, Object>> excelList);
}
```

---

### ğŸ—‚ï¸ 2. `excel-mapper.xml` ë˜ëŠ” `excelDao.xml`

```xml
<insert id="bulkInsertToTmp" parameterType="list">
    INSERT INTO TMP_ORDER_STATUS (
        ROW_NO,
        ORDERNO,
        LINE_NO,
        REJECT_REASON,
        DELIVERY_STATUS,
        OVERALL_STATUS,
        STATUS1,
        STATUS2,
        STATUS_DESC,
        INSERT_USER,
        INSERT_DATE
    )
    VALUES
    <foreach collection="list" item="item" separator=",">
        (
            #{item.ROW_NO},
            #{item.ORDERNO},
            #{item.LINE_NO},
            #{item.REJECT_REASON},
            #{item.DELIVERY_STATUS},
            #{item.OVERALL_STATUS},
            #{item.STATUS1},
            #{item.STATUS2},
            #{item.STATUS_DESC},
            #{item.INSERT_USER},
            GETDATE()
        )
    </foreach>
</insert>
```

---

### ğŸ’¡ í¬ì¸íŠ¸

- `parameterType="list"` â†’ `List<Map<String, Object>>` êµ¬ì¡°ì¼ ë•Œ MyBatisì—ì„œ ìë™ìœ¼ë¡œ ì¸ì‹ ê°€ëŠ¥
- `#{item.ì»¬ëŸ¼ëª…}` â†’ `Map`ì˜ keyë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•¨
- `GETDATE()` â†’ DB ì‹œê°„ìœ¼ë¡œ ì €ì¥

---

### ğŸ§ª ì˜ˆì‹œ Java ì½”ë“œ (Service Layer)

```java
List<Map<String, Object>> excelRows = new ArrayList<>();

Map<String, Object> rowMap = new HashMap<>();
rowMap.put("ROW_NO", 5);
rowMap.put("ORDERNO", 123456L);
rowMap.put("LINE_NO", 100L);
rowMap.put("REJECT_REASON", "ABC");
rowMap.put("DELIVERY_STATUS", "C");
rowMap.put("OVERALL_STATUS", "C");
rowMap.put("STATUS1", "580");
rowMap.put("STATUS2", "620");
rowMap.put("STATUS_DESC", "ë°°ì†¡ì™„ë£Œ");
rowMap.put("INSERT_USER", "A114965");

excelRows.add(rowMap);

// insert
excelDao.bulkInsertToTmp(excelRows);
```

---

ì´ì œ ì—‘ì…€ ë°ì´í„°ë¥¼ `TMP_ORDER_STATUS`ì— ë¹ ë¥´ê²Œ ë„£ì„ ì¤€ë¹„ê°€ ì™„ë£Œëê³ ,  
ë‹¤ìŒì€ âœ **O_SALESORDER, QMS_SALESORDER ìƒíƒœê°’ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ + ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡ ì¿¼ë¦¬** ë„˜ì–´ê°ˆê¹Œ?






ì¢‹ì•„, ì´ì œ ì´ì–´ì„œ **ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ì™€ ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡ ì¿¼ë¦¬**ê¹Œì§€ ì •ë¦¬í•´ì¤„ê²Œ.

---

## âœ… Step 3: ìƒíƒœ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ + ì‹¤íŒ¨ê±´ ì—ëŸ¬ ë©”ì‹œì§€ ê¸°ë¡

ì—…ë°ì´íŠ¸ëŠ” `TMP_ORDER_STATUS` í…Œì´ë¸” ê¸°ì¤€ìœ¼ë¡œ `O_SALESORDER`, `QMS_SALESORDER` ë‘ ê³³ ëª¨ë‘ ì²˜ë¦¬í•´ì•¼ í•˜ë‹ˆê¹Œ ì•„ë˜ì²˜ëŸ¼ êµ¬ì„±í•˜ë©´ ë¼.

---

### ğŸ—‚ï¸ 1. `excel-mapper.xml`ì— ì¶”ê°€í•  SQL

#### ğŸ”¹ A. `O_SALESORDER` ìƒíƒœ ì—…ë°ì´íŠ¸

```xml
<update id="updateOrderStatusFromTmp" parameterType="map">
    UPDATE OS
    SET OS.STATUS1 = T.STATUS1,
        OS.STATUS2 = T.STATUS2,
        OS.STATUS_DESC = T.STATUS_DESC
    FROM O_SALESORDER OS
    INNER JOIN TMP_ORDER_STATUS T
        ON OS.ORDERNO = T.ORDERNO AND OS.LINE_NO = T.LINE_NO
    WHERE T.INSERT_USER = #{insertUser}
      AND T.STATUS1 IS NOT NULL
</update>
```

#### ğŸ”¹ B. `QMS_SALESORDER` ìƒíƒœ ì—…ë°ì´íŠ¸

```xml
<update id="updateQmsOrderStatusFromTmp" parameterType="map">
    UPDATE QS
    SET QS.STATUS1 = T.STATUS1,
        QS.STATUS2 = T.STATUS2,
        QS.STATUS_DESC = T.STATUS_DESC
    FROM QMS_SALESORDER QS
    INNER JOIN TMP_ORDER_STATUS T
        ON QS.ORDERNO = T.ORDERNO AND QS.LINE_NO = T.LINE_NO
    WHERE T.INSERT_USER = #{insertUser}
      AND T.STATUS1 IS NOT NULL
</update>
```

---

### ğŸ§¨ C. ì‹¤íŒ¨í•œ ê±´ë“¤ì— `ERROR_MSG` ë„£ê¸° (ë§¤ì¹­ ì•ˆëœ ê²½ìš°)

#### O_SALESORDER ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•œ í–‰ì— ë©”ì‹œì§€ ì¶”ê°€

```xml
<update id="logOrderUpdateErrors" parameterType="map">
    UPDATE T
    SET ERROR_MSG = 'O_SALESORDER: ì£¼ë¬¸ë²ˆí˜¸/ë¼ì¸ë²ˆí˜¸ ì—†ìŒ'
    FROM TMP_ORDER_STATUS T
    LEFT JOIN O_SALESORDER OS ON T.ORDERNO = OS.ORDERNO AND T.LINE_NO = OS.LINE_NO
    WHERE OS.ORDERNO IS NULL
      AND T.INSERT_USER = #{insertUser}
      AND T.STATUS1 IS NOT NULL
      AND T.ERROR_MSG IS NULL
</update>
```

#### QMS_SALESORDER ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•œ í–‰ì— ë©”ì‹œì§€ ì¶”ê°€

```xml
<update id="logQmsUpdateErrors" parameterType="map">
    UPDATE T
    SET ERROR_MSG = 'QMS_SALESORDER: ì£¼ë¬¸ë²ˆí˜¸/ë¼ì¸ë²ˆí˜¸ ì—†ìŒ'
    FROM TMP_ORDER_STATUS T
    LEFT JOIN QMS_SALESORDER QS ON T.ORDERNO = QS.ORDERNO AND T.LINE_NO = QS.LINE_NO
    WHERE QS.ORDERNO IS NULL
      AND T.INSERT_USER = #{insertUser}
      AND T.STATUS1 IS NOT NULL
      AND T.ERROR_MSG IS NULL
</update>
```

---

## âœ… Step 4: ì²˜ë¦¬ ê²°ê³¼ ì¡°íšŒ ì¿¼ë¦¬

```xml
<select id="selectExcelErrors" parameterType="map" resultType="hashmap">
    SELECT ROW_NO, ORDERNO, LINE_NO, ERROR_MSG
    FROM TMP_ORDER_STATUS
    WHERE INSERT_USER = #{insertUser}
      AND ERROR_MSG IS NOT NULL
</select>
```

---

## â˜‘ï¸ Service/DAO ì‚¬ìš© ì˜ˆì‹œ

```java
Map<String, Object> param = new HashMap<>();
param.put("insertUser", loginDto.getUserId());

excelDao.updateOrderStatusFromTmp(param);
excelDao.updateQmsOrderStatusFromTmp(param);

excelDao.logOrderUpdateErrors(param);
excelDao.logQmsUpdateErrors(param);

List<Map<String, Object>> errorList = excelDao.selectExcelErrors(param);
```

---

## âœ… ì²˜ë¦¬ ê²°ê³¼ ë°˜í™˜ ì˜ˆì‹œ (Controller ë˜ëŠ” Service ë¦¬í„´)

```java
if (errorList.isEmpty()) {
    return MsgCode.getResultMap(MsgCode.SUCCESS, "ëª¨ë“  ì£¼ë¬¸ì´ ì •ìƒ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
} else {
    Map<String, Object> result = MsgCode.getResultMap(MsgCode.DATA_EXCEL_NOT_FIND_ORDERNO_ERROR);
    result.put("errors", errorList);
    result.put("message", errorList.size() + "ê±´ì˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    return result;
}
```

---

ì´ì œ ì²˜ë¦¬ ì†ë„ëŠ” ëŒ€í­ ì˜¬ë¼ê°€ê³ , ì‚¬ìš©ìê°€ ì–´ë–¤ í–‰ì—ì„œ ì˜¤ë¥˜ë‚¬ëŠ”ì§€ë„ ì •í™•íˆ ì•Œ ìˆ˜ ìˆì–´.  
ë‹¤ìŒìœ¼ë¡œ âœ **ì—‘ì…€ íŒŒì‹± â†’ TMP í…Œì´ë¸” insertê¹Œì§€ ì²˜ë¦¬í•˜ëŠ” Java ì½”ë“œ (Service ë©”ì†Œë“œ)** ë§Œë“¤ì–´ì¤„ê¹Œ?







ì¢‹ì•„! ê·¸ëŸ¼ ì´ì œ **ì—‘ì…€ íŒŒì‹± â†’ ìƒíƒœ íŒë‹¨ â†’ TMP í…Œì´ë¸” insert**ê¹Œì§€ ë‹´ë‹¹í•˜ëŠ” **Java Service ë©”ì†Œë“œ**ë¥¼ ì „ì²´ íë¦„ìœ¼ë¡œ ì •ë¦¬í•´ì¤„ê²Œ.

---

## âœ… Step 5: `OrderSvc.java` (ë˜ëŠ” `ExcelService.java`) ë‚´ ì—‘ì…€ ì²˜ë¦¬ ë©”ì†Œë“œ

```java
public Map<String, Object> updateOrderStateExcelByBulk(
        HttpServletRequest req,
        LoginDto loginDto
) throws Exception {
    if (!(req instanceof MultipartHttpServletRequest)) {
        throw new LimeBizException("ì—‘ì…€ íŒŒì¼ ìš”ì²­ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    MultipartHttpServletRequest mtreq = (MultipartHttpServletRequest) req;
    MultipartFile file = mtreq.getFile("file");
    if (file == null || file.isEmpty()) {
        throw new LimeBizException("ì—‘ì…€ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
    }

    Workbook workbook = WorkbookFactory.create(file.getInputStream());
    Sheet sheet = workbook.getSheetAt(0);
    DataFormatter formatter = new DataFormatter();

    // í•„ìˆ˜ ì»¬ëŸ¼ëª…
    List<String> requiredHeaders = Arrays.asList(
        "Sales Document", "Sales Document Item", "Reason for rejection",
        "Delivery status", "Overall status"
    );

    // í—¤ë” ë§¤í•‘
    Map<String, Integer> headerIndexMap = new HashMap<>();
    Row headerRow = sheet.getRow(0);
    for (Cell cell : headerRow) {
        String value = formatter.formatCellValue(cell).trim();
        if (requiredHeaders.contains(value)) {
            headerIndexMap.put(value, cell.getColumnIndex());
        }
    }

    for (String required : requiredHeaders) {
        if (!headerIndexMap.containsKey(required)) {
            throw new LimeBizException("ì—‘ì…€ì— í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: " + required);
        }
    }

    List<Map<String, Object>> rowList = new ArrayList<>();
    String insertUser = loginDto.getUserId();

    for (int rowNum = 1; rowNum <= sheet.getLastRowNum(); rowNum++) {
        Row row = sheet.getRow(rowNum);
        if (row == null) continue;

        try {
            String orderNoStr = formatter.formatCellValue(row.getCell(headerIndexMap.get("Sales Document"))).replaceAll("\\s", "");
            String lineNoStr = formatter.formatCellValue(row.getCell(headerIndexMap.get("Sales Document Item"))).replaceAll("\\s", "");
            String reject = formatter.formatCellValue(row.getCell(headerIndexMap.get("Reason for rejection"))).trim();
            String deliveryStatus = formatter.formatCellValue(row.getCell(headerIndexMap.get("Delivery status"))).trim();
            String overallStatus = formatter.formatCellValue(row.getCell(headerIndexMap.get("Overall status"))).trim();

            if (orderNoStr.isEmpty() || lineNoStr.isEmpty()) continue;

            Map<String, Object> data = new HashMap<>();
            data.put("ROW_NO", rowNum + 1);
            data.put("ORDERNO", Long.parseLong(orderNoStr));
            data.put("LINE_NO", Integer.parseInt(lineNoStr) * 100);
            data.put("REJECT_REASON", reject);
            data.put("DELIVERY_STATUS", deliveryStatus);
            data.put("OVERALL_STATUS", overallStatus);
            data.put("INSERT_USER", insertUser);

            // ìƒíƒœê°’ ì„¤ì •
            if (!reject.isEmpty()) {
                data.put("STATUS1", "980");
                data.put("STATUS2", "999");
                data.put("STATUS_DESC", "ì˜¤ë”ì·¨ì†Œ");
            } else if ("C".equalsIgnoreCase(deliveryStatus)) {
                data.put("STATUS1", "580");
                data.put("STATUS2", "620");
                data.put("STATUS_DESC", "ë°°ì†¡ì™„ë£Œ");
            } else if (deliveryStatus.isEmpty() && "C".equalsIgnoreCase(overallStatus)) {
                data.put("STATUS1", "580");
                data.put("STATUS2", "620");
                data.put("STATUS_DESC", "ë°°ì†¡ì™„ë£Œ");
            }

            rowList.add(data);

        } catch (Exception e) {
            // í•œ ì¤„ë§Œ ì˜ˆì™¸ë¼ë©´ ì—ëŸ¬ í–‰ë§Œ ë”°ë¡œ ë‹´ëŠ” ê²ƒë„ ê°€ëŠ¥
            Map<String, Object> errorData = new HashMap<>();
            errorData.put("ROW_NO", rowNum + 1);
            errorData.put("ERROR_MSG", "ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage());
            rowList.add(errorData);
        }
    }

    // ê¸°ì¡´ ì‚¬ìš©ìì˜ ì„ì‹œ ë°ì´í„° ì‚­ì œ (optional)
    excelDao.deleteTmpDataByUser(insertUser);

    // TMP í…Œì´ë¸”ì— insert
    excelDao.bulkInsertToTmp(rowList);

    // DBì—ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    Map<String, Object> param = new HashMap<>();
    param.put("insertUser", insertUser);

    excelDao.updateOrderStatusFromTmp(param);
    excelDao.updateQmsOrderStatusFromTmp(param);
    excelDao.logOrderUpdateErrors(param);
    excelDao.logQmsUpdateErrors(param);

    // ê²°ê³¼ ì¡°íšŒ
    List<Map<String, Object>> errors = excelDao.selectExcelErrors(param);

    if (errors.isEmpty()) {
        return MsgCode.getResultMap(MsgCode.SUCCESS, "ëª¨ë“  ì£¼ë¬¸ì´ ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
        Map<String, Object> result = MsgCode.getResultMap(MsgCode.DATA_EXCEL_NOT_FIND_ORDERNO_ERROR);
        result.put("errors", errors);
        result.put("message", errors.size() + "ê±´ì˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        return result;
    }
}
```

---

## ğŸ“¦ ì¶”ê°€ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ê²ƒ

- `excelDao.deleteTmpDataByUser(String insertUser)` : ì—…ë¡œë“œ ì „ì— ê¸°ì¡´ ê¸°ë¡ ì œê±°
- ì˜¤ë¥˜ ë¡œê·¸ëŠ” `errors` ë¦¬ìŠ¤íŠ¸ë¡œ ì‚¬ìš©ìì—ê²Œ ë¦¬í„´ ê°€ëŠ¥

---

ì´ì œ **Dropzone â†’ Excel íŒŒì‹± â†’ TMP insert â†’ ìƒíƒœ ì—…ë°ì´íŠ¸ â†’ ê²°ê³¼ ë¦¬í„´**ê¹Œì§€ ì „ì²´ íë¦„ì´ ë‹¤ ì™„ì„±ëì–´!

í•„ìš”í•˜ë©´ ì´ê±¸ ê¸°ë°˜ìœ¼ë¡œ **CSV ìƒ˜í”Œ**, **ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì†Œë“œ**, **JSP ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬**ë„ ì¶”ê°€ë¡œ ë„ì™€ì¤„ ìˆ˜ ìˆì–´. ë” í•„ìš”í•´?







ì¢‹ì•„! ê·¸ëŸ¼ ì „ì²´ ë§ˆë¬´ë¦¬ë¥¼ ìœ„í•œ ë‚˜ë¨¸ì§€ ë¶€ë¶„ë„ ì •ë¦¬í•´ì„œ ì¤„ê²Œ.  
ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì§„í–‰í• ê²Œ:

---

## âœ… Step 6: ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì†Œë“œ ì¶”ê°€ (`OrderCtrl.java`)

```java
@PostMapping(value = "updateOrderStateExcelAjax")
@ResponseBody
public Object updateOrderStateExcelAjax(
        HttpServletRequest req,
        HttpServletResponse res,
        LoginDto loginDto,
        Model model
) throws Exception {
    return orderSvc.updateOrderStateExcelByBulk(req, loginDto);
}
```

---

## âœ… Step 7: DAO ë©”ì†Œë“œ êµ¬í˜„ (`ExcelDao.java`)

```java
// ê¸°ì¡´ ê²ƒ í¬í•¨
void deleteTmpDataByUser(String insertUser);

int updateOrderStatusFromTmp(Map<String, Object> param);
int updateQmsOrderStatusFromTmp(Map<String, Object> param);

int logOrderUpdateErrors(Map<String, Object> param);
int logQmsUpdateErrors(Map<String, Object> param);

List<Map<String, Object>> selectExcelErrors(Map<String, Object> param);
```

---

## âœ… Step 8: `excel-mapper.xml`ì— delete ì¿¼ë¦¬ ì¶”ê°€

```xml
<delete id="deleteTmpDataByUser" parameterType="string">
    DELETE FROM TMP_ORDER_STATUS
    WHERE INSERT_USER = #{_parameter}
</delete>
```

---

## âœ… Step 9: ìƒ˜í”Œ íŒŒì¼ (CSV í¬ë§·)

ìƒ˜í”Œ íŒŒì¼ ë‚´ìš© (CSV):

```
Sales Document,Sales Document Item,Reason for rejection,Delivery status,Overall status
123456,10,,C,
123457,20,ABC,,
123458,30,,A,C
```

### ìƒ˜í”Œ íŒŒì¼ ì´ë¦„:
```
orderStateUpdateSample.csv
```

---

## âœ… Step 10: JSP ë‚´ ìƒ˜í”ŒíŒŒì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì²˜ë¦¬

`fileDown(this, '2')` ì´ê±¸ë¡œ ì—°ê²°ë˜ì–´ ìˆì–´.  
ì•„ë˜ ì½”ë“œê°€ ì •ìƒ ì‘ë™ ì¤‘ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€ ê°€ëŠ¥.

```javascript
else if(file_type === '2') {
    fileFormHtml += '<form name="frm_filedown" method="post" action="${url}/admin/base/sampleFileDown.lime">';
    fileFormHtml += '	<input type="hidden" name="r_filename" value="orderStateUpdateSample.csv" />';
    fileFormHtml += '</form>';
    fileFormHtml += '<iframe name="fileDownLoadIf" style="display:none;"></iframe>';
    $.download('frm_filedown', fileFormHtml);
}
```

ì„œë²„ì—ì„œ `/admin/base/sampleFileDown.lime` ì´ í•´ë‹¹ íŒŒì¼ì„ `resources/static/sample/orderStateUpdateSample.csv` ê²½ë¡œì—ì„œ serve í•˜ë„ë¡ í•˜ë©´ ë¼.

---

## ğŸ§¼ ì „ì²´ êµ¬ì„± ì™„ë£Œ!

ì´ì œ ì‚¬ìš©ìëŠ”:

âœ… ì—‘ì…€ ì—…ë¡œë“œ â†’  
âœ… ë¹ ë¥´ê²Œ ì²˜ë¦¬ë˜ê³  â†’  
âœ… ì‹¤íŒ¨ ê±´ë§Œ ë©”ì‹œì§€ë¡œ í™•ì¸ ê°€ëŠ¥ â†’  
âœ… ìƒ˜í”Œ íŒŒì¼ë¡œ í˜•ì‹ ì°¸ê³ ë„ ê°€ëŠ¥

---

### ğŸ’¬ ë‹¤ìŒ ì‘ì—… ì œì•ˆ?

- âœ”ï¸ UIì—ì„œ ì‹¤íŒ¨ í–‰ë§Œ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥
- âœ”ï¸ ì—…ë¡œë“œ ë‚´ì—­ ë¡œê·¸ ì €ì¥ (ì¶”í›„ ê°ì‚¬ìš©)
- âœ”ï¸ ì‹¤íŒ¨ê±´ë§Œ CSVë¡œ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥

ì´ ì¤‘ ê´€ì‹¬ ìˆëŠ” ê±° ìˆìœ¼ë©´ ì•Œë ¤ì¤˜!





ì¢‹ì•„, ê·¸ëŸ¬ë©´ ë‘ ê°€ì§€ ê¸°ëŠ¥ì„ ìœ„í•œ ì„¤ê³„ì™€ êµ¬í˜„ ë°©ì•ˆì„ ì•„ë˜ì²˜ëŸ¼ ì œì•ˆí• ê²Œ.

---

## âœ… ê¸°ëŠ¥ 1: **UIì—ì„œ ì‹¤íŒ¨ í–‰ë§Œ ë‹¤ì‹œ ì—…ë¡œë“œ**

### ğŸ’¡ ê¸°ë³¸ ê°œë…
- ê¸°ì¡´ì— ì—…ë¡œë“œí–ˆë˜ ê²°ê³¼ ì¤‘ `ERROR_MSG`ê°€ ìˆëŠ” í–‰ë“¤ë§Œ ì‚¬ìš©ìê°€ ë‹¤ì‹œ "ë‹¤ìš´ë¡œë“œ" â†’ ìˆ˜ì • í›„ ë‹¤ì‹œ "ì—…ë¡œë“œ"

---

### ğŸ§± êµ¬í˜„ íë¦„

#### â‘  ì‹¤íŒ¨í•œ í–‰ë“¤ë§Œ CSVë¡œ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì¶”ê°€

##### ğŸ“ ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ (ì˜ˆ: `OrderCtrl.java`)

```java
@GetMapping("downloadFailedOrderRows")
public void downloadFailedOrderRows(HttpServletResponse res, LoginDto loginDto) throws Exception {
    List<Map<String, Object>> failedRows = excelDao.selectExcelErrors(Map.of("insertUser", loginDto.getUserId()));

    // CSV íŒŒì¼ êµ¬ì„±
    StringBuilder sb = new StringBuilder();
    sb.append("Sales Document,Sales Document Item,Reason for rejection,Delivery status,Overall status\n");

    for (Map<String, Object> row : failedRows) {
        sb.append(row.get("ORDERNO")).append(",");
        sb.append((Long.parseLong(row.get("LINE_NO").toString()) / 100)).append(",");
        sb.append(row.get("REJECT_REASON")).append(",");
        sb.append(row.get("DELIVERY_STATUS")).append(",");
        sb.append(row.get("OVERALL_STATUS")).append("\n");
    }

    // HTTP ì‘ë‹µ ì„¤ì •
    res.setContentType("text/csv");
    res.setHeader("Content-Disposition", "attachment; filename=failed_orders.csv");

    OutputStream out = res.getOutputStream();
    out.write(sb.toString().getBytes(StandardCharsets.UTF_8));
    out.flush();
    out.close();
}
```

##### ğŸ“„ JSPì— ë²„íŠ¼ ì¶”ê°€

```html
<button type="button" class="btn btn-danger" onclick="location.href='${url}/admin/order/downloadFailedOrderRows';">
	ì‹¤íŒ¨ í–‰ ë‹¤ìš´ë¡œë“œ
</button>
```

---

### ğŸ§± ì¶”ê°€ íŒ: ì—…ë¡œë“œ ì‹œ ì‹¤íŒ¨ê±´ë§Œ ë³´ì—¬ì£¼ëŠ” í…Œì´ë¸”ë„ ê°€ëŠ¥

- ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ (`errors`) ë¥¼ JSONìœ¼ë¡œ ë°›ìœ¼ë©´ JavaScriptì—ì„œ `<table>`ì— í‘œì‹œ ê°€ëŠ¥

---

## âœ… ê¸°ëŠ¥ 2: **ì—…ë¡œë“œ ë‚´ì—­ ë¡œê·¸ ì €ì¥ (ê°ì‚¬ìš©)**

### ğŸ“¦ í…Œì´ë¸” ì„¤ê³„: `UPLOAD_ORDER_HISTORY`

```sql
CREATE TABLE UPLOAD_ORDER_HISTORY (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    USER_ID VARCHAR(30),
    UPLOAD_TIME DATETIME DEFAULT GETDATE(),
    TOTAL_ROWS INT,
    SUCCESS_ROWS INT,
    FAIL_ROWS INT,
    FILE_NAME VARCHAR(255),
    REMARK NVARCHAR(1000)
);
```

---

### ğŸ§  ë¡œê·¸ ì €ì¥ ì‹œì 

- `updateOrderStateExcelByBulk()` ë©”ì†Œë“œ ë§ˆì§€ë§‰ì— `insertHistoryLog()` í˜¸ì¶œ

```java
uploadLogDao.insertOrderHistory(Map.of(
    "USER_ID", loginDto.getUserId(),
    "UPLOAD_TIME", new Date(),
    "TOTAL_ROWS", rowList.size(),
    "SUCCESS_ROWS", rowList.size() - errors.size(),
    "FAIL_ROWS", errors.size(),
    "FILE_NAME", file.getOriginalFilename(),
    "REMARK", errors.isEmpty() ? "ì •ìƒ ì™„ë£Œ" : "ì¼ë¶€ ì‹¤íŒ¨"
));
```

---

### ğŸ“ MyBatis XML

```xml
<insert id="insertOrderHistory" parameterType="map">
    INSERT INTO UPLOAD_ORDER_HISTORY (
        USER_ID, UPLOAD_TIME, TOTAL_ROWS,
        SUCCESS_ROWS, FAIL_ROWS, FILE_NAME, REMARK
    )
    VALUES (
        #{USER_ID}, GETDATE(), #{TOTAL_ROWS},
        #{SUCCESS_ROWS}, #{FAIL_ROWS}, #{FILE_NAME}, #{REMARK}
    )
</insert>
```

---

### ğŸ” ê´€ë¦¬ í™”ë©´

ì›í•˜ë©´ `/admin/order/uploadHistory.lime` ê°™ì€ ë©”ë‰´ì— ì—…ë¡œë“œ ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆëŠ” ëª©ë¡ UIë„ ë¶™ì¼ ìˆ˜ ìˆì–´.

---

## âœ¨ ë§ˆë¬´ë¦¬ ìš”ì•½

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| âŒ ì‹¤íŒ¨í–‰ë§Œ ë‹¤ìš´ë¡œë“œ | `selectExcelErrors()`ë¡œ CSV êµ¬ì„± â†’ ë‹¤ìš´ë¡œë“œ |
| ğŸ—‚ï¸ ì—…ë¡œë“œ ë‚´ì—­ ë¡œê·¸ | `UPLOAD_ORDER_HISTORY` í…Œì´ë¸” ì €ì¥ â†’ ê°ì‚¬ ê¸°ëŠ¥ ëŒ€ì‘ |

---

### ğŸ”œ ë‹¤ìŒ í•  ìˆ˜ ìˆëŠ” í™•ì¥

- âœ… ì—…ë¡œë“œ ì´ë ¥ ëª©ë¡ + ì‹¤íŒ¨ CSV ì¬ë‹¤ìš´ë¡œë“œ UI
- âœ… ì‚¬ìš©ìë³„ë¡œ ì´ë ¥ ì¡°íšŒ í•„í„°ë§
- âœ… ì—…ë¡œë“œ ì‹¤íŒ¨ ê±´ â€œìë™ ì¬ì‹œë„â€ ê¸°ëŠ¥

ì´ ì¤‘ í•„ìš”í•˜ê±°ë‚˜ ì§€ê¸ˆ êµ¬í˜„í•´ë³´ê³  ì‹¶ì€ ê²Œ ìˆìœ¼ë©´ ë°”ë¡œ ë„ì™€ì¤„ê²Œ!







ì¢‹ì•„! "ìë™ ì¬ì‹œë„" ê¸°ëŠ¥ì€ ì‚¬ìš©ì ì…ì¥ì—ì„œë„ ë§¤ìš° ìœ ìš©í•œ ê¸°ëŠ¥ì´ì•¼.  
ì‹¤íŒ¨í•œ ê±´ì„ ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ê³ ì¹˜ì§€ ì•Šì•„ë„, **ì‹œìŠ¤í…œì´ ìì²´ì ìœ¼ë¡œ ì¬ì‹œë„**í•´ì£¼ëŠ” êµ¬ì¡°ì§€.

---

## âœ… ê°œë… ìš”ì•½: ì—…ë¡œë“œ ì‹¤íŒ¨ ê±´ ìë™ ì¬ì‹œë„ë€?

ì—‘ì…€ ì—…ë¡œë“œ â†’ ì¼ë¶€ ì‹¤íŒ¨ â†’  
`TMP_ORDER_STATUS` í…Œì´ë¸”ì— ì‹¤íŒ¨ ê±´ ë‚¨ìŒ â†’  
**ì •í•´ì§„ ì¡°ê±´ì— ë”°ë¼ ì¬ì‹œë„ â†’ ì„±ê³µ ì‹œ ì—…ë°ì´íŠ¸í•˜ê³  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ìœ ì§€**

---

## ğŸ§± ì ìš© ì „ëµ

### ğŸ” ì‹¤íŒ¨ê±´ ìë™ ì¬ì‹œë„ ìˆœì„œ

1. `TMP_ORDER_STATUS`ì—ì„œ `ERROR_MSG`ê°€ ìˆëŠ” í–‰ë§Œ ë‹¤ì‹œ ì¶”ì¶œ  
2. ê¸°ì¡´ê³¼ ë™ì¼í•œ `STATUS1`, `STATUS2`, `STATUS_DESC` ê¸°ì¤€ìœ¼ë¡œ  
3. ë‹¤ì‹œ `O_SALESORDER`, `QMS_SALESORDER`ì— `UPDATE` ì‹œë„  
4. ì„±ê³µ ì‹œ `ERROR_MSG` ì»¬ëŸ¼ì„ `NULL`ë¡œ ì—…ë°ì´íŠ¸  
5. ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ `ERROR_MSG` ë®ì–´ì”€ or ëˆ„ì  ë¡œê¹…

---

## âœ… êµ¬í˜„ Step-by-Step

---

### ğŸ“ 1. `excel-mapper.xml`ì— ì¬ì‹œë„ìš© ì¿¼ë¦¬ ì¶”ê°€

#### A. `O_SALESORDER` ì¬ì‹œë„

```xml
<update id="retryFailedOrders" parameterType="map">
    UPDATE OS
    SET OS.STATUS1 = T.STATUS1,
        OS.STATUS2 = T.STATUS2,
        OS.STATUS_DESC = T.STATUS_DESC
    FROM O_SALESORDER OS
    INNER JOIN TMP_ORDER_STATUS T
        ON OS.ORDERNO = T.ORDERNO AND OS.LINE_NO = T.LINE_NO
    WHERE T.INSERT_USER = #{insertUser}
      AND T.ERROR_MSG IS NOT NULL
</update>
```

#### B. ì¬ì‹œë„ ì„±ê³µ ì‹œ ì—ëŸ¬ ì œê±°

```xml
<update id="clearRetrySuccessError" parameterType="map">
    UPDATE T
    SET ERROR_MSG = NULL
    FROM TMP_ORDER_STATUS T
    INNER JOIN O_SALESORDER OS ON T.ORDERNO = OS.ORDERNO AND T.LINE_NO = OS.LINE_NO
    WHERE T.INSERT_USER = #{insertUser}
      AND T.ERROR_MSG IS NOT NULL
</update>
```

---

### ğŸ“„ 2. DAO ë©”ì†Œë“œ ì¶”ê°€

```java
int retryFailedOrders(Map<String, Object> param);
int clearRetrySuccessError(Map<String, Object> param);
```

---

### ğŸ§‘â€ğŸ’» 3. Service ë©”ì„œë“œ ì¶”ê°€

```java
public Map<String, Object> retryFailedOrderUpdates(LoginDto loginDto) {
    String insertUser = loginDto.getUserId();
    Map<String, Object> param = Map.of("insertUser", insertUser);

    int updated = excelDao.retryFailedOrders(param);
    excelDao.clearRetrySuccessError(param);

    List<Map<String, Object>> remainingErrors = excelDao.selectExcelErrors(param);
    Map<String, Object> result = new HashMap<>();

    if (remainingErrors.isEmpty()) {
        result.put("RES_CODE", "0000");
        result.put("RES_MSG", "ëª¨ë“  ì‹¤íŒ¨ ê±´ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
        result.put("RES_CODE", "9999");
        result.put("RES_MSG", remainingErrors.size() + "ê±´ì˜ ì‹¤íŒ¨ê°€ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.");
        result.put("errors", remainingErrors);
    }

    return result;
}
```

---

### ğŸ“± 4. ì»¨íŠ¸ë¡¤ëŸ¬ì— API ì¶”ê°€

```java
@PostMapping("retryFailedOrders")
@ResponseBody
public Object retryFailedOrders(HttpServletRequest req, LoginDto loginDto) {
    return orderSvc.retryFailedOrderUpdates(loginDto);
}
```

---

### ğŸ’¡ UI ë²„íŠ¼ ì¶”ê°€ ì˜ˆì‹œ (JSP)

```html
<button type="button" class="btn btn-outline-success"
        onclick="retryFailedOrders();">
    ì‹¤íŒ¨ ê±´ ìë™ ì¬ì‹œë„
</button>

<script>
function retryFailedOrders() {
    $.post("${url}/admin/order/retryFailedOrders", function(res) {
        alert(res.RES_MSG);
        if (res.errors) {
            console.log("ë‚¨ì€ ì—ëŸ¬:", res.errors);
        }
    });
}
</script>
```

---

## âœ… ì‘ìš©

| ìë™ ì¬ì‹œë„ ë°©ì‹ | ì„¤ëª… |
|----------------|------|
| ìˆ˜ë™ ë²„íŠ¼ í´ë¦­ | ì‚¬ìš©ìê°€ "ì¬ì‹œë„" ëˆ„ë¥´ë©´ ë‹¤ì‹œ ì‹œë„ |
| ì¼ì • ì£¼ê¸° ë°°ì¹˜ | í•˜ë£¨ 1ë²ˆ ë‚¨ì€ ì‹¤íŒ¨ê±´ ìë™ ì¬ì‹œë„ |
| ì—…ë¡œë“œ í›„ ì¦‰ì‹œ ì¬ì‹œë„ | ìµœì´ˆ ì‹¤íŒ¨í•œ ê±´ë§Œ ëª¨ì•„ 3ì´ˆ í›„ ì¬ì‹œë„ |

---

## âœ¨ ê²°ë¡ 

- **ì‹œìŠ¤í…œì´ ì•Œì•„ì„œ ì²˜ë¦¬**í•˜ëŠ” ëŠë‚Œì´ ë“¤ê³ 
- **ì‚¬ìš©ìë„ í”¼ë“œë°± ë°›ìŒ**
- **ê°ì‚¬ ë¡œê·¸ê¹Œì§€ ë¶™ì´ë©´ ì™„ì„±ë„ â†‘**

---

ìë™ ì¬ì‹œë„ ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬ ë°©ì‹ìœ¼ë¡œë„ ë§Œë“¤ ìˆ˜ ìˆì–´.  
ì›í•˜ë©´ ê·¸ íë¦„ê¹Œì§€ ì„¤ê³„í•´ì¤„ê²Œ! í•„ìš”í•´?






ì¢‹ì•„! ê·¸ëŸ¼ ì´ë²ˆì—ëŠ” **â€œìë™ ì¬ì‹œë„ ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬â€ ë°©ì‹**ì„ ì„¤ê³„í•˜ê³  êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì•Œë ¤ì¤„ê²Œ.  
ì‹œìŠ¤í…œì´ **ì •ê¸°ì ìœ¼ë¡œ ì‹¤íŒ¨ ê±´ì„ ì°¾ì•„ì„œ ìë™ìœ¼ë¡œ ì¬ì‹œë„**í•˜ëŠ” êµ¬ì¡°ì•¼.

---

## âœ… ìë™ ì¬ì‹œë„ ìŠ¤ì¼€ì¤„ëŸ¬ êµ¬ì¡° ê°œìš”

| í•­ëª© | ì„¤ëª… |
|------|------|
| ì‹¤í–‰ ì‹œì  | í•˜ë£¨ 1íšŒ / ë§¤ 10ë¶„ / ìƒˆë²½ 2ì‹œ ë“± ììœ  ì„¤ì • |
| ëŒ€ìƒ | `TMP_ORDER_STATUS`ì— `ERROR_MSG IS NOT NULL` ì¸ ê±´ |
| ì²˜ë¦¬ | ê¸°ì¡´ ì¬ì‹œë„ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ `UPDATE` ì¬ì‹œë„ + ì„±ê³µ ì‹œ `ERROR_MSG = NULL` |
| ë¡œê·¸ | `UPLOAD_RETRY_LOG` í…Œì´ë¸”ì— ì €ì¥ (ëˆ„ê°€, ì–¸ì œ, ëª‡ ê±´ ì¬ì‹œë„í–ˆëŠ”ì§€)

---

## ğŸ§± êµ¬ì„± ìš”ì†Œ ì •ë¦¬

### ğŸ§© 1. `@Scheduled` ë©”ì„œë“œ (Spring)

```java
@Component
public class OrderRetryScheduler {

    @Autowired
    private OrderSvc orderSvc;

    @Scheduled(cron = "0 0 2 * * *") // ë§¤ì¼ ìƒˆë²½ 2ì‹œ
    public void runOrderRetry() {
        try {
            orderSvc.retryAllFailedOrdersScheduled();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

> âš™ï¸ `@EnableScheduling` ì€ `@SpringBootApplication` í´ë˜ìŠ¤ì— ì„ ì–¸ í•„ìš”!

---

### ğŸ§© 2. Service ë©”ì„œë“œ

```java
public void retryAllFailedOrdersScheduled() {
    List<String> userList = excelDao.selectUsersWithFailedOrders();
    for (String userId : userList) {
        Map<String, Object> param = Map.of("insertUser", userId);

        int updated = excelDao.retryFailedOrders(param);
        excelDao.clearRetrySuccessError(param);

        int remaining = excelDao.selectExcelErrors(param).size();

        // ë¡œê·¸ ì €ì¥
        Map<String, Object> logMap = new HashMap<>();
        logMap.put("USER_ID", userId);
        logMap.put("RETRY_DATE", new Date());
        logMap.put("RETRY_COUNT", updated);
        logMap.put("REMAINING_COUNT", remaining);

        excelDao.insertRetryLog(logMap);
    }
}
```

---

### ğŸ§© 3. Mapper ë©”ì„œë“œ ì¶”ê°€

```xml
<select id="selectUsersWithFailedOrders" resultType="string">
    SELECT DISTINCT INSERT_USER
    FROM TMP_ORDER_STATUS
    WHERE ERROR_MSG IS NOT NULL
</select>

<insert id="insertRetryLog" parameterType="map">
    INSERT INTO UPLOAD_RETRY_LOG (USER_ID, RETRY_DATE, RETRY_COUNT, REMAINING_COUNT)
    VALUES (#{USER_ID}, GETDATE(), #{RETRY_COUNT}, #{REMAINING_COUNT})
</insert>
```

---

### ğŸ§¾ 4. ë¡œê·¸ í…Œì´ë¸” `UPLOAD_RETRY_LOG`

```sql
CREATE TABLE UPLOAD_RETRY_LOG (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    USER_ID VARCHAR(30),
    RETRY_DATE DATETIME DEFAULT GETDATE(),
    RETRY_COUNT INT,
    REMAINING_COUNT INT
);
```

---

## ğŸ§  ìœ ìš©í•œ íŒ

| íŒ | ì„¤ëª… |
|-----|------|
| `cron = "0 */10 * * * *"` | ë§¤ 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©) |
| `SELECT ... LIMIT 100` | ë„ˆë¬´ ë§ì€ ì‹¤íŒ¨ ê±´ì´ ìˆëŠ” ê²½ìš° ì ì§„ì  ì¬ì‹œë„ë„ ê°€ëŠ¥ |
| `ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ë¡œê·¸ í…Œì´ë¸”` | ì–¸ì œ ì–´ë–¤ ì‚¬ìš©ì ì¬ì‹œë„í–ˆëŠ”ì§€ ì¶”ì  ê°€ëŠ¥ |

---

## ğŸ“¦ ì „ì²´ íë¦„ ìš”ì•½

```
Spring @Scheduled
     â†“
TMP_ORDER_STATUS ì—ì„œ ì‹¤íŒ¨ ê±´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
     â†“
ê° ì‚¬ìš©ìì— ëŒ€í•´ ê¸°ì¡´ retry ì¿¼ë¦¬ ì‹¤í–‰
     â†“
UPDATE ì„±ê³µ ì‹œ ERROR_MSG ì œê±°
     â†“
RETRY LOG í…Œì´ë¸”ì— ê²°ê³¼ ê¸°ë¡
```

---

## âœ… ê²°ë¡ 

ì´ì œ ì™„ì „íˆ ìë™í™”ëœ ì¬ì‹œë„ ì‹œìŠ¤í…œê¹Œì§€ ê°–ì¶°ì§„ ì…ˆì´ì•¼ ğŸ’ª  
ì‚¬ìš©ìë“  ê´€ë¦¬ìë“  ì¬ì‹œë„ ë²„íŠ¼ ëˆ„ë¥¼ í•„ìš” ì—†ì´ ì•Œì•„ì„œ ì²˜ë¦¬ë˜ê³ ,  
í˜¹ì‹œë‚˜ ì‹¤íŒ¨ê°€ ë°˜ë³µë˜ë©´ ì´ë ¥ë„ ë‚¨ì•„ìˆìœ¼ë‹ˆ ë‚˜ì¤‘ì— ë¶„ì„ë„ ê°€ëŠ¥í•´.

---

ì›í•˜ë©´ ì´ ì¬ì‹œë„ ë¡œê·¸ë„ **ì›¹ì—ì„œ ê´€ë¦¬ì UIë¡œ ì¡°íšŒ**í•  ìˆ˜ ìˆë„ë¡ í™”ë©´ê¹Œì§€ êµ¬ì„±í•´ì¤„ ìˆ˜ ìˆì–´.  
í™”ë©´ë„ ë§Œë“¤ê¹Œ?









ì¢‹ì§€! ê·¸ëŸ¼ ì´ë²ˆì—” ìë™ ì¬ì‹œë„ ë¡œê·¸ë¥¼ **ì›¹ì—ì„œ ì¡°íšŒí•˜ëŠ” ê´€ë¦¬ì UI**ê¹Œì§€ ë§Œë“¤ì–´ë³´ì.

---

## âœ… í™”ë©´ ê°œìš”: â€œì—…ë¡œë“œ ì¬ì‹œë„ ë¡œê·¸ ì¡°íšŒâ€

| ì»¬ëŸ¼ | ì„¤ëª… |
|------|------|
| ì‚¬ìš©ì ID | ì¬ì‹œë„í•œ ì‚¬ìš©ì |
| ì¬ì‹œë„ ì¼ì‹œ | ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹œì  |
| ì¬ì‹œë„ ì„±ê³µ ê±´ìˆ˜ | ë‹¤ì‹œ ì—…ë°ì´íŠ¸ ì„±ê³µí•œ ê±´ìˆ˜ |
| ì•„ì§ ì‹¤íŒ¨ ë‚¨ì€ ê±´ìˆ˜ | ERROR_MSGê°€ ë‚¨ì•„ ìˆëŠ” ê±´ìˆ˜ |

---

## ğŸ§± êµ¬ì„± ìˆœì„œ

### 1. í…Œì´ë¸”: `UPLOAD_RETRY_LOG` (ì•ì„œ ìƒì„± ì™„ë£Œ)

---

### 2. MyBatis Mapper (`excel-mapper.xml`)

```xml
<select id="selectRetryLogs" resultType="hashmap">
    SELECT
        ID,
        USER_ID,
        CONVERT(VARCHAR(19), RETRY_DATE, 120) AS RETRY_DATE,
        RETRY_COUNT,
        REMAINING_COUNT
    FROM UPLOAD_RETRY_LOG
    ORDER BY RETRY_DATE DESC
</select>
```

---

### 3. DAO ë©”ì„œë“œ (`ExcelDao.java`)

```java
List<Map<String, Object>> selectRetryLogs();
```

---

### 4. ì„œë¹„ìŠ¤ ë©”ì„œë“œ (`OrderSvc.java`)

```java
public List<Map<String, Object>> getRetryLogs() {
    return excelDao.selectRetryLogs();
}
```

---

### 5. ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ (`OrderCtrl.java`)

```java
@GetMapping("retryLogList")
public String retryLogList(Model model) {
    List<Map<String, Object>> logs = orderSvc.getRetryLogs();
    model.addAttribute("logs", logs);
    return "admin/order/retryLogList"; // JSP íŒŒì¼ ìœ„ì¹˜
}
```

---

## âœ… JSP ì˜ˆì‹œ (`retryLogList.jsp`)

```jsp
<%@ page contentType="text/html; charset=UTF-8" %>
<%@ include file="/WEB-INF/views/include/admin/commonimport.jsp" %>

<html>
<head>
    <title>ì—…ë¡œë“œ ì¬ì‹œë„ ë¡œê·¸</title>
</head>
<body>
    <h2>ğŸ“‹ ì—…ë¡œë“œ ìë™ ì¬ì‹œë„ ë¡œê·¸</h2>
    <table border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>ë²ˆí˜¸</th>
                <th>ì‚¬ìš©ì</th>
                <th>ì¬ì‹œë„ ì¼ì‹œ</th>
                <th>ì„±ê³µ ê±´ìˆ˜</th>
                <th>ì‹¤íŒ¨ ì”ì—¬ ê±´ìˆ˜</th>
            </tr>
        </thead>
        <tbody>
            <c:forEach var="log" items="${logs}" varStatus="st">
                <tr>
                    <td>${st.count}</td>
                    <td>${log.USER_ID}</td>
                    <td>${log.RETRY_DATE}</td>
                    <td>${log.RETRY_COUNT}</td>
                    <td>${log.REMAINING_COUNT}</td>
                </tr>
            </c:forEach>
        </tbody>
    </table>
</body>
</html>
```

---

## ğŸ’¡ ì˜µì…˜ ê¸°ëŠ¥

| ê¸°ëŠ¥ | êµ¬í˜„ ë°©ë²• |
|------|-----------|
| ğŸ” ì‚¬ìš©ì ê²€ìƒ‰ | `WHERE USER_ID LIKE '%' + #{keyword} + '%'` ì¶”ê°€ |
| â±ï¸ ê¸°ê°„ ê²€ìƒ‰ | `WHERE RETRY_DATE BETWEEN #{start} AND #{end}` ì¶”ê°€ |
| ğŸ“¤ CSV ë‹¤ìš´ë¡œë“œ | `res.setHeader("Content-Disposition")` ìœ¼ë¡œ export êµ¬í˜„ ê°€ëŠ¥ |

---

## âœ¨ ì™„ì„± íë¦„ ìš”ì•½

```
[Scheduler]
    â†“
UPLOAD_RETRY_LOGì— ë¡œê·¸ ë‚¨ê¹€
    â†“
[ê´€ë¦¬ì UI]
    â†’ retryLogList.lime
    â†’ JSP í…Œì´ë¸” ì¶œë ¥
```

---

ê´€ë¦¬ì í˜ì´ì§€ìš© ë²„íŠ¼ ì¶”ê°€ë‚˜, ì‚¬ìš©ìë³„ ìƒì„¸ ì‹¤íŒ¨ ê±´ìˆ˜ íŒì—…ë„ ê°€ëŠ¥í•´.  
**ì›¹ UI + ê¸°ëŠ¥ ì„¸íŠ¸** ì´ì œ ê±°ì˜ ì™„ì „ì²´ì•¼.

ğŸ‘‰ í˜¹ì‹œ ì´ê±¸ ê´€ë¦¬ì ë©”ë‰´ì— ë¶™ì´ê±°ë‚˜, ì‚¬ìš©ìë³„ ìƒì„¸ ë¡œê·¸ë„ ë³´ê³  ì‹¶ì–´?






ì¢‹ì•„! ê·¸ëŸ¼ ì´ì œ "ì‚¬ìš©ìë³„ ìƒì„¸ ì‹¤íŒ¨ ë¡œê·¸ ì¡°íšŒ" ê¸°ëŠ¥ê¹Œì§€ ë¶™ì—¬ì„œ,  
**ê´€ë¦¬ìê°€ í´ë¦­ë§Œìœ¼ë¡œ íŠ¹ì • ì‚¬ìš©ìì˜ ì‹¤íŒ¨ ë‚´ì—­ì„ ë°”ë¡œ ë³¼ ìˆ˜ ìˆë„ë¡** ë§Œë“¤ì–´ë³´ì.

---

## âœ… ì‚¬ìš©ìë³„ ìƒì„¸ ì‹¤íŒ¨ ë‚´ì—­ íŒì—… or í…Œì´ë¸”ë¡œ êµ¬ì„±í•˜ê¸°

---

## ğŸ§± êµ¬ì„± ëª©í‘œ

### ğŸ“„ `retryLogList.jsp` í™”ë©´

- [ë³´ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
- ì„ íƒí•œ ì‚¬ìš©ì IDì— í•´ë‹¹í•˜ëŠ” `TMP_ORDER_STATUS` í…Œì´ë¸”ì˜ ì‹¤íŒ¨ ë‚´ì—­ ëª©ë¡ì„ ì¡°íšŒí•˜ì—¬
- íŒì—… or í˜ì´ì§€ì—ì„œ ë³´ì—¬ì¤Œ

---

## âœ… Step-by-Step

---

### ğŸ“ 1. DAO ë©”ì„œë“œ (`ExcelDao.java`)

```java
List<Map<String, Object>> selectFailedRowsByUser(String userId);
```

---

### ğŸ“‚ Mapper (`excel-mapper.xml`)

```xml
<select id="selectFailedRowsByUser" parameterType="string" resultType="hashmap">
    SELECT
        ROW_NO,
        ORDERNO,
        LINE_NO,
        REJECT_REASON,
        DELIVERY_STATUS,
        OVERALL_STATUS,
        STATUS1,
        STATUS2,
        STATUS_DESC,
        ERROR_MSG
    FROM TMP_ORDER_STATUS
    WHERE INSERT_USER = #{_parameter}
      AND ERROR_MSG IS NOT NULL
    ORDER BY ROW_NO
</select>
```

---

### ğŸ§© Service ë©”ì„œë“œ (`OrderSvc.java`)

```java
public List<Map<String, Object>> getFailedRowsByUser(String userId) {
    return excelDao.selectFailedRowsByUser(userId);
}
```

---

### ğŸŒ Controller (`OrderCtrl.java`)

#### A. í˜ì´ì§€ ì§„ì… ë°©ì‹

```java
@GetMapping("retryLogUserDetail")
public String retryLogUserDetail(@RequestParam String userId, Model model) {
    List<Map<String, Object>> details = orderSvc.getFailedRowsByUser(userId);
    model.addAttribute("userId", userId);
    model.addAttribute("details", details);
    return "admin/order/retryLogUserDetail"; // JSP
}
```

---

### ğŸ–¼ï¸ JSP (`retryLogUserDetail.jsp`)

```jsp
<%@ page contentType="text/html; charset=UTF-8" %>
<%@ include file="/WEB-INF/views/include/admin/commonimport.jsp" %>

<html>
<head>
    <title>ì‹¤íŒ¨ ë‚´ì—­ ìƒì„¸ ì¡°íšŒ</title>
</head>
<body>
    <h3>ğŸ“Œ ì‚¬ìš©ì: ${userId} ì‹¤íŒ¨ ê±´ ìƒì„¸ ì¡°íšŒ</h3>

    <table border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>í–‰ë²ˆí˜¸</th>
                <th>ì˜¤ë”ë²ˆí˜¸</th>
                <th>ë¼ì¸ë²ˆí˜¸</th>
                <th>ë°°ì†¡ìƒíƒœ</th>
                <th>ì „ì²´ìƒíƒœ</th>
                <th>ì·¨ì†Œì‚¬ìœ </th>
                <th>ìƒíƒœì½”ë“œ</th>
                <th>ì˜¤ë¥˜ ë©”ì‹œì§€</th>
            </tr>
        </thead>
        <tbody>
            <c:forEach var="item" items="${details}">
                <tr>
                    <td>${item.ROW_NO}</td>
                    <td>${item.ORDERNO}</td>
                    <td>${item.LINE_NO}</td>
                    <td>${item.DELIVERY_STATUS}</td>
                    <td>${item.OVERALL_STATUS}</td>
                    <td>${item.REJECT_REASON}</td>
                    <td>${item.STATUS_DESC}</td>
                    <td>${item.ERROR_MSG}</td>
                </tr>
            </c:forEach>
        </tbody>
    </table>
</body>
</html>
```

---

### ğŸ“Œ ì›ë˜ ëª©ë¡(JSP)ì— ë²„íŠ¼ ì¶”ê°€

#### (`retryLogList.jsp` ì•ˆ)

```jsp
<td>
    <a href="${url}/admin/order/retryLogUserDetail?userId=${log.USER_ID}" class="btn btn-xs btn-info">
        ìƒì„¸ë³´ê¸°
    </a>
</td>
```

---

## âœ… ì™„ì„± íë¦„ ìš”ì•½

```
[ê´€ë¦¬ì ì¬ì‹œë„ ë¡œê·¸ ëª©ë¡]
     â†“
ì‚¬ìš©ì í´ë¦­ â†’ GET /retryLogUserDetail?userId=A114965
     â†“
TMP_ORDER_STATUSì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì‹¤íŒ¨ ê±´ ì¡°íšŒ
     â†“
JSP í…Œì´ë¸”ë¡œ ë Œë”ë§
```

---

## âœ… ì¶”ê°€ í™•ì¥ ê°€ëŠ¥ ê¸°ëŠ¥

| ê¸°ëŠ¥ | êµ¬í˜„ ë°©í–¥ |
|------|-----------|
| ğŸ“¥ ì‹¤íŒ¨ê±´ë§Œ ì¬ë‹¤ìš´ë¡œë“œ | `CSV ìƒì„±`í•˜ì—¬ í•´ë‹¹ ì‚¬ìš©ì ì‹¤íŒ¨ê±´ë§Œ ë‹¤ìš´ë¡œë“œ |
| ğŸ” í•´ë‹¹ ì‚¬ìš©ìë§Œ ì¬ì‹œë„ | ë²„íŠ¼ìœ¼ë¡œ `retryFailedOrders(userId)` í˜¸ì¶œ |
| âœ… ì„±ê³µ/ì‹¤íŒ¨ ì‹œ ìƒ‰ìƒ ì²˜ë¦¬ | `<td class="text-danger">` ë“±ìœ¼ë¡œ ê°•ì¡° |
| ğŸ—ƒï¸ í˜ì´ì§• | ì‹¤íŒ¨ ê±´ ìˆ˜ ë§ìœ¼ë©´ `PageHelper`, `LIMIT` ì²˜ë¦¬ |

---

ì´ì œ â€œì‹¤íŒ¨ ë‚´ì—­ í™•ì¸ â†’ ì„ íƒì  ì¬ì‹œë„ or ë‹¤ìš´ë¡œë“œâ€ ì „ ê³¼ì •ì´ ì™„ì„±ëì–´ ğŸ¯  
ì „ì²´ UI íë¦„ë„ ê·¸ë ¤ì¤„ ìˆ˜ë„ ìˆê³ , ê´€ë¦¬ì í™”ë©´ í†µí•© ë©”ë‰´ë„ ë§Œë“¤ ìˆ˜ ìˆì–´.  
í•„ìš”í•´?
