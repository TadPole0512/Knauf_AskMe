## 1. 요청 내용

> 아래의 내용을 단계별 작업으로 정리하여 작업의 흐름(프로세스)을 알 수 있게 정리해줘.

현재 고객에게 오더접수/보류오더 MMS전송을 E-Order와 같은 DB에서 활용하고 있습니다  
이 과정에서 SAP에서 알 수 없는 이유로 MMS DB에 여러 번의 문자 전송 데이터를 생성하고 있습니다  
SAP에 원인 검증 및 데이터 수정 요청을 해놓은 상태이나, 이것을 임시적으로 해결하기 위하여 중복 검증 옵션을 추가하려 합니다

먼저 MMS의 동작 Table은 하기와 같습니다  
1. SAP에서 오더 확정  
2. MMS_MSG Table에 오더 및 정보 전송  
3. 전송 완료 되면 STATUS 3으로 변경 한 뒤 MMS_LOG_YYYYMM Table로 이동

위의 과정에서 MMS_MSG Table의 새로운 Data가 생성될 때 Create Trigger를 생성 할 수 있는지 검토 요청 드립니다  
MMS_MSG Table에 새로운 데이터가 생성 되었을 때, MMS_MSG Table의 phone, msg 컬럼이 동일한 게 있다면, 이 경우에는 status값이 3으로 바뀌어서 저장해야 합니다.  
조건은 MMS_MSG Table에 새로운 데이터가 생성 되었을 때, MMS_LOG_YYYYMM Table의 phone, msg 컬럼이 동일한게 있다면 STATUS 3로 바로 변경 처리 입니다.  
(이 과정에서 MMS_LOG_YYYYMM Table은 이전 달의 테이블도 같이 체크 되어야 합니다 *6월 30일 오더의 경우 7월 1일이 되었을 때 반복 전송 될 수도 있음)

----


요청하신 내용을 바탕으로, 문제 해결을 위한 업무 프로세스를 단계별로 명확하게 정리했습니다.

### **현행 프로세스 및 문제점**

현재 SAP에서 확정된 주문 정보는 `MMS_MSG` 테이블로 전송되어 고객에게 MMS가 발송됩니다. 하지만 SAP 시스템의 오류로 인해 동일한 주문 건이 `MMS_MSG` 테이블에 중복으로 생성되면서, 고객에게 같은 내용의 MMS가 여러 번 발송되는 문제가 발생하고 있습니다.

***

### **개선을 위한 임시 해결 프로세스 (To-Be)**

이 문제를 임시로 해결하기 위해, `MMS_MSG` 테이블에 새로운 데이터가 생성될 때 중복 여부를 자동으로 검증하고 처리하는 프로세스를 추가합니다.

#### **1단계: 오더 확정 및 데이터 생성**
SAP에서 주문이 확정되면, 기존과 동일하게 `MMS_MSG` 테이블에 새로운 데이터(행)가 생성됩니다.

#### **2단계: 데이터베이스 트리거(Trigger) 자동 실행**
`MMS_MSG` 테이블에 새로운 데이터가 생성되는 시점(INSERT 이벤트)에 맞춰, 사전에 구현해 둔 **데이터베이스 트리거**가 자동으로 실행됩니다.

#### **3단계: 중복 데이터 검증**
실행된 트리거는 새로 생성된 데이터의 **`phone`**(수신자 번호)과 **`msg`**(메시지 내용) 컬럼 값을 기준으로 아래 두 가지 조건의 중복 여부를 순차적으로 검사합니다.

1.  **`MMS_MSG` 테이블 내부 검증:** 현재 처리 중인 `MMS_MSG` 테이블 내에, 새로 들어온 데이터와 동일한 `phone` 및 `msg` 값을 가진 데이터가 이미 있는지 확인합니다.
2.  **`MMS_LOG` 테이블 기록 검증:** 이미 발송 완료되어 로그로 쌓인 `MMS_LOG_YYYYMM` 테이블에 동일한 `phone` 및 `msg` 값을 가진 데이터가 있는지 확인합니다.
    * **핵심 조건:** 월이 바뀌는 시점의 데이터 누락을 방지하기 위해, **현재 월과 이전 월의 로그 테이블을 모두 조회**합니다. (예: 7월 1일에 검증 시 `MMS_LOG_...07`과 `MMS_LOG_...06` 테이블을 모두 확인)

#### **4단계: 중복 여부에 따른 상태(STATUS) 처리**
검증 결과에 따라 데이터의 `STATUS` 값을 결정합니다.

* **중복인 경우:** 3단계 검증 과정에서 동일한 데이터가 하나라도 발견되면, 새로 생성된 데이터의 `STATUS` 값을 MMS 발송이 필요 없는 **`3`**으로 즉시 변경하여 저장합니다. **(➡️ MMS 미발송 처리)**
* **중복이 아닌 경우:** 중복 데이터가 없다면, `STATUS` 값을 변경하지 않고 기존 발송 프로세스를 그대로 진행합니다.

#### **5단계: MMS 발송 및 로그 기록**
정상적으로 발송이 완료된 데이터는 기존과 동일하게 `STATUS`가 `3`으로 변경된 후, 해당 월의 `MMS_LOG_YYYYMM` 테이블로 이동되어 기록이 완료됩니다.

----

Claude-MMS 중복 전송 방지 트리거 설계안

MMS 중복 발송 방지를 위한 임시 해결 프로세스
SAP 시스템 오류로 인한 MMS 중복 발송 문제를 임시로 해결하기 위해, 데이터베이스 트리거(Trigger)를 활용한 자동 중복 검증 프로세스를 도입합니다. 전체 업무 흐름은 다음과 같습니다.

1단계: 주문 확정 및 데이터 생성 (SAP → DB)
프로세스: SAP 시스템에서 고객의 주문(오더)이 확정됩니다.

시스템 동작: 확정된 주문 정보(수신자 번호, 메시지 내용 등)가 MMS_MSG 테이블에 새로운 데이터(행)로 INSERT 됩니다.

2단계: 데이터 생성 감지 및 트리거 자동 실행
프로세스: MMS_MSG 테이블에 새로운 데이터가 생성되는 이벤트를 감지합니다.

시스템 동작: 사전에 MMS_MSG 테이블에 설정해 둔 CREATE 트리거가 자동으로 실행됩니다. 이 트리거는 새로 추가된 데이터의 중복 여부를 검증하는 역할을 합니다.

3단계: 중복 데이터 검증 (핵심 로직)
트리거는 새로 생성된 데이터의 phone(수신자 번호)과 msg(메시지 내용) 컬럼 값을 기준으로, 아래의 두 가지 조건을 순차적으로 검증합니다.

MMS_MSG 테이블 내 실시간 중복 검증

검증 대상: 현재 MMS 발송 대기 중인 MMS_MSG 테이블 전체

조건: 새로 추가된 데이터와 동일한 phone, msg 값을 가진 데이터가 이미 MMS_MSG 테이블에 존재하는지 확인합니다.

MMS_LOG 테이블 과거 발송 이력 검증

검증 대상: 과거 발송 완료 기록이 저장된 MMS_LOG_YYYYMM 테이블

조건: 새로 추가된 데이터와 동일한 phone, msg 값을 가진 데이터가 현재 월 또는 이전 월의 로그 테이블에 존재하는지 확인합니다.

※ 중요: 월말-월초에 걸친 중복 발송을 방지하기 위해, 반드시 현재 월과 직전 1개월, 총 2개의 로그 테이블을 조회해야 합니다. (예: 7월에 검증 시 MMS_LOG_202407과 MMS_LOG_202406을 모두 확인)

4단계: 검증 결과에 따른 상태(STATUS) 값 처리
중복으로 판단될 경우:

프로세스: 3단계 검증 과정에서 동일한 데이터가 하나라도 발견되면, 해당 건은 중복 발송으로 간주합니다.

시스템 동작: 트리거는 새로 생성된 데이터의 STATUS 값을 즉시 **3**으로 변경하여 저장합니다. 이 데이터는 MMS 발송 대상에서 제외됩니다.

정상 건으로 판단될 경우:

프로세스: 3단계 검증 과정에서 동일한 데이터가 발견되지 않으면, 정상적인 신규 발송 건으로 처리합니다.

시스템 동작: STATUS 값을 변경하지 않고, 기존 MMS 발송 프로세스를 그대로 진행합니다.

5단계: 최종 처리 (MMS 발송 또는 로그 이동)
정상 건: STATUS가 변경되지 않은 데이터는 MMS 발송 시스템에 의해 고객에게 정상적으로 발송됩니다. 발송이 완료되면 STATUS가 3으로 변경된 후, 해당 월의 MMS_LOG_YYYYMM 테이블로 데이터가 이동(보관)됩니다.

중복 건: STATUS가 3으로 즉시 변경된 데이터는 MMS 발송 절차를 건너뛰고, 바로 MMS_LOG_YYYYMM 테이블로 이동(보관)됩니다.